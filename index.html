<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PurrGo å–µä¾†é€Ÿï½œå“ç‰Œå®˜ç¶² Demo</title>

<!-- PWA / Iconsï¼ˆå¯ä¿ç•™ä½ åŸæª”ï¼‰ -->
<link rel="manifest" href="./manifest.webmanifest">
<link rel="icon" href="./logo/favicon.png">
<link rel="apple-touch-icon" sizes="192x192" href="./logo/logo-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="./logo/logo-512.png">
<meta name="theme-color" content="#ff7f50">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>


</head>
<body>

<header>
  <div class="container navbar">
    <div class="brand">
      <div class="brand-logo"><img src="./logo/logo-192.png" alt="logo"></div>
      <div>PurrGo å–µä¾†é€Ÿ</div>
    </div>

    <nav class="nav-links" id="desktopNav">
      <a data-go="home" class="active">é¦–é </a>
      <a data-go="products">ç”¢å“</a>
      <a data-go="guild">å…¬æœƒ</a>
      <a data-go="kiosk">æ“šé»</a>
      <a data-go="community">ç…§ç‰‡ç‰†</a>
      <a data-go="social">ç¤¾ç¾¤</a>
      <a data-go="chat">èŠå¤©</a>
      <a data-go="shorts">çŸ­å½±ç‰‡</a>
      <a data-go="about">ç†å¿µ</a>
      <a data-go="contact">è¯çµ¡</a>
    </nav>

    <button class="menu-toggle" id="menuBtn" aria-label="é–‹å•Ÿé¸å–®"><span class="menu-ico"><span></span></span></button>
  </div>

  <!-- Drawer -->
  <div class="menu-backdrop" id="menuBackdrop"></div>
  <nav class="menu" id="menu">
    <a href="#home"      data-go="home">é¦–é </a>
    <a href="#products"  data-go="products">ç”¢å“</a>
    <a href="#guild"     data-go="guild">å…¬æœƒ</a>
    <a href="#kiosk"     data-go="kiosk">æ“šé»</a>
    <a href="#community" data-go="community">ç…§ç‰‡ç‰†</a>
    <a href="#social"    data-go="social">ç¤¾ç¾¤</a>
    <a href="#chat"      data-go="chat">èŠå¤©</a>
    <a href="#shorts"    data-go="shorts">çŸ­å½±ç‰‡</a>
    <a href="#about"     data-go="about">ç†å¿µ</a>
    <a href="#contact"   data-go="contact">è¯çµ¡</a>
  </nav>
</header>

<main class="container">

  <!-- ========== Home ========== -->
  <section id="page-home" class="page active">
    <div class="section hero">
      <div>
        <span class="pill">PurrGo å–µä¾†é€Ÿ</span>
        <h1 class="nowrap">ä¾¿åˆ© Ã— å¯æ„› Ã— æ°¸çºŒ Ã— å…±å‰µ</h1>
        <p class="muted">ç”¨å‰µæ–°é…é€ + å…¬æœƒåˆ¶åº¦ï¼Œè®“è£œçµ¦æ›´è°æ˜ã€æ›´ä¾¿å®œã€æ›´å¥½ç©ã€‚æŠŠã€Œè²·è²“ç ‚ã€è®Šæˆæœ‰æˆå°±æ„Ÿçš„é‡Œç¨‹ç¢‘éŠæˆ²ã€‚</p>
        <div class="inline">
          <button class="btn" data-go="products">é–‹å§‹æ¢ç´¢ç”¢å“</button>
          <button class="btn secondary" data-go="guild">åŠ å…¥è²“å¥´å…¬æœƒ</button>
          <button class="btn ghost" data-go="about">äº†è§£å“ç‰Œç†å¿µ</button>
        </div>
      </div>
      <div class="hero-visual">
        <img class="hero-logo" src="./img/000/tofu-adult.jpg" alt="Hero artwork">
      </div>
    </div>

    <div class="section">
      <div class="section-head"><h2 class="nowrap">å»ºç«‹ä¸»å­è§’è‰²</h2><span class="badge">ä¸é™æ•¸é‡</span></div>
      <form id="catForm" class="grid g2">
        <label class="kv"><b>æš±ç¨±</b><input class="input" name="name" required></label>
        <label class="kv"><b>æ€§åˆ¥</b>
          <select class="input" name="sex">
            <option>å…¬</option><option>æ¯</option><option>æœªçŸ¥</option>
          </select>
        </label>
        <label class="kv"><b>ç”Ÿæ—¥</b><input class="input" name="birthday" type="date" required></label>
        <label class="kv"><b>å“ç¨®</b>
          <select class="input" name="breed" id="breedSel"><option value="">è®€å–ä¸­â€¦</option></select>
        </label>
        <label class="kv g2"><b>å¤§é ­ç…§</b><input class="input" name="avatar" type="file" accept="image/*"></label>
        <div class="inline"><button class="btn" type="submit">æ–°å¢ä¸»å­</button></div>
      </form>
      <div id="catStrip" class="cat-strip mt-1"></div>
    </div>
  </section>

  <!-- ========== Products ========== -->
  <section id="page-products" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Products</span><h2 class="nowrap">ç†±éŠ·èˆ‡æ–¹æ¡ˆ</h2></div></div>
      <p class="muted">æ©«å‘æ»‘å‹•å¡ç‰‡ï¼Œæ”¯æ´ç”¢å“ç…§ç‰‡ã€è©³æƒ…å½ˆçª—èˆ‡åŠ å…¥è³¼ç‰©è»Šã€‚</p>

      <div class="hwrap">
        <div id="productRow" class="hscroll"></div>
      </div>

      <div class="section mt-2">
        <h3 class="mt-0">è³¼ç‰©è»Šï¼ˆç¤ºç¯„ï¼‰</h3>
        <div id="cartList" class="muted">å°šç„¡å•†å“</div>
        <div class="inline mt-1">
          <button class="btn" id="checkoutBtn">çµå¸³ï¼ˆç¤ºç¯„ï¼‰</button>
          <button class="btn secondary" id="clearCartBtn">æ¸…ç©º</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== Guild ========== -->
  <section id="page-guild" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Guild</span><h2 class="nowrap">å…¬æœƒåˆ¶åº¦ï¼šä¸€èµ·æˆé•·ã€ä¸€èµ·æ›´çœ</h2></div></div>
      <p class="muted">å»ºç«‹é–€æª»ã€VIP ç­‰ç´šã€è²¢ç»æ¢ã€æ¯æ—¥ä»»å‹™â€¦ï¼ˆDemo ç‰ˆï¼‰</p>

      <div class="section">
        <h3 class="mt-0">åŠ å…¥ / ç¶å®š</h3>
        <div id="guildStatus" class="notice">å°šæœªåŠ å…¥å…¬æœƒ</div>
        <div class="inline mt-1">
          <input class="input" id="bindPhone" placeholder="è¼¸å…¥æ‰‹æ©Ÿï¼ˆç¤ºæ„ï¼‰" style="width:220px">
          <button class="btn" id="joinGuildBtn">åŠ å…¥å…¬æœƒ</button>
        </div>
      </div>

      <div class="section">
        <h3 class="mt-0">å…è²»è²“å’ªå¥æª¢ï¼ˆæ¯éš»ä¸»å­ä¸€å¹´ 1 æ¬¡ï¼‰</h3>
        <div class="kv">
          <b>åŸå¸‚</b>
          <select class="input" id="citySel"></select>
        </div>
        <div class="kv">
          <b>åˆä½œç¸é†«</b>
          <select class="input" id="hospitalSel"></select>
        </div>
        <div id="reportArea" class="grid g2 mt-1"></div>
      </div>
    </div>
  </section>

  <!-- ========== Kiosk ========== -->
  <section id="page-kiosk" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Kiosk</span><h2 class="nowrap">è²©è³£æ©Ÿé»ä½</h2></div></div>
      <div id="kioskMap" style="height:380px"></div>
      <p class="muted">é»æ¨™è¨˜å¯é–‹å•Ÿ Google/Apple Maps å°èˆªã€‚</p>
    </div>
  </section>

  <!-- ========== Community (Photo wall) ========== -->
  <section id="page-community" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Community</span><h2 class="nowrap">ç…§ç‰‡ç‰†</h2></div></div>
      <div class="inline">
        <input type="file" id="photoInput" accept="image/*" multiple>
        <label class="toggle"><input type="checkbox" id="photoPublic" checked> å…¬é–‹</label>
        <button class="btn secondary" id="clearWallBtn">æ¸…é™¤ï¼ˆæœ¬æ©Ÿï¼‰</button>
      </div>
      <div id="wall" class="wall mt-1"></div>
    </div>
  </section>

  <!-- ========== Social / Friends ========== -->
  <section id="page-social" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Social</span><h2 class="nowrap">ç¤¾ç¾¤ï¼ˆDemoï¼‰</h2></div></div>
      <div class="grid g2">
        <div class="section">
          <h3 class="mt-0">è¨»å†Š / ç™»å…¥ï¼ˆæœ¬æ©Ÿç¤ºç¯„ï¼‰</h3>
          <div class="inline">
            <input class="input" id="loginId" placeholder="è¨­å®šä½ çš„ç¤¾ç¾¤ ID" style="width:240px">
            <button class="btn" id="loginBtn">ç™»å…¥</button>
          </div>
          <div id="loginState" class="notice mt-1">ç›®å‰ç‚ºè¨ªå®¢æ¨¡å¼</div>
        </div>
        <div class="section">
          <h3 class="mt-0">æ–°å¢å¥½å‹</h3>
          <div class="inline">
            <input class="input" id="friendId" placeholder="è¼¸å…¥å°æ–¹ ID" style="width:240px">
            <button class="btn secondary" id="addFriendBtn">æ–°å¢</button>
          </div>
          <div id="friendList" class="mt-1 muted">å°šç„¡å¥½å‹</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== Chat ========== -->
  <section id="page-chat" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Chat</span><h2 class="nowrap">èŠå¤©ï¼ˆDemoï¼Œæœ¬æ©Ÿï¼‰</h2></div></div>
      <div class="grid g2">
        <div class="section">
          <h3 class="mt-0">é¸æ“‡å¥½å‹</h3>
          <div id="chatPeers" class="muted">è«‹å…ˆè‡³ã€Œç¤¾ç¾¤ã€æ–°å¢å¥½å‹</div>
        </div>
        <div class="section">
          <h3 class="mt-0">è¨Šæ¯</h3>
          <div id="chatThread" class="notice" style="height:220px;overflow:auto">å°šæœªé¸æ“‡å¥½å‹</div>
          <div class="inline mt-1">
            <input class="input" id="chatText" placeholder="è¼¸å…¥è¨Šæ¯">
            <button class="btn" id="sendMsgBtn">é€å‡º</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== Shorts ========== -->
  <section id="page-shorts" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Shorts</span><h2 class="nowrap">çŸ­å½±ç‰‡ï¼ˆDemoï¼‰</h2></div></div>
      <div class="inline">
        <input type="file" accept="video/*" id="shortInput" multiple>
        <span class="muted">å»ºè­° 30 ç§’å…§ï¼Œç¤ºç¯„åƒ…æ–¼æœ¬æ©Ÿç€è¦½ã€‚</span>
      </div>
      <div id="shortList" class="wall mt-1"></div>
    </div>
  </section>

  <!-- ========== About ========== -->
  <section id="page-about" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">About</span><h2 class="nowrap">æˆ‘å€‘çš„ç†å¿µ</h2></div></div>
      <p>ä¾¿åˆ© Ã— å¯æ„› Ã— æ°¸çºŒ Ã— å…±å‰µã€‚ç”¨ç§‘æŠ€èˆ‡ç¤¾ç¾¤ï¼ŒæŠŠæ—¥å¸¸è£œçµ¦è®Šæˆå¥½ç©åˆæœ‰æˆå°±çš„åƒèˆ‡ã€‚</p>
    </div>
  </section>

  <!-- ========== Contact ========== -->
  <section id="page-contact" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Contact</span><h2 class="nowrap">è¯çµ¡æˆ‘å€‘</h2></div></div>
      <form id="contactForm" class="grid g2">
        <label class="kv"><b>ç¨±å‘¼</b><input class="input" required></label>
        <label class="kv"><b>Email</b><input class="input" type="email" required></label>
        <label class="kv g2"><b>è¨Šæ¯</b><textarea class="input" required></textarea></label>
        <div class="inline"><button class="btn" type="submit">é€å‡º</button></div>
      </form>
      <p class="muted mt-1">ä¹Ÿå¯ä¾†ä¿¡ï¼š<a href="mailto:hello@purrgo.tw">hello@purrgo.tw</a></p>
    </div>
  </section>

</main>

<footer class="container footer">Â© PurrGo å–µä¾†é€Ÿ ï½œ å…¬é–‹ Demoï¼ˆä¸å«æŠ•è³‡äººè³‡è¨Šï¼‰</footer>

<!-- Product Modal -->
<div id="productModal" class="modal" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="inline" style="justify-content:space-between">
      <h3 id="pmTitle" class="mt-0">å•†å“è©³æƒ…</h3>
      <button class="btn secondary" id="pmClose">é—œé–‰</button>
    </div>
    <img id="pmImg" class="cover" src="" alt="" style="height:280px;margin-bottom:10px;object-fit:cover;border-radius:12px">
    <div id="pmBody" class="muted"></div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

<script>
/* =========================================================
   State & Helpers (LocalStorage Demo)
========================================================= */
const LS = {
  load:(k,def)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
  save:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};
const S = LS.load('purrgoState',{
  user:{ id:"guest-"+Math.random().toString(36).slice(2,7), guild:false },
  cats:[],
  products:[],
  cart:[],
  photos:[],   // {src, public, likes, comments:[]}
  friends:[],  // ids
  chats:{},    // { peerId: [ {from,text,time} ] }
  shorts:[]
});

/* Router */
const PAGES = ["home","products","guild","kiosk","community","social","chat","shorts","about","contact"];
function go(page){
  PAGES.forEach(p=>document.getElementById("page-"+p).classList.toggle("active", p===page));
  [...document.querySelectorAll('.nav-links a')].forEach(a=>a.classList.toggle('active', a.dataset.go===page));
  history.replaceState({}, "", "#"+page);
  // æ”¶èµ· drawer
  closeMenu();
  // lazy init
  if(page==="kiosk" && !window._mapInited) initMap();
}
function current(){ return (location.hash||"#home").replace("#","") }
function bindNav(){
  document.getElementById('desktopNav').addEventListener('click',e=>{
    if(e.target.dataset.go) go(e.target.dataset.go);
  });
  document.getElementById('menu').addEventListener('click',e=>{
    if(e.target.dataset.go){ go(e.target.dataset.go) }
  });
  document.querySelectorAll('[data-go]').forEach(b=>b.addEventListener('click',()=>go(b.dataset.go)));
}

/* Drawer */
const menu = document.getElementById('menu');
const backdrop = document.getElementById('menuBackdrop');
const menuBtn = document.getElementById('menuBtn');
function openMenu(){ menu.classList.add('open'); backdrop.classList.add('show'); document.body.classList.add('menu-open') }
function closeMenu(){ menu.classList.remove('open'); backdrop.classList.remove('show'); document.body.classList.remove('menu-open') }
menuBtn.addEventListener('click', openMenu);
backdrop.addEventListener('click', closeMenu);
window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeMenu() });

/* FAB */
document.body.insertAdjacentHTML('beforeend', `
  <div class="fab" id="fab">
    <button data-go="home">Top</button>
    <button data-go="products">Shop</button>
    <button data-go="guild">Guild</button>
    <button data-go="kiosk">Map</button>
    <button data-go="chat">Msg</button>
  </div>
`);
document.getElementById('fab').addEventListener('click', e=>{
  if(e.target.tagName==='BUTTON' && e.target.dataset.go) go(e.target.dataset.go)
});

/* ========== Home: breeds + cats ========== */
async function loadBreeds(){
  try{
    const res = await fetch('./data/breeds.json',{cache:'no-cache'});
    const list = await res.json();
    const sel = document.getElementById('breedSel'); sel.innerHTML='';
    list.forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; sel.appendChild(o) })
  }catch{ document.getElementById('breedSel').innerHTML='<option>å®¶è²“</option>' }
}
function ageFromBirthday(iso){
  const b = new Date(iso), now=new Date();
  let y=now.getFullYear()-b.getFullYear();
  let m=now.getMonth()-b.getMonth();
  if(m<0){ y--; m+=12 }
  return `${y} æ­² ${m} æœˆ`;
}
function renderCats(){
  const wrap = document.getElementById('catStrip'); wrap.innerHTML='';
  if(!S.cats.length) wrap.innerHTML='<div class="notice">å°šæœªå»ºç«‹ä¸»å­</div>';
  S.cats.forEach((c,i)=>{
    const el = document.createElement('div'); el.className='cat-card';
    el.innerHTML = `
      <img src="${c.avatar||'./logo/logo-192.png'}" alt="">
      <div>
        <div><b>${c.name}</b>ï½œ${c.breed||'å®¶è²“'}</div>
        <div class="muted">${c.sex}ï½œ${ageFromBirthday(c.birthday)}</div>
        <div class="inline mt-1">
          <button class="btn secondary" data-edit="${i}">ç·¨è¼¯</button>
          <button class="btn secondary" data-del="${i}">åˆªé™¤</button>
        </div>
      </div>`;
    wrap.appendChild(el);
  });
}
document.getElementById('catForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const obj = Object.fromEntries(fd.entries());
  if(fd.get('avatar')?.size){
    obj.avatar = await fileToDataURL(fd.get('avatar'));
  }
  S.cats.push(obj); LS.save('purrgoState',S); e.target.reset(); renderCats(); seedFirstAvatarToWall();
});
document.getElementById('catStrip').addEventListener('click', async e=>{
  const i = e.target.dataset.edit ?? e.target.dataset.del;
  if(i==null) return;
  if(e.target.dataset.del!=null){
    if(confirm('ç¢ºå®šåˆªé™¤æ­¤ä¸»å­ï¼Ÿ')){ S.cats.splice(Number(i),1); LS.save('purrgoState',S); renderCats(); renderReportArea(); }
    return;
  }
  // ç·¨è¼¯
  const c = S.cats[i];
  const name = prompt('ä¸»å­æš±ç¨±', c.name); if(name==null) return;
  const sex = prompt('æ€§åˆ¥ï¼ˆå…¬/æ¯/æœªçŸ¥ï¼‰', c.sex) ?? c.sex;
  const birthday = prompt('ç”Ÿæ—¥ï¼ˆYYYY-MM-DDï¼‰', c.birthday) ?? c.birthday;
  const breed = prompt('å“ç¨®', c.breed) ?? c.breed;
  S.cats[i] = {...c, name, sex, birthday, breed};
  LS.save('purrgoState',S); renderCats(); renderReportArea();
});
async function fileToDataURL(file){ return new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(file) })}

/* æŠŠç¬¬ä¸€å¼µä¸»å­é ­è²¼è‡ªå‹•å¸¶å…¥ç…§ç‰‡ç‰†ä¸€æ¬¡ï¼ˆè‹¥ç‰†ä¸Šé‚„æ²’æœ‰ï¼‰ */
function seedFirstAvatarToWall(){
  if(!S.photos.length && S.cats[0]?.avatar){
    S.photos.push({src:S.cats[0].avatar, public:true, likes:0, comments:[]});
    LS.save('purrgoState',S); renderWall();
  }
}

/* ========== Products ========== */
async function loadProducts(){
  try{
    const res = await fetch('./data/products.json',{cache:'no-cache'});
    S.products = await res.json();
  }catch{
    S.products = [
      {id:1, name:'å¹¼è²“å°ˆç”¨è±†è…ç ‚', spec:'2.5kg / ä½ç²‰å¡µ', price:220, bullets:['é«˜çº–ä½å¡µ','ç¬å¸çµåœ˜'], img:'./img/tofu-young.jpg', detail:'å¹¼è²“é…æ–¹ç¤ºæ„'},
      {id:2, name:'æˆè²“æ—¥å¸¸è±†è…ç ‚', spec:'2.5kg / å¼·æ•ˆé™¤è‡­', price:200, bullets:['æ´»æ€§ç‚­é™¤è‡­','çµåœ˜å¼·'], img:'./img/tofu-adult.jpg', detail:'æˆè²“é…æ–¹ç¤ºæ„'},
      {id:3, name:'ç†Ÿé½¡é—œç¯€è±†è…ç ‚', spec:'2.5kg / æº«å’Œ', price:240, bullets:['æŠ‘å‘³åŠ å¼·','æº«å’Œä¸åˆºæ¿€'], img:'./img/tofu-senior.jpg', detail:'ç†Ÿé½¡é…æ–¹ç¤ºæ„'},
    ];
  }
  renderProducts();
}
function renderProducts(){
  const row = document.getElementById('productRow'); row.innerHTML='';
  S.products.forEach(p=>{
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      <img class="cover" src="${p.img||'./img/000/tofu-adult.jpg'}" alt="">
      <h3 class="mt-1">${p.name}</h3>
      <div class="muted">${p.spec||''}</div>
      <div class="mt-1"><b>NT$ ${Number(p.price||0).toLocaleString()}</b></div>
      <ul style="margin:10px 0 0 18px">${(p.bullets||[]).map(b=>`<li>${b}</li>`).join('')}</ul>
      <div class="inline mt-1">
        <button class="btn" data-add="${p.id}">åŠ å…¥è³¼ç‰©è»Š</button>
        <button class="btn secondary" data-detail="${p.id}">æŸ¥çœ‹è©³æƒ…</button>
      </div>`;
    row.appendChild(el);
  });
}
document.getElementById('productRow').addEventListener('click', e=>{
  const id = e.target.dataset.add ?? e.target.dataset.detail;
  if(!id) return;
  const p = S.products.find(x=>x.id==id);
  if(e.target.dataset.add){
    S.cart.push({id:p.id, name:p.name, price:p.price}); LS.save('purrgoState',S); renderCart();
  }else{
    openProductModal(p);
  }
});
function renderCart(){
  const box=document.getElementById('cartList');
  if(!S.cart.length){ box.textContent='å°šç„¡å•†å“'; return }
  box.innerHTML = S.cart.map((c,i)=>`<div class="inline" style="justify-content:space-between;border-bottom:1px solid var(--line);padding:8px 0">
    <div>${c.name}</div><div>NT$ ${c.price}</div><button class="btn secondary" data-rm="${i}">ç§»é™¤</button></div>`).join('');
}
document.getElementById('cartList').addEventListener('click',e=>{
  if(e.target.dataset.rm){ S.cart.splice(Number(e.target.dataset.rm),1); LS.save('purrgoState',S); renderCart() }
});
document.getElementById('checkoutBtn').addEventListener('click',()=>alert('ç¤ºç¯„ï¼šé€å‡ºè¨‚å–®ï¼ˆæœªä¸²é‡‘æµï¼‰'));
document.getElementById('clearCartBtn').addEventListener('click',()=>{ S.cart=[]; LS.save('purrgoState',S); renderCart() });
function openProductModal(p){
  document.getElementById('pmTitle').textContent = p.name;
  document.getElementById('pmImg').src = p.img||'./img/000/tofu-adult.jpg';
  document.getElementById('pmBody').innerHTML = `
    <div class="muted">${p.spec||''}</div><hr class="sep">
    <div>å”®åƒ¹ï¼š<b>NT$ ${p.price}</b></div>
    <ul style="margin:10px 0 0 18px">${(p.bullets||[]).map(b=>`<li>${b}</li>`).join('')}</ul>`;
  document.getElementById('productModal').classList.add('show');
}
document.getElementById('pmClose').addEventListener('click',()=>document.getElementById('productModal').classList.remove('show'));
document.getElementById('productModal').addEventListener('click',e=>{ if(e.target.id==='productModal') e.currentTarget.classList.remove('show') });

/* ========== Guild / Hospitals / Reports ========== */
async function loadHospitals(){
  try{
    const res = await fetch('./data/hospitals.json',{cache:'no-cache'});
    const all = await res.json(); // {city:[{name,lat,lng}]}
    const citySel = document.getElementById('citySel');
    const hospSel = document.getElementById('hospitalSel');
    citySel.innerHTML = Object.keys(all).map(c=>`<option>${c}</option>`).join('');
    function fill(){ hospSel.innerHTML = (all[citySel.value]||[]).map(h=>`<option>${h.name}</option>`).join('') }
    citySel.onchange = fill; fill();
  }catch{
    document.getElementById('citySel').innerHTML='<option>å°åŒ—</option><option>å°ä¸­</option><option>é«˜é›„</option>';
    document.getElementById('hospitalSel').innerHTML='<option>ç¤ºç¯„å‹•ç‰©é†«é™¢</option>';
  }
}
function renderGuild(){
  document.getElementById('guildStatus').textContent = S.user.guild ? `å·²åŠ å…¥å…¬æœƒï¼ˆID: ${S.user.id}ï¼‰` : 'å°šæœªåŠ å…¥å…¬æœƒ';
}
document.getElementById('joinGuildBtn').addEventListener('click',()=>{
  if(!document.getElementById('bindPhone').value) return alert('è«‹è¼¸å…¥æ‰‹æ©Ÿï¼ˆç¤ºæ„ï¼‰');
  S.user.guild = true; LS.save('purrgoState',S); renderGuild(); renderReportArea();
});
function renderReportArea(){
  const area = document.getElementById('reportArea'); if(!area) return;
  area.innerHTML='';
  if(!S.user.guild){ area.innerHTML='<div class="notice">è«‹å…ˆåŠ å…¥å…¬æœƒå¾Œæ–¹å¯ä¸Šå‚³å¥æª¢å ±å‘Šã€‚</div>'; return }
  if(!S.cats.length){ area.innerHTML='<div class="notice">è«‹å…ˆåœ¨é¦–é å»ºç«‹ä¸»å­ã€‚</div>'; return }
  S.cats.forEach((c,idx)=>{
    const uploaded = c.report?.year === (new Date()).getFullYear();
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      <div class="inline" style="justify-content:space-between">
        <h4 class="mt-0">${c.name}ï½œ${ageFromBirthday(c.birthday)}</h4>
        <span class="badge">${uploaded?'å·²ä¸Šå‚³':''}</span>
      </div>
      <div class="muted">é …ç›®ï¼šè¡€æª¢</div>
      <div class="inline mt-1">
        <input type="file" accept="image/*,application/pdf" ${uploaded?'disabled':''} id="r${idx}">
        <button class="btn" ${uploaded?'disabled':''} data-report="${idx}">ä¸Šå‚³å ±å‘Š</button>
      </div>`;
    area.appendChild(el);
  });
}
document.getElementById('reportArea')?.addEventListener('click', async e=>{
  const i = e.target.dataset.report; if(i==null) return;
  const inp = document.getElementById('r'+i);
  if(!inp.files?.length) return alert('è«‹é¸æ“‡æª”æ¡ˆ');
  S.cats[i].report = { year:(new Date()).getFullYear(), time:Date.now() };
  LS.save('purrgoState',S); renderReportArea(); alert('ä¸Šå‚³å®Œæˆï¼å·²ç™»éŒ„å…¬æœƒè²¢ç»ï¼ˆç¤ºæ„ï¼‰');
});

/* ========== Kiosk Map ========== */
async function initMap(){
  window._mapInited = true;
  const map = L.map('kioskMap',{scrollWheelZoom:false}).setView([25.033,121.5654],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'Â© OpenStreetMap'}).addTo(map);
  try{
    const res = await fetch('./data/locations.json',{cache:'no-cache'});
    const pts = await res.json();
    pts.forEach(p=>{
      const m = L.marker([p.lat,p.lng]).addTo(map);
      const g = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
      const a = `https://maps.apple.com/?q=${p.lat},${p.lng}`;
      m.bindPopup(`<b>${p.name}</b><br>${p.address||''}<br><a target=_blank href="${g}">Google Maps</a> ï½œ <a target=_blank href="${a}">Apple Maps</a>`);
    })
  }catch{
    L.marker([25.033,121.5654]).addTo(map).bindPopup('ç¤ºç¯„ä½ç½®');
  }
}

/* ========== Photo Wall ========== */
function renderWall(){
  const wall=document.getElementById('wall'); if(!wall) return; wall.innerHTML='';
  S.photos.forEach((p,idx)=>{
    const el = document.createElement('div'); el.className='ph';
    el.innerHTML = `
      <img src="${p.src}" alt="">
      <div class="ph-bar">
        <div class="toggle"><input type="checkbox" ${p.public?'checked':''} data-pub="${idx}"><span>${p.public?'å…¬é–‹':'ç§äºº'}</span></div>
        <div class="ph-acts">
          <button data-like="${idx}">ğŸ¾ ${p.likes||0}</button>
          <button data-cmt="${idx}">ç•™è¨€</button>
          <button data-delphoto="${idx}">åˆªé™¤</button>
        </div>
      </div>
      <div style="padding:8px 10px"><div class="muted">${(p.comments||[]).map(c=>`<div>ğŸ’¬ ${c}</div>`).join('')}</div></div>`;
    wall.appendChild(el);
  });
}
document.getElementById('photoInput')?.addEventListener('change', async e=>{
  for(const f of e.target.files){
    const src = await fileToDataURL(f);
    S.photos.unshift({src, public:document.getElementById('photoPublic').checked, likes:0, comments:[]});
  }
  LS.save('purrgoState',S); renderWall();
});
document.getElementById('wall')?.addEventListener('click', e=>{
  if(e.target.dataset.like){ const i=e.target.dataset.like; S.photos[i].likes=(S.photos[i].likes||0)+1; LS.save('purrgoState',S); renderWall(); }
  if(e.target.dataset.cmt){ const i=e.target.dataset.cmt; const t=prompt('ç•™ä¸‹ä½ çš„ç•™è¨€'); if(t){ (S.photos[i].comments??=[]).push(t); LS.save('purrgoState',S); renderWall(); } }
  if(e.target.dataset.delphoto){ const i=e.target.dataset.delphoto; if(confirm('åˆªé™¤æ­¤ç…§ç‰‡ï¼Ÿ')){ S.photos.splice(i,1); LS.save('purrgoState',S); renderWall(); } }
});
document.getElementById('wall')?.addEventListener('change', e=>{
  if(e.target.dataset.pub){ const i=e.target.dataset.pub; S.photos[i].public = e.target.checked; LS.save('purrgoState',S); renderWall(); }
});
document.getElementById('clearWallBtn')?.addEventListener('click',()=>{ if(confirm('æ¸…é™¤æ‰€æœ‰ç…§ç‰‡ï¼ˆæœ¬æ©Ÿï¼‰ï¼Ÿ')){ S.photos=[]; LS.save('purrgoState',S); renderWall(); }});

/* ========== Social / Chat ========== */
function renderLogin(){ document.getElementById('loginState').textContent = S.user?.id ? `ç›®å‰ç™»å…¥ï¼š${S.user.id}` : 'ç›®å‰ç‚ºè¨ªå®¢æ¨¡å¼'; }
document.getElementById('loginBtn')?.addEventListener('click',()=>{
  const id = document.getElementById('loginId').value?.trim(); if(!id) return alert('è«‹è¼¸å…¥ ID');
  S.user.id = id; LS.save('purrgoState',S); renderLogin(); renderFriends();
});
document.getElementById('addFriendBtn')?.addEventListener('click',()=>{
  const id = document.getElementById('friendId').value?.trim(); if(!id) return;
  if(!S.friends.includes(id)) S.friends.push(id);
  LS.save('purrgoState',S); renderFriends(); renderPeers();
});
function renderFriends(){
  const box = document.getElementById('friendList'); if(!box) return;
  box.innerHTML = S.friends.length ? S.friends.map(i=>`<span class="badge">${i}</span>`).join(' ') : 'å°šç„¡å¥½å‹';
}
function renderPeers(){
  const box = document.getElementById('chatPeers'); if(!box) return;
  box.innerHTML = S.friends.length ? S.friends.map(i=>`<button class="btn secondary" data-peer="${i}">${i}</button>`).join(' ') : 'è«‹å…ˆè‡³ã€Œç¤¾ç¾¤ã€æ–°å¢å¥½å‹';
}
let CUR_PEER=null;
document.getElementById('chatPeers')?.addEventListener('click',e=>{
  if(e.target.dataset.peer){ CUR_PEER=e.target.dataset.peer; renderThread() }
});
function renderThread(){
  const box = document.getElementById('chatThread'); if(!box) return;
  const list = S.chats[CUR_PEER]||[]; box.innerHTML = list.map(m=>`<div style="margin:6px 0"><b>${m.from}ï¼š</b>${m.text}</div>`).join('') || 'å°šç„¡è¨Šæ¯';
}
document.getElementById('sendMsgBtn')?.addEventListener('click',()=>{
  if(!CUR_PEER) return alert('è«‹å…ˆé¸æ“‡å¥½å‹');
  const t = document.getElementById('chatText').value.trim(); if(!t) return;
  (S.chats[CUR_PEER]??=[]).push({from:S.user.id,text:t,time:Date.now()});
  LS.save('purrgoState',S); document.getElementById('chatText').value=''; renderThread();
});

/* ========== Shorts ========== */
document.getElementById('shortInput')?.addEventListener('change', async e=>{
  for(const f of e.target.files){
    const url = await fileToDataURL(f);
    S.shorts.unshift({src:url});
  }
  LS.save('purrgoState',S); renderShorts();
});
function renderShorts(){
  const wall=document.getElementById('shortList'); if(!wall) return; wall.innerHTML='';
  S.shorts.forEach(v=>{
    const el=document.createElement('div'); el.className='ph';
    el.innerHTML=`<video src="${v.src}" controls muted playsinline></video>`;
    wall.appendChild(el);
  });
}

/* =========================================================
   Boot
========================================================= */
function boot(){
  bindNav();
  go(PAGES.includes(current())? current() : 'home');
  loadBreeds(); renderCats(); seedFirstAvatarToWall();
  loadProducts(); renderCart();
  loadHospitals(); renderGuild(); renderReportArea();
  renderWall(); renderLogin(); renderFriends(); renderPeers(); renderShorts();
}
boot();

/* Service Workerï¼ˆå¯ç•™å¯åˆªï¼‰ */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}) }
</script>
</body>
</html>
