<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PurrGo å–µä¾†é€Ÿï½œå“ç‰Œå®˜ç¶² Demo</title>

  <!-- PWA / Icons -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./logo/favicon.png">
  <link rel="apple-touch-icon" sizes="192x192" href="./logo/logo-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="./logo/logo-512.png">
  <meta name="theme-color" content="#ff7f50">

  <!-- Styles -->
  <link rel="stylesheet" href="./style.css">

  <!-- Leaflet CSSï¼ˆåœ°åœ–ï¼‰ -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="anonymous">
</head>
<body>

<!-- Header -->
<header class="site-header">
  <div class="nav container">
    <!-- å“ç‰Œ -->
    <a class="brand" href="#home" onclick="scrollToHash('home')">
      <img class="logo" src="./logo/logo-192.png" alt="PurrGo Logo" />
      <span class="brand-name">PurrGo å–µä¾†é€Ÿ</span>
    </a>

    <!-- æ¡Œæ©Ÿï¼šæ°´å¹³åˆ†é  -->
    <nav class="tabs" aria-label="ä¸»é¸å–®ï¼ˆæ¡Œæ©Ÿï¼‰">
      <a class="tab" data-sec="home"     href="#home">é¦–é </a>
      <a class="tab" data-sec="products" href="#products">ç”¢å“</a>
      <a class="tab" data-sec="guild"    href="#guild">å…¬æœƒ</a>
      <a class="tab" data-sec="kiosk"    href="#kiosk">æ“šé»</a>
      <a class="tab" data-sec="community" href="#community">ç…§ç‰‡ç‰†</a>
      <a class="tab" data-sec="about"    href="#about">ç†å¿µ</a>
      <a class="tab" data-sec="contact"  href="#contact">è¯çµ¡</a>
    </nav>

    <!-- æ‰‹æ©Ÿï¼šæ¼¢å ¡æŒ‰éˆ• -->
    <button class="menu-toggle" aria-label="é–‹å•Ÿé¸å–®" title="é–‹å•Ÿé¸å–®">
      <span class="menu-ico" aria-hidden="true"></span>
    </button>

    <!-- æ‰‹æ©Ÿï¼šæŠ½å±œå¼é¸å–® -->
    <nav id="menu" class="menu" aria-label="ä¸»é¸å–®ï¼ˆæ‰‹æ©Ÿï¼‰">
      <a href="#home"       onclick="closeMenu()">é¦–é </a>
      <a href="#products"   onclick="closeMenu()">ç”¢å“</a>
      <a href="#guild"      onclick="closeMenu()">å…¬æœƒ</a>
      <a href="#kiosk"      onclick="closeMenu()">æ“šé»</a>
      <a href="#community"  onclick="closeMenu()">ç…§ç‰‡ç‰†</a>
      <a href="#about"      onclick="closeMenu()">ç†å¿µ</a>
      <a href="#contact"    onclick="closeMenu()">è¯çµ¡</a>
    </nav>
  </div>
</header>
  
<!-- æ‰‹æ©Ÿï¼šæ¼¢å ¡é¸å–®åŠé€æ˜é®ç½© -->
<div id="menuBackdrop" class="menu-backdrop" aria-hidden="true"></div>
  
<!-- Drawerï¼ˆæ‰‹æ©Ÿï¼‰ -->
<aside id="drawer" class="drawer" aria-hidden="true" role="dialog" aria-label="ä¸»é¸å–®">
  <div class="drawer-backdrop" onclick="toggleDrawer(false)"></div>
  <div class="drawer-panel">
    <button class="drawer-close" aria-label="é—œé–‰" onclick="toggleDrawer(false)">Ã—</button>
    <nav class="drawer-nav">
      <a href="#home"      onclick="route('home');toggleDrawer(false)">é¦–é </a>
      <a href="#products"  onclick="route('products');toggleDrawer(false)">ç”¢å“</a>
      <a href="#guild"     onclick="route('guild');toggleDrawer(false)">å…¬æœƒ</a>
      <a href="#kiosk"     onclick="route('kiosk');toggleDrawer(false)">æ“šé»</a>
      <a href="#community" onclick="route('community');toggleDrawer(false)">ç…§ç‰‡ç‰†</a>
      <a href="#about"     onclick="route('about');toggleDrawer(false)">ç†å¿µ</a>
      <a href="#contact"   onclick="route('contact');toggleDrawer(false)">è¯çµ¡</a>
    </nav>
  </div>
</aside>

<main class="container">

  <!-- ========== Pagesï¼ˆHash Routerï¼šåªé¡¯ç¤ºä¸€é ï¼‰ ========== -->

  <!-- Home -->
  <section id="page-home" class="page">
    <section class="band band-hero">
      <div class="hero card">
        <div class="hero-copy">
          <span class="pill">PurrGo å–µä¾†é€Ÿ</span>
          <h1 class="hero-title">ä¾¿åˆ© Ã— å¯æ„› Ã— æ°¸çºŒ Ã— å…±å‰µ</h1>
          <p class="muted">
            å‰µæ–°é…é€ + å…¬æœƒåˆ¶åº¦ï¼Œè®“è£œç ‚æ›´è°æ˜ã€æ›´ä¾¿å®œã€æ›´å¥½ç©ã€‚<br>
            æŠŠæ—¥å¸¸è£œçµ¦è®Šæˆä¸€èµ·å‡ç´šæ‹¿ç¦åˆ©çš„é‡Œç¨‹ç¢‘éŠæˆ²ã€‚
          </p>
          <div class="inline mt-1">
            <a class="btn"           href="#products" onclick="route('products')">é–‹å§‹æ¢ç´¢ç”¢å“</a>
            <a class="btn secondary" href="#guild"    onclick="route('guild')">åŠ å…¥è²“å¥´å…¬æœƒ</a>
            <button class="btn tertiary" onclick="openCharacter()">å»ºç«‹ä¸»å­è§’è‰²</button>
          </div>
        </div>
        <div class="hero-art">
          <div class="hero-visual">
            <img src="./logo/logo-512.png" alt="PurrGo Logo" class="hero-logo" />
          </div>
        </div>
      </div>
    </section>
  </section>

  <!-- Products -->
  <section id="page-products" class="page" hidden>
    <section class="band band-alt">
      <header class="section-head">
        <div>
          <span class="pill">Products</span>
          <h2>ç†±éŠ·èˆ‡æ–¹æ¡ˆ</h2>
          <p class="section-sub">æ©«å‘æ»‘å‹•å¡ç‰‡ï¼Œæ”¯æ´ç”¢å“ç…§ç‰‡ã€è©³æƒ…å½ˆçª—èˆ‡åŠ å…¥è³¼ç‰©è»Šã€‚</p>
        </div>
      </header>

      <!-- Horizontal carousel -->
      <div class="hwrap">
        <button class="hbtn prev" aria-label="ä¸Šä¸€é " onclick="hScroll('#productRow',-1)">â€¹</button>
        <div id="productRow" class="hscroll">
          <!-- å¡ç‰‡ç”± JS æ³¨å…¥ -->
        </div>
        <button class="hbtn next" aria-label="ä¸‹ä¸€é " onclick="hScroll('#productRow',1)">â€º</button>
      </div>

      <div class="divider"></div>

      <h3 class="mt-2">è³¼ç‰©è»Šï¼ˆç¤ºç¯„ï¼‰</h3>
      <div id="cartItems" class="muted">å°šç„¡å•†å“</div>
      <div class="inline mt-1">
        <button class="btn"           onclick="checkout()">çµå¸³ï¼ˆç¤ºç¯„ï¼‰</button>
        <button class="btn secondary" onclick="clearCart()">æ¸…ç©º</button>
      </div>
    </section>
  </section>

  <!-- Guild -->
  <section id="page-guild" class="page" hidden>
    <section class="band">
      <header class="section-head">
        <div>
          <span class="pill">Guild</span>
          <h2>å…¬æœƒåˆ¶åº¦ï¼šä¸€èµ·æˆé•·ã€ä¸€èµ·æ›´çœ</h2>
          <p class="section-sub">å‰µç«‹é–€æª»ã€VIP ç­‰ç´šã€è²¢ç»æ¢ã€ä»»å‹™å¡ç‰‡åŒ–å‘ˆç¾ã€‚</p>
        </div>
      </header>

      <!-- Guild status in cards (horizontal) -->
      <div class="hwrap">
        <button class="hbtn prev" aria-label="ä¸Šä¸€é " onclick="hScroll('#guildRow',-1)">â€¹</button>
        <div id="guildRow" class="hscroll">
          <div class="card gcard">
            <h3 class="mt-0">å‰µç«‹é–€æª»</h3>
            <p class="muted">æœƒé•·è³‡æ ¼ï¼šç´¯ç©æ¶ˆè²» â‰¥ <b>$1,200</b>ï¼ˆç¤ºç¯„ï¼‰ã€‚</p>
            <div class="inline">
              <input class="input" id="phoneInput" placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼">
              <button class="btn" onclick="bindPhone(document.getElementById('phoneInput').value)">ç¶å®šæ‰‹æ©Ÿï¼ˆç¤ºæ„ï¼‰</button>
            </div>
            <div id="identityInfo" class="muted mt-1">å°šæœªç¶å®šæ‰‹æ©Ÿ</div>
            <button id="lineBtn" class="btn secondary mt-1" onclick="toggleLine()">ç¶å®š LINEï¼ˆç¤ºæ„ï¼‰</button>
          </div>

          <div class="card gcard">
            <h3 class="mt-0">VIP ç­‰ç´š / ç°½åˆ°</h3>
            <div class="muted">ç´¯ç©æ¶ˆè²»ï¼š<b id="lifetimeSpend">$0</b> ï½œ ç­‰ç´šï¼š<b id="vipLevel">V0</b></div>
            <div class="progress mt-1"><div class="fill" id="vipBar" style="width:0%"></div></div>
            <div class="muted small">ä¸‹ä¸€ç´šé‚„éœ€ï¼š<b id="vipNext">$0</b></div>
            <button class="btn mt-1" onclick="dailyCheckin()">æ¯æ—¥ç°½åˆ° + ç¶“é©—</button>
            <div class="muted small mt-1" id="checkinInfo"></div>
          </div>

          <div class="card gcard">
            <h3 class="mt-0">æˆ‘çš„å…¬æœƒ</h3>
            <div class="muted">åç¨±ï¼š<b id="guildName">ï¼ˆå°šæœªå‰µç«‹ï¼‰</b> ï½œ ç­‰ç´šï¼š<b id="guildLevel">â€“</b></div>
            <div class="progress mt-1"><div class="fill" id="guildBar" style="width:0%"></div></div>
            <div class="muted small">è²¢ç»ï¼š<b id="guildContrib">0</b> / <span id="guildNeed">500</span></div>
            <div class="inline mt-1">
              <button class="btn"           onclick="createGuild()">å‰µç«‹å…¬æœƒ</button>
              <button class="btn secondary" onclick="contribute(50)">æ 50 è²¢ç»</button>
              <button class="btn secondary" onclick="mockWar()">æ¨¡æ“¬æˆ°ç¸¾</button>
            </div>
          </div>

          <div class="card gcard">
            <h3 class="mt-0">å…è²»å¥æª¢ç¦åˆ©</h3>
            <p class="muted">åŠ å…¥å…¬æœƒå¯äº« <b>1 å¹´ 1 æ¬¡</b> å…è²»è¡€æª¢ï¼ˆåˆä½œç¸é†«é™¢ï¼‰ã€‚</p>
            <div class="inline">
              <select id="vetCity" class="input" style="max-width:160px" onchange="renderHospitals()">
                <option value="å°åŒ—">å°åŒ—</option>
                <option value="å°ä¸­">å°ä¸­</option>
                <option value="é«˜é›„">é«˜é›„</option>
              </select>
              <button class="btn" onclick="bookFreeCheck()">é ç´„ï¼ˆç¤ºç¯„ï¼‰</button>
            </div>
            <div id="hospList" class="mt-1 small muted">è¼‰å…¥é†«é™¢ä¸­â€¦</div>
          </div>

          <div class="card gcard">
            <h3 class="mt-0">å¥æª¢å ±å‘Šç™»éŒ„</h3>
            <p class="muted">ä¸Šå‚³å®Œæˆå ±å‘Šï¼ˆPDF/JPGï¼‰ï¼Œå¯ç²å¾—å…¬æœƒè²¢ç» +100ï¼ˆç¤ºç¯„ï¼‰ã€‚</p>
            <input type="file" accept=".pdf,image/*" onchange="uploadReport(event)">
            <div id="reportInfo" class="small muted mt-1">å°šæœªä¸Šå‚³</div>
          </div>
        </div>
        <button class="hbtn next" aria-label="ä¸‹ä¸€é " onclick="hScroll('#guildRow',1)">â€º</button>
      </div>

      <details class="accordion mt-2">
        <summary>å±•é–‹ï¼šå€åŸŸæˆ°æ’è¡Œï¼ˆç¤ºç¯„ï¼‰</summary>
        <div class="card mt-2">
          <div class="table-wrap">
            <table class="table"><thead><tr><th>åæ¬¡</th><th>å…¬æœƒ</th><th>å€åŸŸ</th><th>åˆ†æ•¸</th></tr></thead>
              <tbody id="warTable">
                <tr><td>1</td><td>å°åŒ—æŠ“æŠ“éšŠ</td><td>å°åŒ—</td><td>12,340</td></tr>
                <tr><td>2</td><td>å°ä¸­æ¯›æ¯›è»</td><td>å°ä¸­</td><td>11,980</td></tr>
                <tr><td>3</td><td>é«˜é›„å–µå–µåœ˜</td><td>é«˜é›„</td><td>10,225</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </details>
    </section>
  </section>

  <!-- Kiosk -->
  <section id="page-kiosk" class="page" hidden>
    <section class="band">
      <header class="section-head">
        <div>
          <span class="pill">Kiosk</span>
          <h2>è²©è³£æ©Ÿæ“šé»</h2>
          <p class="section-sub">é»æ¨™è¨˜å¯é–‹å•Ÿ Google / Apple Maps å°èˆªã€‚</p>
        </div>
      </header>
      <div class="card">
        <div id="map" style="height:420px;border-radius:12px;overflow:hidden"></div>
      </div>
    </section>
  </section>

  <!-- Community -->
  <section id="page-community" class="page" hidden>
    <section class="band band-alt">
      <header class="section-head">
        <div>
          <span class="pill">Community</span>
          <h2>ç…§ç‰‡ç‰†ï¼ˆæœ¬æ©Ÿç¤ºç¯„ï¼‰</h2>
          <p class="section-sub">ä¸Šå‚³ä¸æœƒé›¢é–‹ä½ çš„è£ç½®ï¼Œåƒ…ä½œç‚ºä»‹é¢å±•ç¤ºã€‚</p>
        </div>
        <button class="btn" onclick="openCharacter()">å»ºç«‹ä¸»å­è§’è‰²</button>
      </header>

      <div class="card">
        <details class="accordion open">
          <summary>ä¸Šå‚³èˆ‡ç®¡ç†</summary>
          <div class="inline mt-1">
            <input type="file" accept="image/*" onchange="addPhoto(event)">
            <button class="btn secondary" onclick="clearWall()">æ¸…é™¤æ‰€æœ‰ç…§ç‰‡ï¼ˆæœ¬æ©Ÿï¼‰</button>
          </div>
        </details>
        <div id="wall" class="grid g-3 mt-2"></div>
      </div>
    </section>
  </section>

  <!-- About -->
  <section id="page-about" class="page" hidden>
    <section class="band">
      <header class="section-head">
        <div>
          <span class="pill">About</span>
          <h2>æˆ‘å€‘ç›¸ä¿¡ã€Œä¾¿åˆ© Ã— å¯æ„› Ã— æ°¸çºŒ Ã— å…±å‰µã€</h2>
        </div>
      </header>
      <div class="grid g-3">
        <div class="card mini"><h3 class="mt-0">ä¾¿åˆ©</h3><p class="muted">é è³¼/è¨‚é–± + åœ¨åœ°æ“šé»ï¼Œé™ä½è£œçµ¦ç„¦æ…®ã€‚</p></div>
        <div class="card mini"><h3 class="mt-0">å¯æ„›</h3><p class="muted">å…¬æœƒç©æ³•èˆ‡è§’è‰²é¤Šæˆï¼Œè®“è£œçµ¦æ›´æœ‰è¶£ã€‚</p></div>
        <div class="card mini"><h3 class="mt-0">æ°¸çºŒ / å…±å‰µ</h3><p class="muted">æ¸›å¡‘ã€é›†ä¸­é…é€ï¼Œèˆ‡ç¤¾ç¾¤ä¸€èµ·ç ”ç™¼ã€‚</p></div>
      </div>
    </section>
  </section>

  <!-- Contact -->
  <section id="page-contact" class="page" hidden>
    <section class="band band-alt">
      <header class="section-head">
        <div>
          <span class="pill">Contact</span>
          <h2>è¯çµ¡æˆ‘å€‘</h2>
        </div>
      </header>
      <div class="card">
        <form class="grid g-2" onsubmit="return submitForm(event)">
          <div><label>æ‚¨çš„ç¨±å‘¼<input class="input" required></label></div>
          <div><label>Email<input type="email" class="input" required></label></div>
          <div class="gcol-2"><label>è¨Šæ¯<textarea class="input" required></textarea></label></div>
          <div class="inline"><button class="btn" type="submit">é€å‡º</button></div>
        </form>
        <p class="muted mt-1">ä¹Ÿå¯ä¾†ä¿¡ï¼š<a href="mailto:hello@purrgo.tw">hello@purrgo.tw</a> ï½œ LINE å®˜æ–¹ï¼š@purrgo</p>
      </div>
    </section>
  </section>

</main>

<footer class="container footer">
  Â© PurrGo å–µä¾†é€Ÿ ï½œ å…¬é–‹ Demo
</footer>

<!-- Product Detail Modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" onclick="closeModal()"></div>
  <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <button class="modal-close" aria-label="é—œé–‰" onclick="closeModal()">Ã—</button>
    <div id="modalContent">è¼‰å…¥ä¸­â€¦</div>
  </div>
</div>

<!-- Character Creator Modal -->
<div id="charModal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" onclick="closeChar()"></div>
  <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="charTitle">
    <button class="modal-close" aria-label="é—œé–‰" onclick="closeChar()">Ã—</button>
    <h2 id="charTitle" class="mt-0">å»ºç«‹ä¸»å­è§’è‰²</h2>
    <div class="grid g-2">
      <div class="card mini">
        <div class="inline">
          <div class="avatar"><img id="charAvatar" alt="ä¸»å­é ­åƒ"></div>
          <input type="file" accept="image/*" onchange="uploadAvatar(event)">
        </div>
        <label class="mt-1">ä¸»å­åç¨±<input id="charName" class="input" placeholder="è¼¸å…¥ä¸»å­åç¨±"></label>
        <label class="mt-1">å“ç¨®
          <select id="charBreed" class="input"></select>
        </label>
      </div>
      <div class="card mini">
        <div class="grid g-2">
          <label>åŠ›é‡<input id="statStr" type="range" min="1" max="10" value="5" oninput="renderStats()"></label>
          <label>æ•æ·<input id="statAgi" type="range" min="1" max="10" value="5" oninput="renderStats()"></label>
          <label>æ™ºåŠ›<input id="statInt" type="range" min="1" max="10" value="5" oninput="renderStats()"></label>
          <label>é­…åŠ›<input id="statCha" type="range" min="1" max="10" value="5" oninput="renderStats()"></label>
        </div>
        <div class="muted small mt-1" id="statsPreview">åŠ›é‡5ï½œæ•æ·5ï½œæ™ºåŠ›5ï½œé­…åŠ›5</div>
        <div class="divider"></div>
        <div class="grid g-2">
          <label>æ¯›è‰²
            <select id="optFur" class="input">
              <option>æ£•è™æ–‘</option><option>é»‘ç™½</option><option>æ©˜è²“</option><option>å¥¶æ²¹</option><option>ç´”ç™½</option>
            </select>
          </label>
          <label>çœ¼ç›
            <select id="optEye" class="input">
              <option>ç¥ç€</option><option>è—</option><option>ç¶ </option><option>é‡‘</option>
            </select>
          </label>
          <label>é…ä»¶
            <select id="optGear" class="input">
              <option>é …åœˆ</option><option>è´è¶çµ</option><option>æŠ«é¢¨</option><option>ç„¡</option>
            </select>
          </label>
          <label>è‡‰éƒ¨ç´‹è·¯
            <select id="optFace" class="input">
              <option>ä¸‰èŠ±</option><option>Tuxedo</option><option>é‡é»è‰²</option><option>ç„¡</option>
            </select>
          </label>
        </div>
      </div>
    </div>
    <div class="inline mt-1">
      <button class="btn" onclick="saveCharacter()">å„²å­˜è§’è‰²</button>
      <button class="btn secondary" onclick="closeChar()">å–æ¶ˆ</button>
    </div>
    <div id="charInfo" class="muted small mt-1"></div>
  </div>
</div>

<!-- Floating Quick Nav -->
<div class="fab" id="fab" aria-label="å¿«é€Ÿå°è¦½" role="navigation">
  <button class="fab-btn" aria-label="å›åˆ°é ‚ç«¯" title="å›åˆ°é ‚ç«¯" onclick="scrollToHash('home')">â†‘</button>
  <button class="fab-btn" aria-label="çœ‹ç”¢å“"  title="çœ‹ç”¢å“"  onclick="route('products')">ğŸ›’</button>
  <button class="fab-btn" aria-label="çœ‹å…¬æœƒ"  title="çœ‹å…¬æœƒ"  onclick="route('guild')">ğŸ˜º</button>
  <button class="fab-btn" aria-label="çœ‹æ“šé»"  title="çœ‹æ“šé»"  onclick="route('kiosk')">ğŸ“</button>
  <button class="fab-btn" aria-label="è¯çµ¡æˆ‘å€‘" title="è¯çµ¡æˆ‘å€‘" onclick="route('contact')">âœ‰</button>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin="anonymous"></script>

<!-- Main Script -->
<script>
/* ===== State ===== */
const LS_KEY = 'purrgoState';
const state = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
state.user  ||= { phone:'', line:false, vipXp:0, lifetimeSpend:0, energy:0, lastCheckin:'' };
state.guild ||= { name:'', level:0, contribution:0 };
state.cart  ||= [];
state.vet   ||= [];
state.wall  ||= [];
state.char  ||= null; // è§’è‰²
let PRODUCTS = [];
let BREEDS = [];
let HOSPITALS = {};

/* ===== Storage save + render ===== */
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state));
  renderIdentity(); renderVIP(); renderGuild(); renderCart(); renderWall(); renderVet(); }

/* ===== Drawerï¼ˆmobile menuï¼‰ ===== */
function toggleDrawer(open){
  const d = document.getElementById('drawer');
  const willOpen = (open===undefined)? d.getAttribute('aria-hidden')==='true' : open;
  d.setAttribute('aria-hidden', String(!willOpen));
  document.body.style.overflow = willOpen ? 'hidden' : '';
}

/* ===== Routerï¼ˆhash pagesï¼‰ ===== */
const PAGES = ['home','products','guild','kiosk','community','about','contact'];
function route(name){
  PAGES.forEach(p=>{
    const el = document.getElementById('page-'+p);
    if(el) el.hidden = (p!==name);
    const tab = document.querySelector('.tabs [data-sec="'+p+'"]');
    tab && tab.setAttribute('aria-current', p===name ? 'page' : 'false');
  });
  location.hash = '#'+name;
  window.scrollTo({top:0,behavior:'instant'});
  toggleDrawer(false);
}
function syncRoute(){ const h=(location.hash||'#home').slice(1); route(PAGES.includes(h)?h:'home'); }

/* ===== FAB ===== */
function initFab(){
  const fab = document.getElementById('fab'); if(!fab) return;
  const toggle = () => { if (window.scrollY > 240) fab.classList.remove('hidden'); else fab.classList.add('hidden'); };
  toggle(); addEventListener('scroll', toggle, { passive:true });
}

/* ===== Smooth scroll for sections in same page (home only) ===== */
function scrollToHash(id){
  const el = document.getElementById('page-'+id) || document.getElementById(id);
  if(!el) return;
  el.scrollIntoView({ behavior:'smooth', block:'start' });
  const isMobile = /Mobi|Android/i.test(navigator.userAgent);
  setTimeout(highlight, isMobile?300:200);
  if(isMobile){ const fab=document.getElementById('fab'); fab&&fab.classList.add('hidden'); setTimeout(()=>fab.classList.remove('hidden'), 1000); }
}

/* ===== Nav Highlighterï¼ˆæ¡Œæ©Ÿ tabsï¼‰ ===== */
function highlight(){
  const h=(location.hash||'#home').slice(1);
  document.querySelectorAll('[data-sec]').forEach(a=>a.setAttribute('aria-current', a.dataset.sec===h ? 'page' : 'false'));
}

/* ===== Productsï¼ˆæ©«å‘å¡ï¼‰ ===== */
async function loadProducts(){
  try{
    const res = await fetch('./data/products.json',{cache:'no-cache'}); PRODUCTS = await res.json();
    const row = document.getElementById('productRow'); row.innerHTML='';
    PRODUCTS.forEach(p=>{
      const el = document.createElement('article'); el.className='product-card card';
      el.innerHTML = `
        <div class="product-img"><img src="${p.img||'./logo/logo-512.png'}" alt="${p.name}" onerror="this.src='./logo/logo-512.png'"></div>
        <div class="product-body">
          <h3 class="mt-0">${p.name}</h3>
          <div class="muted small">${p.spec||''}</div>
          <div class="mt-1 price">NT$ ${p.price.toLocaleString()}</div>
          <div class="inline mt-1">
            <button class="btn" onclick='addToCart(${JSON.stringify(p).replace(/\'/g,"&#39;")})'>åŠ å…¥è³¼ç‰©è»Š</button>
            <button class="btn secondary" onclick="openProduct('${p.id}')">æŸ¥çœ‹è©³æƒ…</button>
          </div>
        </div>`;
      row.appendChild(el);
    });
  }catch(e){ document.getElementById('productRow').innerHTML='<div class="empty">è®€å–ç”¢å“å¤±æ•—</div>'; }
}
function hScroll(sel, dir){
  const el = document.querySelector(sel); if(!el) return;
  const step = el.clientWidth * 0.9; el.scrollBy({left: step*dir, behavior:'smooth'});
}
function openProduct(id){
  const p = PRODUCTS.find(x=>x.id===id); if(!p) return;
  const box = document.getElementById('modalContent');
  box.innerHTML = `
    <div class="product-detail">
      <div class="pd-img"><img src="${p.img||'./logo/logo-512.png'}" alt="${p.name}" onerror="this.src='./logo/logo-512.png'"></div>
      <div class="pd-body">
        <h2 id="modalTitle" class="mt-0">${p.name}</h2>
        <div class="muted small">${p.spec||''}</div>
        <div class="price mt-1">NT$ ${p.price.toLocaleString()}</div>
        <ul class="list mt-1">${(p.bullets||[]).map(b=>`<li>${b}</li>`).join('')}</ul>
        <p class="muted mt-1">${p.desc||''}</p>
        <div class="inline mt-1">
          <button class="btn" onclick='addToCart(${JSON.stringify(p).replace(/\'/g,"&#39;")}); closeModal();'>åŠ å…¥è³¼ç‰©è»Š</button>
          <button class="btn secondary" onclick="closeModal()">é—œé–‰</button>
        </div>
      </div>
    </div>`;
  document.getElementById('modal').setAttribute('aria-hidden','false');
}
function closeModal(){ document.getElementById('modal').setAttribute('aria-hidden','true'); }
function addToCart(p){ const item = state.cart.find(i=>i.id===p.id) || (state.cart.push({...p,qty:0}), state.cart.find(i=>i.id===p.id)); item.qty++; save(); }
function clearCart(){ state.cart=[]; save(); }
function renderCart(){
  const box=document.getElementById('cartItems'); if(!box) return;
  if(state.cart.length===0){ box.textContent='å°šç„¡å•†å“'; return; }
  let sum=0; box.innerHTML = state.cart.map(i=>{ sum+=i.price*i.qty; return `${i.name} Ã— ${i.qty} = NT$ ${(i.price*i.qty).toLocaleString()}`; }).join('<br>');
  box.innerHTML += `<div class="mt-1"><b>å°è¨ˆï¼šNT$ ${sum.toLocaleString()}</b></div>`;
}
function checkout(){
  if(state.cart.length===0) return alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
  const sum = state.cart.reduce((a,b)=>a+b.price*b.qty,0);
  state.user.lifetimeSpend = (state.user.lifetimeSpend||0) + sum;
  state.user.vipXp += Math.round(sum/10);
  state.user.energy += Math.round(sum/20);
  state.cart=[]; alert(`çµå¸³æˆåŠŸï¼ç´¯ç©æ¶ˆè²» +$${sum.toLocaleString()}ï¼ˆç¤ºç¯„ï¼‰`); save();
}

/* ===== Guild ===== */
const GUILD_CREATE_NEED = 1200;
function renderGuild(){
  const need = (state.guild.level||1)*500;
  const now  = state.guild.contribution|0;
  const pct  = Math.max(0, Math.min(100, (now/need)*100));
  const $ = id => document.getElementById(id);
  $('guildName') && ($('guildName').textContent = state.guild.name||'ï¼ˆå°šæœªå‰µç«‹ï¼‰');
  $('guildLevel')&& ($('guildLevel').textContent = state.guild.level||'â€“');
  $('guildContrib')&& ($('guildContrib').textContent = now);
  $('guildNeed') && ($('guildNeed').textContent = need);
  $('guildBar')  && ($('guildBar').style.width = pct+'%');
}
function createGuild(){
  if((state.user.lifetimeSpend||0) < GUILD_CREATE_NEED){ return alert('å°šæœªé”åˆ°å‰µç«‹é–€æª»ï¼šç´¯ç©æ¶ˆè²» $1,200'); }
  const name = prompt('è¼¸å…¥å…¬æœƒåç¨±'); if(!name) return;
  state.guild.name=name; state.guild.level=1; state.guild.contribution = 0; save(); alert('å…¬æœƒå·²å‰µç«‹ï¼');
}
function contribute(n){ if(!state.guild.name) return alert('è«‹å…ˆå‰µç«‹å…¬æœƒ'); state.guild.contribution += n; if(state.guild.contribution >= (state.guild.level*500)) { state.guild.level++; state.guild.contribution=0; alert('å…¬æœƒå‡ç´šï¼'); } save(); }
function mockWar(){ if(!state.guild.name) return alert('å…ˆå‰µç«‹å…¬æœƒ'); const add=Math.floor(Math.random()*500+100); const tr=document.createElement('tr'); tr.innerHTML=`<td>*</td><td>${state.guild.name}</td><td>ä½ çš„å€åŸŸ</td><td>+${add}</td>`; document.getElementById('warTable').prepend(tr); }

/* ===== Free Vet Checkï¼ˆby cityï¼‰ ===== */
async function loadHospitals(){
  try{
    const res = await fetch('./data/hospitals.json',{cache:'no-cache'}); HOSPITALS = await res.json();
    renderHospitals();
  }catch(e){ document.getElementById('hospList').textContent='è®€å–é†«é™¢å¤±æ•—'; }
}
function renderHospitals(){
  const city = document.getElementById('vetCity')?.value||'å°åŒ—';
  const list = HOSPITALS[city]||[];
  const box = document.getElementById('hospList'); if(!box) return;
  if(!list.length){ box.textContent='æ­¤åœ°å€å°šç„¡åˆä½œé†«é™¢'; return; }
  box.innerHTML = list.map(h=>`ğŸ¥ ${h.name}ï½œ${h.addr}<br>`).join('');
}
function bookFreeCheck(){
  if(!state.guild.name) return alert('è«‹å…ˆåŠ å…¥æˆ–å‰µç«‹å…¬æœƒ');
  alert('å·²å»ºç«‹å…è²»è¡€æª¢é ç´„ï¼ˆç¤ºç¯„ï¼‰');
}

/* å ±å‘Šç™»éŒ„ */
function uploadReport(e){
  const f=e.target.files?.[0]; if(!f) return;
  document.getElementById('reportInfo').textContent = `å·²ä¸Šå‚³ï¼š${f.name}ï¼ˆç¤ºç¯„ï¼‰`;
  state.guild.contribution += 100; save(); alert('å ±å‘Šç™»éŒ„æˆåŠŸï¼Œå…¬æœƒè²¢ç» +100ï¼ˆç¤ºç¯„ï¼‰');
}

/* ===== Photos ===== */
function addPhoto(e){ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ state.wall.push(reader.result); save(); }; reader.readAsDataURL(file); }
function renderWall(){ const wall=document.getElementById('wall'); if(!wall) return; wall.innerHTML=''; (state.wall||[]).forEach(src=>{ const img=new Image(); img.src=src; img.className='wall-img'; wall.appendChild(img); }); }
function clearWall(){ if(confirm('æ¸…é™¤æ‰€æœ‰æœ¬æ©Ÿç…§ç‰‡ï¼Ÿ')){ state.wall=[]; save(); } }

/* ===== Map ===== */
async function initMap(){
  const el=document.getElementById('map'); if(!el) return;
  const map=L.map('map').setView([25.0330,121.5654],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(map);
  try{
    const res = await fetch('./data/locations.json',{cache:'no-cache'});
    const points = await res.json();
    points.forEach(p=>{
      const m=L.marker([p.lat,p.lng]).addTo(map);
      const gLink = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
      const aLink = `https://maps.apple.com/?q=${p.lat},${p.lng}`;
      m.bindPopup(`<b>${p.name}</b><br>${p.address||''}<br><a href='${gLink}' target='_blank'>Google Maps</a> ï½œ <a href='${aLink}' target='_blank'>Apple Maps</a>`);
    });
  }catch(e){}
}

/* ===== Contact ===== */
function submitForm(e){ e.preventDefault(); alert('å·²æ”¶åˆ°æ‚¨çš„è¨Šæ¯ï¼ˆç¤ºç¯„ï¼‰'); e.target.reset(); return false; }

/* ===== Identity / VIP ===== */
function bindPhone(v){ state.user.phone=v||''; save(); }
function toggleLine(){ state.user.line=!state.user.line; save(); }
function renderIdentity(){
  const el = document.getElementById('identityInfo'); if(!el) return;
  el.textContent = state.user.phone ? `å·²ç¶å®šï¼š${state.user.phone} ï½œ LINEï¼š${state.user.line?'å·²é€£çµ':'æœªé€£çµ'}` : 'å°šæœªç¶å®šæ‰‹æ©Ÿ';
  const btn = document.getElementById('lineBtn'); if(btn) btn.textContent = state.user.line? 'å–æ¶ˆ LINE é€£çµï¼ˆç¤ºæ„ï¼‰':'ç¶å®š LINEï¼ˆç¤ºæ„ï¼‰';
}
function vipLevelByXp(x){ if(x>=5000) return 5; if(x>=3000) return 4; if(x>=1500) return 3; if(x>=600) return 2; if(x>=200) return 1; return 0; }
function nextVipNeed(x){ const br=[200,600,1500,3000,5000]; for(const b of br){ if(x<b) return b-x; } return 0; }
function renderVIP(){
  const xp = state.user.vipXp|0;
  const spend = (state.user.lifetimeSpend||0);
  const next = nextVipNeed(xp);
  const pct = Math.min(100, (xp/5000)*100);
  const $ = id => document.getElementById(id);
  $('lifetimeSpend') && ($('lifetimeSpend').textContent = `$${spend.toLocaleString()}`);
  $('vipLevel')      && ($('vipLevel').textContent = 'V'+vipLevelByXp(xp));
  $('vipNext')       && ($('vipNext').textContent  = next>0? `$${next.toLocaleString()}`:'å·²é”é ‚ç´š');
  $('vipBar')        && ($('vipBar').style.width = pct+'%');
}
function dailyCheckin(){
  const today = new Date().toISOString().slice(0,10);
  if(state.user.lastCheckin===today){ const c=document.getElementById('checkinInfo'); if(c) c.textContent='ä»Šå¤©å·²ç°½åˆ°'; return; }
  state.user.lastCheckin=today; state.user.energy+=10; state.user.vipXp+=10;
  const c=document.getElementById('checkinInfo'); if(c) c.textContent='ç°½åˆ°æˆåŠŸï¼š+10 èƒ½é‡ã€+10 VIP XP'; save();
}

/* ===== Character Creator ===== */
async function loadBreeds(){
  try{ const res=await fetch('./data/breeds.json',{cache:'no-cache'}); BREEDS=await res.json();
    const sel=document.getElementById('charBreed'); if(sel){ sel.innerHTML = BREEDS.map(b=>`<option>${b}</option>`).join(''); }
  }catch(e){}
}
function openCharacter(){
  document.getElementById('charModal').setAttribute('aria-hidden','false');
  if(!BREEDS.length) loadBreeds();
  if(state.char){
    document.getElementById('charName').value = state.char.name||'';
    document.getElementById('charBreed').value = state.char.breed||'';
    document.getElementById('charAvatar').src = state.char.avatar||'';
    document.getElementById('optFur').value = state.char.fur||'æ£•è™æ–‘';
    document.getElementById('optEye').value = state.char.eye||'ç¥ç€';
    document.getElementById('optGear').value= state.char.gear||'é …åœˆ';
    document.getElementById('optFace').value= state.char.face||'ä¸‰èŠ±';
    ['Str','Agi','Int','Cha'].forEach(k=>document.getElementById('stat'+k).value = state.char['stat'+k]||5);
    renderStats();
  } else {
    document.getElementById('charAvatar').src = '';
    document.getElementById('charName').value = '';
    ['Str','Agi','Int','Cha'].forEach(k=>document.getElementById('stat'+k).value = 5);
    renderStats();
  }
}
function closeChar(){ document.getElementById('charModal').setAttribute('aria-hidden','true'); }
function uploadAvatar(e){ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ document.getElementById('charAvatar').src=r.result; }; r.readAsDataURL(f); }
function renderStats(){
  const str=+document.getElementById('statStr').value;
  const agi=+document.getElementById('statAgi').value;
  const int=+document.getElementById('statInt').value;
  const cha=+document.getElementById('statCha').value;
  document.getElementById('statsPreview').textContent = `åŠ›é‡${str}ï½œæ•æ·${agi}ï½œæ™ºåŠ›${int}ï½œé­…åŠ›${cha}`;
}
function saveCharacter(){
  const c = {
    name: document.getElementById('charName').value.trim(),
    breed: document.getElementById('charBreed').value,
    avatar: document.getElementById('charAvatar').src || '',
    fur: document.getElementById('optFur').value,
    eye: document.getElementById('optEye').value,
    gear: document.getElementById('optGear').value,
    face: document.getElementById('optFace').value,
    statStr:+document.getElementById('statStr').value,
    statAgi:+document.getElementById('statAgi').value,
    statInt:+document.getElementById('statInt').value,
    statCha:+document.getElementById('statCha').value
  };
  if(!c.name){ alert('è«‹è¼¸å…¥ä¸»å­åç¨±'); return; }
  state.char=c; save();
  document.getElementById('charInfo').textContent = `å·²å„²å­˜è§’è‰²ï¼š${c.name}ï¼ˆ${c.breed}ï¼‰`;
  alert('è§’è‰²å·²å„²å­˜åˆ°æœ¬æ©Ÿï¼ˆç¤ºç¯„ï¼‰');
}

/* ===== Vetï¼ˆä¸€èˆ¬é ç´„ä¿ç•™åŸæ¨£ï¼Œæ–¼å…¶ä»–é ï¼‰ ===== */
function bookVet(e){ e?.preventDefault?.(); return false; }
function renderVet(){ /* ç›®å‰ç§»è‡³å…¬æœƒç¦åˆ©ï¼Œé€™è£¡å¯ç•™ç™½æˆ–å»¶ä¼¸ */ }

/* ===== Boot ===== */
window.addEventListener('DOMContentLoaded', async () => {
  syncRoute(); highlight();
  await Promise.all([loadProducts(), loadHospitals(), loadBreeds()]);
  initMap(); renderWall(); renderVet(); initFab();
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
  save();
});
window.addEventListener('hashchange', syncRoute);
  // ===== æ¼¢å ¡é¸å–®æ§åˆ¶ =====
  const toggle = document.querySelector('.menu-toggle');
  const menu   = document.getElementById('menu');
  toggle?.addEventListener('click', () => {
    menu?.classList.toggle('active');
  });
  function closeMenu(){ menu?.classList.remove('active'); }

  // ===== é ç±¤é«˜äº®ï¼ˆæ²¿ç”¨ä½ åŸæœ¬çš„ highlightï¼Œå¦‚æ²’æœ‰å°±ç”¨åº•ä¸‹é€™å€‹ï¼‰ =====
  function highlight(){
    const hash=(location.hash||'#home').replace('#','');
    document.querySelectorAll('.tab').forEach(a=>{
      const sec = a.getAttribute('data-sec');
      a.setAttribute('aria-current', sec===hash ? 'page':'false');
      a.classList.toggle('active', sec===hash);
    });
  }
  window.addEventListener('hashchange', highlight);
  window.addEventListener('DOMContentLoaded', highlight);

  // ===== æ©«æ»‘å·¦å³æŒ‰éˆ•ï¼ˆè‹¥å·²å¯¦ä½œå¯ç•¥éï¼‰ =====
  function scrollRow(rowId, dir=1){
    const el = document.getElementById(rowId);
    if(!el) return;
    const card = el.querySelector(':scope > *');
    const step = card ? (card.clientWidth + 16) : 360;
    el.scrollBy({ left: step*dir, behavior:'smooth' });
  }
  /* ===== Hamburger menu control ===== */
const menu          = document.getElementById('menu');
const menuBackdrop  = document.getElementById('menuBackdrop');
const menuToggleBtn = document.querySelector('.menu-toggle');

function openMenu(){
  document.body.classList.add('menu-open');
  menu.classList.add('open');
  menuBackdrop.classList.add('show');
  menuToggleBtn?.setAttribute('aria-expanded','true');
}
function closeMenu(){
  document.body.classList.remove('menu-open');
  menu.classList.remove('open');
  menuBackdrop.classList.remove('show');
  menuToggleBtn?.setAttribute('aria-expanded','false');
}
function toggleMenu(){ menu.classList.contains('open') ? closeMenu() : openMenu(); }

/* ç¶å®šäº‹ä»¶ */
menuToggleBtn?.addEventListener('click', toggleMenu);
menuBackdrop?.addEventListener('click', closeMenu);
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });

/* é»é¸å–®é€£çµ â†’ å¹³æ»‘æ²å‹•ï¼‹é—œé–‰æŠ½å±œ */
document.querySelectorAll('#menu a').forEach(a=>{
  a.addEventListener('click', (e)=>{
    const hash = a.getAttribute('href')||'';
    if(hash.startsWith('#')){
      e.preventDefault();
      const id = hash.replace('#','');
      closeMenu();
      // è‹¥ä½ å·²ç¶“æœ‰ scrollToHashï¼Œæ²¿ç”¨ï¼›å¦å‰‡é€€å›é è¨­è¡Œç‚º
      if (typeof scrollToHash === 'function') scrollToHash(id);
      else document.getElementById(id)?.scrollIntoView({behavior:'smooth'});
    }
  });
});
</script>
</body>
</html>
