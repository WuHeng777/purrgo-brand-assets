<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PurrGo å–µä¾†é€Ÿï½œå“ç‰Œå®˜ç¶² Demo</title>

<!-- PWA / Icons -->
<link rel="manifest" href="./manifest.webmanifest">
<link rel="icon" href="./logo/favicon.png">
<link rel="apple-touch-icon" sizes="192x192" href="./logo/logo-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="./logo/logo-512.png">
<meta name="theme-color" content="#ff7f50">

<link rel="stylesheet" href="./style.css">


</head>
<body>

<header class="container">
  <div class="nav">
    <a class="brand" href="#home" onclick="showPage('home');return false;">
      <img src="./logo/logo-192.png" alt="PurrGo" style="width:28px;height:28px;border-radius:8px;object-fit:cover">
      <span>PurrGo å–µä¾†é€Ÿ</span>
    </a>

    <!-- å³ä¸Šï¼šè¨ªå®¢ / ç™»å‡º + æ¼¢å ¡ -->
    <div class="inline">
      <div id="authBadge" class="inline" style="gap:10px;padding:8px 12px;border:1px solid #2a2b2f;border-radius:999px">
        <b id="whoami">è¨ªå®¢</b><span class="muted">|</span>
        <a class="btn secondary" style="padding:8px 12px" onclick="openAuth()">ç™»å…¥</a>
      </div>
      <button class="menu-toggle hide-desktop" aria-label="é–‹å•Ÿé¸å–®" onclick="openMenu()">
        <span class="menu-ico" aria-hidden="true"></span>
      </button>
    </div>
  </div>

  <!-- æ‰‹æ©Ÿï¼šæŠ½å±œé¸å–®ï¼‹èƒŒæ™¯é®ç½© -->
  <nav id="menu" class="menu" aria-label="ä¸»é¸å–®">
    <a href="#home"     onclick="navTo('home')">é¦–é </a>
    <a href="#products" onclick="navTo('products')">ç”¢å“</a>
    <a href="#guild"    onclick="navTo('guild')">å…¬æœƒ</a>
    <a href="#kiosk"    onclick="navTo('kiosk')">æ“šé»</a>
    <a href="#photos"   onclick="navTo('photos')">ç…§ç‰‡ç‰†</a>
    <a href="#social"   onclick="navTo('social')">ç¤¾ç¾¤</a>
    <a href="#chat"     onclick="navTo('chat')">èŠå¤©</a>
    <a href="#video"    onclick="navTo('video')">çŸ­å½±ç‰‡</a>
    <a href="#about"    onclick="navTo('about')">ç†å¿µ</a>
    <a href="#contact"  onclick="navTo('contact')">è¯çµ¡</a>
  </nav>
  <div id="menuBackdrop" class="menu-backdrop" onclick="closeMenu()"></div>
</header>

<main class="container">

  <!-- ============ é¦–é  ============ -->
  <section id="page-home" class="page">
    <div class="section-caption">é¦–é </div>

    <section class="hero card">
      <div class="hero-copy">
        <span class="pill">PurrGo å–µä¾†é€Ÿ</span>
        <h1 class="hero-title">ä¾¿åˆ© Ã— å¯æ„› Ã— æ°¸çºŒ Ã— å…±å‰µ</h1>
        <p class="muted">
          ç”¨å‰µæ–°é…é€ï¼‹å…¬æœƒåˆ¶åº¦ï¼Œè®“è£œçµ¦æ›´è°æ˜ã€æ›´ä¾¿å®œã€æ›´å¥½ç©ã€‚æŠŠã€Œè²·è²“ç ‚ã€è®Šæˆæœ‰æˆå°±æ„Ÿçš„é‡Œç¨‹ç¢‘éŠæˆ²ã€‚
        </p>
        <div class="inline mt-1">
          <a class="btn" onclick="showPage('products')">é–‹å§‹æ¢ç´¢ç”¢å“</a>
          <a class="btn secondary" onclick="showPage('guild')">åŠ å…¥è²“å¥´å…¬æœƒ</a>
          <a class="btn secondary" onclick="showPage('about')">äº†è§£å“ç‰Œç†å¿µ</a>
        </div>
      </div>
      <div class="hero-visual">
        <!-- æ­£æ–¹å½¢å€’åœ“è§’ logo -->
        <img class="hero-logo" src="./logo/logo-512.png" alt="PurrGo Logo">
      </div>
    </section>

    <!-- å»ºç«‹ä¸»å­è§’è‰²ï¼ˆå¤šè²“ï¼‰ -->
    <section class="card mt-2">
      <span class="pill">ä¸»å­</span>
      <h2 class="mt-0">å»ºç«‹ä¸»å­è§’è‰²</h2>
      <form class="grid g-2" onsubmit="return addPet(event)">
        <div><label>æš±ç¨±<input class="input" name="name" required></label></div>
        <div><label>æ€§åˆ¥
          <select class="input" name="sex"><option value="M">å…¬</option><option value="F">æ¯</option></select>
        </label></div>
        <div class="gcol-2"><label>ç”Ÿæ—¥
          <input class="input" name="birthday" type="date" required>
        </label></div>
        <div><label>å“ç¨®<select class="input" id="breedSelect" name="breed"></select></label></div>
        <div class=""><label>å¤§é ­ç…§
          <input class="input" name="avatar" type="file" accept="image/*">
        </label></div>
        <div class="inline gcol-2"><button class="btn" type="submit">æ–°å¢ä¸»å­</button></div>
      </form>
      <div id="petRow" class="hscroll mt-2"></div>
    </section>
  </section>

  <!-- ============ ç”¢å“ ============ -->
  <section id="page-products" class="page" hidden>
    <div class="section-caption">Products</div>
    <section class="band">
      <header class="section-head"><div>
        <span class="pill">Products</span>
        <h2 class="mt-0">ç†±éŠ·èˆ‡æ–¹æ¡ˆ</h2>
        <p class="section-sub muted">æ©«å‘æ»‘å‹•å¡ç‰‡ï¼Œæ”¯æ´ç”¢å“ç…§ç‰‡ã€è©³æƒ…å½ˆçª—èˆ‡åŠ å…¥è³¼ç‰©è»Šã€‚</p>
      </div></header>

      <div class="hwrap">
        <button class="hbtn prev" aria-label="ä¸Šä¸€å€‹" onclick="scrollH('productRow',-1)">â€¹</button>
        <div id="productRow" class="hscroll"></div>
        <button class="hbtn next" aria-label="ä¸‹ä¸€å€‹" onclick="scrollH('productRow',1)">â€º</button>
      </div>

      <section class="card mt-2">
        <h3 class="mt-0">è³¼ç‰©è»Šï¼ˆç¤ºç¯„ï¼‰</h3>
        <div id="cartItems" class="muted">å°šç„¡å•†å“</div>
        <div class="inline mt-1">
          <button class="btn" onclick="checkout()">çµå¸³ï¼ˆç¤ºç¯„ï¼‰</button>
          <button class="btn secondary" onclick="clearCart()">æ¸…ç©º</button>
        </div>
      </section>
    </section>
  </section>

  <!-- ============ å…¬æœƒ / å¥æª¢ ============ -->
  <section id="page-guild" class="page" hidden>
    <div class="section-caption">Guild</div>
    <section class="band">
      <header class="section-head"><div>
        <span class="pill">Guild</span>
        <h2 class="mt-0">å…¬æœƒåˆ¶åº¦ï¼šä¸€èµ·æˆé•·ã€ä¸€èµ·æ›´çœ</h2>
        <p class="section-sub muted">å‰µç«‹é–€æª»ã€VIP ç­‰ç´šã€è²¢ç»æ¢ã€æ¯æ—¥ä»»å‹™â€¦</p>
      </div></header>

      <section class="card">
        <h3 class="mt-0">èº«ä»½ç¶å®š / VIP</h3>
        <div class="grid g-2">
          <div>
            <label>è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼<input class="input" id="phoneInput" placeholder="09xxxxxxxx"></label>
            <div class="inline mt-1">
              <button class="btn" onclick="bindPhone(document.getElementById('phoneInput').value)">ç¶å®šæ‰‹æ©Ÿï¼ˆç¤ºæ„ï¼‰</button>
              <button id="lineBtn" class="btn secondary" onclick="toggleLine()">ç¶å®š LINEï¼ˆç¤ºæ„ï¼‰</button>
            </div>
            <div id="identityInfo" class="muted mt-1"></div>
          </div>
          <div>
            <div>ç´¯ç©æ¶ˆè²»ï¼š<b id="lifetimeSpend">$0</b></div>
            <div class="mt-1">VIP ç­‰ç´šï¼š<b id="vipLevel">V0</b> ï½œ ä¸‹ä¸€ç´šé‚„å·®ï¼š<b id="vipNext">$0</b></div>
            <div class="inline mt-1">
              <button class="btn" onclick="dailyCheckin()">æ¯æ—¥ç°½åˆ° + èƒ½é‡ / XP</button>
              <span id="checkinInfo" class="muted"></span>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <h3 class="mt-0">å…è²»å¥æª¢ï¼ˆæ¯å¹´ 1 æ¬¡ / éœ€åŠ å…¥å…¬æœƒï¼‰</h3>
        <div class="grid g-3">
          <div>
            <label>é¸æ“‡ä¸»å­
              <select class="input" id="vetPet"></select>
            </label>
          </div>
          <div>
            <label>é¸æ“‡åŸå¸‚
              <select class="input" id="vetCity" onchange="renderHospitals()">
                <option>å°åŒ—</option><option>å°ä¸­</option><option>é«˜é›„</option>
              </select>
            </label>
          </div>
          <div>
            <label>åˆä½œé†«é™¢
              <select class="input" id="vetHospital"></select>
            </label>
          </div>
          <div class="gcol-2">
            <label>ä¸Šå‚³å¥æª¢å ±å‘Šï¼ˆåœ–ç‰‡ / PDFï¼‰
              <input class="input" id="vetFile" type="file" accept="image/*,.pdf">
            </label>
          </div>
          <div class="inline"><button class="btn" onclick="uploadVet()">é€å‡ºä¸¦ç²å–å…¬æœƒè²¢ç»</button></div>
        </div>
        <div id="vetList" class="muted mt-1">ç›®å‰ç„¡å¥æª¢ç´€éŒ„</div>
      </section>

      <section class="card">
        <div class="inline">
          <button class="btn" onclick="createGuild()">å‰µç«‹é–€æª»ï¼ˆç¤ºæ„ï¼‰</button>
          <button class="btn secondary" onclick="contribute(100)">è²¢ç» +100ï¼ˆç¤ºæ„ï¼‰</button>
          <button class="btn secondary" onclick="mockWar()">å±•é–‹ï¼šå€åŸŸæˆ°ï¼ˆç¤ºæ„ï¼‰</button>
        </div>
        <div class="mt-1">å…¬æœƒï¼š<b id="guildName">ï¼ˆå°šæœªå‰µç«‹ï¼‰</b> ï½œ ç­‰ç´šï¼š<b id="guildLevel">â€“</b> ï½œ è²¢ç»å€¼ï¼š<b id="guildContrib">0</b></div>
        <table class="table mt-2">
          <thead><tr><th>åæ¬¡</th><th>å…¬æœƒ</th><th>å€åŸŸ</th><th>åˆ†æ•¸</th></tr></thead>
          <tbody id="warTable"><tr><td>1</td><td>å°åŒ—æŠ“æŠ“éšŠ</td><td>å°åŒ—</td><td>12,340</td></tr></tbody>
        </table>
      </section>
    </section>
  </section>

  <!-- ============ æ“šé» / åœ°åœ– ============ -->
  <section id="page-kiosk" class="page" hidden>
    <div class="section-caption">Kiosk</div>
    <section class="card">
      <span class="pill">Kiosk</span>
      <h2 class="mt-0">è²©è³£æ©Ÿé»ä½</h2>
      <div id="map" style="height:360px;border-radius:12px;overflow:hidden"></div>
      <div class="muted mt-1">é»æ“Šæ¨™è¨˜å¯é–‹å•Ÿ Google/Apple Maps å°èˆªã€‚</div>
    </section>
  </section>

<!-- ============ ç…§ç‰‡ç‰† ============ -->
<section id="page-photos" class="page" hidden>
  <section class="card">
    <span class="pill">Photos</span>
    <h2 class="mt-0">ç…§ç‰‡ç‰†ï¼ˆä¾ä¸»å­åˆ†ç›¸ç°¿ï¼‰</h2>

    <div class="inline">
      <label>ä¸»å­
        <select class="input" id="photoPet" onchange="renderWall()"></select>
      </label>

      <!-- âœ… æ”¯æ´ä¸€æ¬¡å¤šé¸ -->
      <input id="photoInput" type="file" accept="image/*" multiple
             onchange="addPhoto(event)">
      <small class="muted" id="photoCount"></small>

      <button class="btn secondary" onclick="clearWall()">æ¸…é™¤æœ¬æ©Ÿç…§ç‰‡</button>
    </div>

    <!-- âœ… IG ä¸‰æ¬„æ–¹æ ¼ -->
    <div id="wall" class="wall-grid mt-2"></div>
  </section>
</section>

<!-- ç…§ç‰‡é è¦½ Modalï¼ˆIG é¢¨æ ¼ï¼‰ -->
<dialog id="photoModal">
  <article class="photo-modal">
    <header class="photo-modal-head">
      <div id="pmMeta" class="muted"></div>
      <button class="close" onclick="closePhoto()">Ã—</button>
    </header>

    <div class="photo-modal-body">
      <img id="pmImg" alt="">
      <aside class="photo-side">
        <div class="pm-actions">
          <button class="btn" id="pmLikeBtn" onclick="likeCurrent()">â™¥ <span id="pmLike">0</span></button>
          <button class="btn secondary" onclick="addCommentCurrent()">ç•™è¨€</button>
        </div>
        <div id="pmComments" class="pm-comments"></div>
        <div class="pm-outer">
    <img id="pmImg" alt="" class="pm-img">
    <div class="pm-bar">
      <div class="pm-l">
        <button class="btn" onclick="likeCurrent()">â™¥ <span id="pmLike">0</span></button>
        <button class="btn secondary" onclick="addCommentCurrent()">ç•™è¨€</button>
      </div>
      <div class="pm-r muted" id="pmMeta">ç›¸ç‰‡ 0 ï¼ å…± 0 å¼µ</div>
    </div>
    <div id="pmComments" class="pm-comments"></div>
    <button class="btn secondary pm-close" onclick="closePhoto()">é—œé–‰</button>
  </div>
      </aside>
    </div>
    <div class="auth-card">
    <h3 class="mt-0">ç·¨è¼¯ä¸»å­</h3>
    <form id="petForm" class="grid g-2" onsubmit="return savePet(event)">
      <input type="hidden" id="petId">
      <div><label>æš±ç¨±<input id="petName" class="input" required></label></div>
      <div><label>æ€§åˆ¥
        <select id="petSex" class="input">
          <option value="M">å…¬</option><option value="F">æ¯</option>
        </select></label></div>
      <div class="gcol-2"><label>ç”Ÿæ—¥
        <input id="petBirth" type="date" class="input">
      </label></div>
      <div class="gcol-2"><label>å“ç¨®
        <select id="petBreed" class="input"></select>
      </label></div>
      <div class="gcol-2"><label>æ›´æ›é ­åƒ
        <input id="petAvatar" type="file" accept="image/*" class="input">
      </label></div>
      <div class="inline">
        <button class="btn" type="submit">å„²å­˜</button>
        <button class="btn secondary" type="button" onclick="closePet()">å–æ¶ˆ</button>
        <button class="btn ghost" type="button" onclick="deletePet()">åˆªé™¤ä¸»å­</button>
      </div>
    </form>
  </div>
  </article>
</dialog>


  <!-- ============ ç¤¾ç¾¤ ============ -->
  <section id="page-social" class="page" hidden>
    <div class="section-caption">Social</div>
    <section class="card">
      <span class="pill">Social</span>
      <h2 class="mt-0">ç¤¾ç¾¤</h2>
      <div class="grid g-2">
        <div>
          <h3 class="mt-0">å¥½å‹</h3>
          <div class="inline">
            <input class="input" id="friendName" placeholder="è¼¸å…¥å¥½å‹æš±ç¨±">
            <button class="btn" onclick="addFriend()">æ–°å¢</button>
          </div>
          <ul id="friendList" class="list mt-1"></ul>
        </div>
        <div>
          <h3 class="mt-0">å°é–</h3>
          <ul id="blockList" class="list"></ul>
        </div>
      </div>
    </section>
  </section>

  <!-- ============ èŠå¤© ============ -->
  <section id="page-chat" class="page" hidden>
    <div class="section-caption">Chat</div>
    <section class="card">
      <span class="pill">Chat</span>
      <h2 class="mt-0">ç§è¨ŠèŠå¤©ï¼ˆç¤ºç¯„ï¼‰</h2>
      <div class="grid g-2">
        <div>
          <label>é¸æ“‡å¥½å‹
            <select class="input" id="chatWith" onchange="renderChat()"></select>
          </label>
          <div id="chatBox" class="chatbox mt-1"></div>
          <div class="inline mt-1">
            <input class="input" id="chatMsg" placeholder="è¼¸å…¥è¨Šæ¯â€¦">
            <button class="btn" onclick="sendMsg()">é€å‡º</button>
          </div>
        </div>
        <div class="muted">ç¤ºç¯„ç”¨é€”ï¼šæ‰€æœ‰å…§å®¹åƒ…å­˜æœ¬æ©Ÿï¼Œä¸æœƒä¸Šå‚³ã€‚</div>
      </div>
    </section>
  </section>

  <!-- ============ çŸ­å½±ç‰‡ ============ -->
  <section id="page-video" class="page" hidden>
    <div class="section-caption">Video</div>
    <section class="card">
      <span class="pill">Video</span>
      <h2 class="mt-0">çŸ­å½±ç‰‡ï¼ˆâ‰¤ 30 ç§’ï¼‰</h2>
      <div class="inline">
        <input type="file" accept="video/mp4" onchange="addVideo(event)">
      </div>
      <div id="videoGrid" class="grid g-3 mt-2"></div>
    </section>
  </section>

  <!-- ============ å“ç‰Œç†å¿µ ============ -->
  <section id="page-about" class="page" hidden>
    <div class="section-caption">About</div>
    <section class="card">
      <span class="pill">About</span>
      <h2 class="mt-0">æˆ‘å€‘ç›¸ä¿¡ã€Œä¾¿åˆ© Ã— å¯æ„› Ã— æ°¸çºŒ Ã— å…±å‰µã€</h2>
      <p class="muted">ç”¨ã€Œå‰µæ–°é…é€ã€çµåˆã€Œå…¬æœƒåŒ–ç¤¾ç¾¤ã€ï¼›æ°¸çºŒæ€ç¶­ï¼Œå’Œè²“å¥´å€‘ä¸€èµ·æŠŠæ—¥å¸¸æ¶ˆè€—å“è®Šæˆåƒèˆ‡å¼é‡Œç¨‹ç¢‘ã€‚</p>
    </section>
  </section>

  <!-- ============ è¯çµ¡æˆ‘å€‘ ============ -->
  <section id="page-contact" class="page" hidden>
    <div class="section-caption">Contact</div>
    <section class="card">
      <span class="pill">Contact</span>
      <h2 class="mt-0">è¯çµ¡æˆ‘å€‘</h2>
      <form class="grid g-2" onsubmit="return submitForm(event)">
        <div><label>æ‚¨çš„ç¨±å‘¼<input class="input" required></label></div>
        <div><label>Email<input type="email" class="input" required></label></div>
        <div class="gcol-2"><label>è¨Šæ¯<textarea class="input" required></textarea></label></div>
        <div class="inline"><button class="btn" type="submit">é€å‡º</button></div>
      </form>
      <p class="muted mt-1">ä¹Ÿå¯ä¾†ä¿¡ï¼š<a href="mailto:hello@purrgo.tw">hello@purrgo.tw</a></p>
    </section>
  </section>

</main>

<footer class="container" style="padding:26px 0 80px;color:var(--muted)">
  Â© PurrGo å–µä¾†é€Ÿ ï½œ å…¬é–‹ Demoï¼ˆä¸å«æŠ•è³‡äººè³‡è¨Šï¼‰
</footer>

<!-- å³ä¸‹ Topï¼ˆå–®é¡†ï¼‰ -->
<div class="fab" id="fab" aria-label="å›é ‚ç«¯">
  <button class="fab-btn" title="å›é ‚ç«¯" onclick="window.scrollTo({top:0,behavior:'smooth'})">Top</button>
</div>

<!-- ç”¢å“è©³æƒ… Modal -->
<dialog id="modal">
  <article class="auth-outer">
    <div class="auth-card">
      <header class="inline" style="justify-content:space-between">
        <h3 id="mTitle" class="mt-0">ç”¢å“è©³æƒ…</h3>
        <button class="btn secondary" onclick="closeModal()">é—œé–‰</button>
      </header>
      <div id="mBody"></div>
      <footer class="inline mt-1">
        <button class="btn" id="mAddBtn">åŠ å…¥è³¼ç‰©è»Š</button>
      </footer>
    </div>
  </article>
</dialog>

<!-- ç™»å…¥ / è¨»å†Š Modal -->
<dialog id="authDialog">
  <article class="auth-outer">
    <div class="auth-card">
      <h3 class="mt-0">è¨»å†Š / ç™»å…¥</h3>
      <div class="grid g-2">
        <div class="gcol-2"><label>è¨»å†Š ID<input id="regId" class="input" placeholder="ä½ çš„ç¤¾ç¾¤æš±ç¨± / ID"></label></div>
        <div class="gcol-2"><label>å¯†ç¢¼<input id="regPw" class="input" type="password" placeholder="è¨­å®šå¯†ç¢¼"></label></div>
        <div class="gcol-2"><label>æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰<input id="regPhone" class="input" placeholder="09xxxxxxxx"></label></div>
      </div>
      <div class="inline mt-1">
        <button class="btn" onclick="doRegister()">é–‹å§‹ä½¿ç”¨</button>
        <button class="btn secondary" onclick="closeAuth()">å–æ¶ˆ</button>
      </div>
      <div class="inline mt-1">
        <button class="btn secondary">ä½¿ç”¨ LINE ç™»å…¥ï¼ˆç¤ºæ„ï¼‰</button>
        <button class="btn secondary">ä½¿ç”¨ Facebook ç™»å…¥ï¼ˆç¤ºæ„ï¼‰</button>
      </div>
      <div class="inline mt-1">
        <button class="btn secondary">ä½¿ç”¨ Instagram ç™»å…¥ï¼ˆç¤ºæ„ï¼‰</button>
        <button class="btn secondary">ä½¿ç”¨ Gmail ç™»å…¥ï¼ˆç¤ºæ„ï¼‰</button>
      </div>
    </div>
  </article>
</dialog>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

<script>
/* ====== ç‹€æ…‹ ====== */
const LS_KEY='purrgoState';
const state=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
state.user ||= { id:'', phone:'', line:false, vipXp:0, lifetimeSpend:0, energy:0, lastCheckin:'' };
state.guild ||= { name:'', level:0, contribution:0 };
state.cart  ||= [];
state.pets  ||= [];             // {id,name,sex,birthday,ageText,breed,avatar}
state.vet   ||= [];
state.photos ||= {};
state.friends ||= [];
state.blocks  ||= [];
state.chats   ||= {};
state.videos  ||= [];
save();

function save(){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }catch(err){
    console.warn('Save failed (probably quota):', err);
    alert('ç…§ç‰‡å¤ªå¤§å°è‡´æš«å­˜ç©ºé–“ä¸è¶³ã€‚å·²ä¿ç•™å…¶ä»–è³‡æ–™ï¼Œä½†å»ºè­°æ”¹ç”¨è¼ƒå°çš„ç…§ç‰‡ï¼ˆæˆ–è®“ç³»çµ±è‡ªå‹•ç¸®åœ–ï¼‰ã€‚');
  }
  renderAll();
}

function calcAgeText(birthStr){
  if(!birthStr) return '';
  const bd = new Date(birthStr);
  if(isNaN(bd)) return '';
  const now = new Date();
  let y = now.getFullYear() - bd.getFullYear();
  let m = now.getMonth() - bd.getMonth();
  if (m < 0){ y--; m += 12; }
  return `${y}æ­²${m ? ` ${m}æœˆ` : ''}`;
}

/* ====== åˆ†é  ====== */
const pages=["home","products","guild","kiosk","photos","social","chat","video","about","contact"];
function showPage(sec){
  pages.forEach(id=>{
    const el=document.getElementById('page-'+id);
    if(el) el.hidden=(id!==sec);
    document.querySelectorAll('.tab[data-sec="'+id+'"]').forEach(a=>a.setAttribute('aria-current', id===sec? 'page':'false'));
  });
  closeMenu();
  location.hash='#'+sec;
  if(sec==='kiosk'){ setTimeout(initMap,60); }
  if(sec==='photos'){ renderWall(); }
  if(sec==='guild'){ renderVet(); }
  if(sec==='chat'){ renderChatSelectors(); renderChat(); }
}
function navTo(id){ closeMenu(); showPage(id); return false; }
function restorePage(){ const h=(location.hash||'#home').slice(1); showPage(pages.includes(h)?h:'home'); }

/* ====== æ‰‹æ©Ÿé¸å–® ====== */
function openMenu(){
  document.getElementById('menu').classList.add('open');
  document.getElementById('menuBackdrop').classList.add('show');
  document.body.classList.add('menu-open'); // â˜… æ–°å¢
}
function closeMenu(){
  document.getElementById('menu').classList.remove('open');
  document.getElementById('menuBackdrop').classList.remove('show');
  document.body.classList.remove('menu-open'); // â˜… æ–°å¢
}

/* ====== ç™»å…¥ / è¨»å†Š ====== */
function openAuth(){ document.getElementById('authDialog').showModal(); }
function closeAuth(){ document.getElementById('authDialog').close(); }
function doRegister(){
  const id=document.getElementById('regId').value.trim();
  const pw=document.getElementById('regPw').value.trim();
  const ph=document.getElementById('regPhone').value.trim();
  if(!id || !pw || !ph){ alert('è«‹å®Œæ•´å¡«å¯«ï¼ˆDemoï¼šä¸ç™¼é€ç°¡è¨Šé©—è­‰ï¼‰'); return; }
  state.user.id=id; state.user.phone=ph;
  save();
  closeAuth();
}
function renderAuthBadge(){
  const who=state.user.id? state.user.id : 'è¨ªå®¢';
  document.getElementById('whoami').textContent=who;
  const btn=document.querySelector('#authBadge .btn');
  if(state.user.id){
    btn.textContent='ç™»å‡º';
    btn.onclick=()=>{ if(confirm('è¦ç™»å‡ºå—ï¼Ÿ')){ state.user.id=''; save(); } };
  }else{
    btn.textContent='ç™»å…¥';
    btn.onclick=openAuth;
  }
}

/* ====== å…¬ç”¨ ====== */
function scrollH(id,dir){ const el=document.getElementById(id); if(!el) return; el.scrollBy({left:dir*(el.clientWidth*0.9),behavior:'smooth'}); }
function el(id){ return document.getElementById(id); }

/* ====== èº«ä»½ / VIP ====== */
function bindPhone(v){ state.user.phone=v||''; save(); }
function toggleLine(){ state.user.line=!state.user.line; save(); }
function vipLevelByXp(x){ if(x>=5000) return 5; if(x>=3000) return 4; if(x>=1500) return 3; if(x>=600) return 2; if(x>=200) return 1; return 0; }
function nextVipNeed(x){ const br=[200,600,1500,3000,5000]; for(const b of br){ if(x<b) return b-x; } return 0; }
function dailyCheckin(){
  const today=new Date().toISOString().slice(0,10);
  if(state.user.lastCheckin===today){ el('checkinInfo').textContent='ä»Šå¤©å·²ç°½åˆ°'; return; }
  state.user.lastCheckin=today; state.user.energy+=10; state.user.vipXp+=10;
  el('checkinInfo').textContent='ç°½åˆ°æˆåŠŸï¼š+10 èƒ½é‡ã€+10 VIP XP'; save();
}
function renderIdentity(){
  const u=state.user;
  el('identityInfo').textContent = u.phone? `å·²ç¶å®šï¼š${u.phone} ï½œ LINEï¼š${u.line?'å·²é€£çµ':'æœªé€£çµ'}` : 'å°šæœªç¶å®šæ‰‹æ©Ÿ';
  el('lineBtn').textContent = u.line? 'å–æ¶ˆ LINE é€£çµï¼ˆç¤ºæ„ï¼‰':'ç¶å®š LINEï¼ˆç¤ºæ„ï¼‰';
  el('lifetimeSpend').textContent = `$${(u.lifetimeSpend||0).toLocaleString()}`;
  el('vipLevel').textContent = 'V'+vipLevelByXp(u.vipXp|0);
  el('vipNext').textContent = nextVipNeed(u.vipXp|0)>0? `$${nextVipNeed(u.vipXp|0)}`:'å·²é”é ‚ç´š';
}

/* ====== ä¸»å­ï¼ˆç”Ÿæ—¥â†’å¹´é½¡ï¼‰ ====== */
function loadBreeds(){
  fetch('./data/breeds.json').then(r=>r.json()).then(list=>{
    const s=el('breedSelect'); s.innerHTML='';
    list.forEach(b=>{ const o=document.createElement('option'); o.textContent=b; o.value=b; s.appendChild(o); });
  }).catch(()=>{});
}
function ageFromBirthday(iso){
  if(!iso) return '0 æ­² 0 æœˆ';
  const b=new Date(iso); const n=new Date();
  let y=n.getFullYear()-b.getFullYear();
  let m=n.getMonth()-b.getMonth();
  let d=n.getDate()-b.getDate();
  if(d<0){ m--; }
  if(m<0){ y--; m+=12; }
  return `${y} æ­² ${m} æœˆ`;
}
// å°å·¥å…·ï¼šè®€æª”ä¸¦ç­‰æ¯”ç¸®åœ–ï¼ˆé è¨­æœ€é•·é‚Š 512pxã€JPEG å“è³ª 0.8ï¼‰
function readAndResize(file, max=512, quality=0.8){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    const img = new Image();
    reader.onload = e => {
      img.onload = () => {
        const scale = Math.min(max / img.width, max / img.height, 1);
        const cw = Math.round(img.width * scale);
        const ch = Math.round(img.height * scale);
        const canvas = document.createElement('canvas');
        canvas.width = cw; canvas.height = ch;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, cw, ch);
        // å°‡ç¸®åœ–è¼¸å‡ºç‚ºè¼ƒå°çš„ JPEG Base64
        try {
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          resolve(dataUrl);
        } catch (err) { reject(err); }
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// å–ä»£åŸæœ¬çš„ addPetï¼šå…ˆç¸®åœ–ï¼Œå†å­˜ stateï¼Œæœ€å¾Œ save()
unction addPet(e){
  e.preventDefault();
  const f = e.target;
  const p = {
    id: crypto.randomUUID(),
    name: f.name.value.trim(),
    sex: f.sex.value,
    // ä½ è‹¥ç”¨ç”Ÿæ—¥è¨ˆç®—å¹´é½¡ï¼Œå¯è‡ªè¡Œæ›¿æ›ï¼š
    age: Number(f.age?.value || 0),
    breed: f.breed.value,
    avatar: ''
  };

  const file = f.avatar.files[0];

  const finalize = ()=>{
    state.pets.push(p);
    if(p.avatar){
      (state.photos[p.id] = state.photos[p.id] || [])
        .unshift({ src:p.avatar, likes:0, comments:[] });
    }
    save();
    f.reset();
  };

  if(file){
    const rd = new FileReader();
    rd.onload = () => { p.avatar = rd.result; finalize(); };
    rd.readAsDataURL(file);
  }else{
    finalize();
  }
  return false;
}


  // å¦‚æœä½ å·²æŠŠã€Œå¹´é½¡ã€æ”¹æˆã€Œç”Ÿæ—¥ã€ï¼Œé€™è£¡è‡ªå‹•å¸¶å…¥æ­²æ•¸ï¼š
  const birthStr = f.birth ? f.birth.value : ''; // è‹¥ä»ç”¨ age æ¬„ä½å‰‡ç•™ç©ºå³å¯
  let age = 0;
  if (birthStr){
    const bd = new Date(birthStr);
    const now = new Date();
    age = Math.max(0, Math.floor((now - bd) / (365.25 * 24 * 60 * 60 * 1000)));
  } else if (f.age) {
    age = Number(f.age.value) || 0;
  }

  const pet = {
    id: crypto.randomUUID(),
    name: (f.name?.value || '').trim(),
    sex: f.sex?.value || 'M',
    birth: birthStr || '',
    age,
    breed: f.breed?.value || '',
    avatar: ''
  };

  const file = f.avatar?.files?.[0];
  if (file){
    try{
      // å…ˆç¸®åœ–å†å­˜ï¼Œé¿å…è¶…é localStorage é…é¡
      pet.avatar = await readAndResize(file, 512, 0.82);
    }catch(err){
      console.warn('resize failed:', err);
      alert('è®€å–æˆ–ç¸®åœ–å¤±æ•—ï¼Œå…ˆä»¥ç„¡é ­åƒæ–°å¢ï¼Œç¨å¾Œå¯å†ç·¨è¼¯ä¸Šå‚³è¼ƒå°çš„ç…§ç‰‡ã€‚');
    }
  }

  state.pets.push(pet);
  save();           // æœ‰ try/catchï¼Œä¸æœƒå› è¶…é¡è€Œæ•´å€‹å¤±æ•—
  f.reset();
  return false;
}

function renderPets(){
  const row = el('petRow'); if(!row) return;
  row.innerHTML='';
  state.pets.forEach(pt=>{
    const card=document.createElement('div');
    card.className='p-card';
    card.innerHTML = `
      <img src="${pt.avatar || './logo/logo-192.png'}" alt="" class="p-avatar">
      <div class="p-meta">
        <b>${pt.name || 'æœªå‘½å'}</b>ï½œ${pt.breed||'æœªçŸ¥'}ï½œ${pt.sex==='M'?'å…¬':'æ¯'}${(pt.age||pt.birth)?'ï½œ'+(pt.age?pt.age+'æ­²':''):''}
      </div>`;
    card.onclick = ()=>openPet(pt.id);   // âœ… é»æ•´å¼µå¡ç‰‡ç·¨è¼¯
    row.appendChild(card);
  });

  // åŒæ­¥ä¸‹æ‹‰
  ['vetPet','photoPet'].forEach(id=>{
    const s=el(id); if(!s) return; s.innerHTML='';
    state.pets.forEach(pt=>{
      const o=document.createElement('option'); o.value=pt.id; o.textContent=pt.name; s.appendChild(o);
    });
  });
}
  
/* ç·¨è¼¯ä¸»å­ */
let _editingPetId = null;

function openPet(id){
  const pt = state.pets.find(p=>p.id===id);
  if(!pt) return;

  _editingPetId = id;
  el('petId').value = id;
  el('petName').value = pt.name || '';
  el('petSex').value = pt.sex || 'M';
  el('petBirth').value = pt.birth || '';   // è‹¥ä½ æœ‰è¨˜ç”Ÿæ—¥å¯å¸¶å…¥
  // å“ç¨®ä¸‹æ‹‰æ²¿ç”¨ä½ ç¾æœ‰ breeds.json çš„å…§å®¹
  el('petBreed').innerHTML = el('breedSelect').innerHTML;
  el('petBreed').value = pt.breed || '';

  el('petModal').showModal();
}
function closePet(){ el('petModal').close(); _editingPetId=null; }

function savePet(e){
  e.preventDefault();
  const id = _editingPetId;
  const pt = state.pets.find(p=>p.id===id);
  if(!pt) return closePet();

  pt.name  = el('petName').value.trim();
  pt.sex   = el('petSex').value;
  pt.birth = el('petBirth').value || '';
  pt.breed = el('petBreed').value || pt.breed;

  const file = el('petAvatar').files[0];
  const done = ()=>{ save(); closePet(); el('petForm').reset(); };

  if(file){
    const rd = new FileReader();
    rd.onload = () => { pt.avatar = rd.result; done(); };
    rd.readAsDataURL(file);
  }else{
    done();
  }
  return false;
}

function deletePet(){
  if(!_editingPetId) return;
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½ä¸»å­å—ï¼Ÿï¼ˆç›¸ç°¿ä¹Ÿæœƒä¸€ä½µç§»é™¤ï¼‰')) return;
  const id = _editingPetId;
  state.pets = state.pets.filter(p=>p.id!==id);
  delete state.photos[id];
  save();
  closePet();
}

/* ====== å¥æª¢ ====== */
function renderHospitals(){
  const city=el('vetCity').value;
  fetch('./data/hospitals.json').then(r=>r.json()).then(list=>{
    const s=el('vetHospital'); s.innerHTML='';
    list.filter(h=>h.city===city).forEach(h=>{ const o=document.createElement('option'); o.textContent=h.name; o.value=h.name; s.appendChild(o); });
  }).catch(()=>{});
}
function uploadVet(){
  if(!state.user.id) return alert('è«‹å…ˆç™»å…¥');
  if(!state.pets.length) return alert('è«‹å…ˆå»ºç«‹ä¸»å­');
  if(!state.guild.name) return alert('è«‹å…ˆåŠ å…¥/å‰µç«‹å…¬æœƒ');
  const pid=el('vetPet').value, city=el('vetCity').value, hosp=el('vetHospital').value;
  const f=el('vetFile').files[0]; if(!f) return alert('è«‹é¸æ“‡æª”æ¡ˆ');
  state.vet.push({ petId:pid, city, hospital:hosp, fileName:f.name, time:new Date().toLocaleString() });
  state.guild.contribution+=200; save();
  alert('å·²ä¸Šå‚³ï¼ˆç¤ºç¯„ï¼‰ä¸¦ç²å¾— +200 å…¬æœƒè²¢ç»');
}
function renderVet(){
  renderHospitals();
  const box=el('vetList'); if(!state.vet.length){ box.textContent='ç›®å‰ç„¡å¥æª¢ç´€éŒ„'; return; }
  box.innerHTML = state.vet.map(v=>{
    const pet=state.pets.find(p=>p.id===v.petId);
    return `${v.time}ï½œ${v.city}ï½œ${v.hospital}ï½œ${pet?pet.name:'ï¼ˆå·²åˆªé™¤ï¼‰'}ï½œ${v.fileName}`;
  }).join('<br>');
}

/* ====== å…¬æœƒ ====== */
const GUILD_CREATE_NEED=1200;
function renderGuild(){ el('guildName').textContent=state.guild.name||'ï¼ˆå°šæœªå‰µç«‹ï¼‰'; el('guildLevel').textContent=state.guild.level||'â€“'; el('guildContrib').textContent=state.guild.contribution|0; }
function createGuild(){
  if((state.user.lifetimeSpend||0) < GUILD_CREATE_NEED) return alert('å°šæœªé”åˆ°å‰µç«‹é–€æª»ï¼šç´¯ç©æ¶ˆè²» $1,200');
  const name=prompt('è¼¸å…¥å…¬æœƒåç¨±'); if(!name) return;
  state.guild.name=name; state.guild.level=1; save(); alert('å…¬æœƒå·²å‰µç«‹ï¼');
}
function contribute(n){ if(!state.guild.name) return alert('è«‹å…ˆå‰µç«‹å…¬æœƒ'); state.guild.contribution+=n; if(state.guild.contribution>=(state.guild.level*500)){ state.guild.level++; alert('å…¬æœƒå‡ç´šï¼'); } save(); }
function mockWar(){ if(!state.guild.name) return alert('å…ˆå‰µç«‹å…¬æœƒ'); const add=Math.floor(Math.random()*500+100); const tr=document.createElement('tr'); tr.innerHTML=`<td>*</td><td>${state.guild.name}</td><td>ä½ çš„å€åŸŸ</td><td>+${add}</td>`; el('warTable').prepend(tr); }

/* ====== ç”¢å“ / è»Š ====== */
async function loadProducts(){
  try{
    const list=await (await fetch('./data/products.json',{cache:'no-cache'})).json();
    const row=el('productRow'); row.innerHTML='';
    list.forEach(p=>{
      const elc=document.createElement('div'); elc.className='card product';
      elc.innerHTML=`
        <img src="${p.img||'./logo/logo-512.png'}" class="prod-img" alt="">
        <h3 class="mt-0">${p.name}</h3>
        <div class="muted">è¦æ ¼ï¼š${p.spec||'-'}</div>
        <div class="mt-1"><b>NT$ ${p.price.toLocaleString()}</b></div>
        <div class="inline mt-1">
          <button class="btn" onclick='addToCart(${JSON.stringify(p).replace(/'/g,"&#39;")})'>åŠ å…¥è³¼ç‰©è»Š</button>
          <button class="btn secondary" onclick='openDetail(${JSON.stringify(p).replace(/'/g,"&#39;")})'>æŸ¥çœ‹è©³æƒ…</button>
        </div>`;
      row.appendChild(elc);
    });
  }catch(e){ el('productRow').innerHTML='<div class="empty">è®€å–ç”¢å“å¤±æ•—</div>'; }
}
function addToCart(p){ const item=state.cart.find(i=>i.id===p.id) || (state.cart.push({...p,qty:0}), state.cart.find(i=>i.id===p.id)); item.qty++; save(); }
function clearCart(){ state.cart=[]; save(); }
function renderCart(){
  const box=el('cartItems'); if(!box) return;
  if(state.cart.length===0){ box.textContent='å°šç„¡å•†å“'; return; }
  let sum=0; box.innerHTML=state.cart.map(i=>{ sum+=i.price*i.qty; return `${i.name} Ã— ${i.qty} = NT$ ${(i.price*i.qty).toLocaleString()}`; }).join('<br>');
  box.innerHTML+=`<div class="mt-1"><b>å°è¨ˆï¼šNT$ ${sum.toLocaleString()}</b></div>`;
}
function checkout(){
  if(state.cart.length===0) return alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
  const sum=state.cart.reduce((a,b)=>a+b.price*b.qty,0);
  state.user.lifetimeSpend=(state.user.lifetimeSpend||0)+sum;
  state.user.vipXp+=Math.round(sum/10);
  state.user.energy+=Math.round(sum/20);
  state.cart=[]; alert(`çµå¸³æˆåŠŸï¼ç´¯ç©æ¶ˆè²» +$${sum.toLocaleString()}ï¼ŒVIP XP èˆ‡èƒ½é‡å·²å¢åŠ `);
  save();
}
function openDetail(p){
  const m=el('modal'); el('mTitle').textContent=p.name;
  el('mBody').innerHTML=`<img src="${p.img||'./logo/logo-512.png'}" class="prod-img" style="max-height:240px"><p class="mt-1">${(p.bullets||[]).map(b=>`â€¢ ${b}`).join('<br>')}</p>`;
  el('mAddBtn').onclick=()=>{ addToCart(p); closeModal(); };
  m.showModal();
}
function closeModal(){ el('modal').close(); }

/* ===== ç…§ç‰‡ç‰†ï¼ˆIG é¢¨æ ¼ï¼‰ ===== */
let _pm = { pid:null, idx:-1 };

/* æ”¯æ´ä¸€æ¬¡å¤šé¸ä¸Šå‚³ */
function addPhoto(e){
  const pid = el('photoPet').value;
  if(!pid){ alert('è«‹å…ˆå»ºç«‹ä¸»å­'); return; }

  const files = Array.from(e.target.files || []);
  if(files.length === 0) return;
  el('photoCount').textContent = ${files.length}å¼µç…§ç‰‡;

  let left = files.length;
  files.forEach(file=>{
    const rd = new FileReader();
    rd.onload = () => {
      (state.photos[pid] = state.photos[pid] || [])
        .push({ src: rd.result, likes: 0, comments: [] });
      left--;
      if(left === 0){ save(); }
    };
    rd.readAsDataURL(file);
  });

  // è®“åŒæª”åä¹Ÿèƒ½å†æ¬¡è§¸ç™¼ change
  e.target.value = '';
}

/* ä¸‰æ¬„æ–¹æ ¼ç‰†ï¼ˆé»åœ–é–‹é è¦½ï¼‰ */
function renderWall(){
  const pid = el('photoPet').value  (state.pets[0]?.id  '');
  if(el('photoPet').value !== pid) el('photoPet').value = pid;

  const list = state.photos[pid] || [];
  const wall = el('wall'); wall.innerHTML = '';

  list.forEach((ph, idx)=>{
    const item = document.createElement('div');
    item.className = 'wall-item';
    item.innerHTML = `
      <img src="${ph.src}" alt="">
      <div class="wall-meta"><span>â™¥ ${ph.likes||0}</span><span>ğŸ’¬ ${ph.comments?.length||0}</span></div>
    `;
    item.onclick = () => openPhoto(pid, idx);
    wall.appendChild(item);
  });
}

/* é è¦½ / é—œé–‰ / æ„›å¿ƒ / ç•™è¨€ */
function openPhoto(pid, idx){
  _pm = { pid, idx };
  const ph = (state.photos[pid]||[])[idx];
  if(!ph) return;

  el('pmImg').src = ph.src;
  el('pmLike').textContent = ph.likes || 0;
  el('pmMeta').textContent = ç›¸ç‰‡ ${idx+1} ï¼ å…± ${state.photos[pid].length} å¼µ;
  renderPhotoComments(ph);

  el('photoModal').showModal();
}
function closePhoto(){
  el('photoModal').close();
  _pm = { pid:null, idx:-1 };
}
function likeCurrent(){
  if(!_pm.pid) return;
  const ph = state.photos[_pm.pid][_pm.idx];
  ph.likes = (ph.likes||0) + 1;
  el('pmLike').textContent = ph.likes;
  save();
}
function addCommentCurrent(){
  if(!_pm.pid) return;
  const t = prompt('ç•™è¨€å…§å®¹');
  if(!t) return;
  const ph = state.photos[_pm.pid][_pm.idx];
  (ph.comments = ph.comments || []).push({ text:t, time:new Date().toLocaleString() });
  renderPhotoComments(ph);
  save();
}
function renderPhotoComments(ph){
  const box = el('pmComments'); box.innerHTML = '';
  (ph.comments||[]).slice().reverse().forEach(c=>{
    const d = document.createElement('div');
    d.className = 'c';
    d.textContent = ${c.text} Â· ${c.time};
    box.appendChild(d);
  });
}

/* ä½ åŸæœ¬çš„ clearWall å¯ä»¥ä¿ç•™ */

function clearWall(){ const pid=el('photoPet').value; if(confirm('æ¸…é™¤æœ¬æ©Ÿç…§ç‰‡ï¼Ÿ')){ state.photos[pid]=[]; save(); }}

/* ====== ç¤¾ç¾¤ / èŠå¤© ====== */
function addFriend(){
  const n=el('friendName').value.trim(); if(!n) return;
  if(state.friends.includes(n)) return alert('å·²å­˜åœ¨');
  state.friends.push(n); save(); el('friendName').value='';
}
function removeFriend(n){ state.friends=state.friends.filter(x=>x!==n); delete state.chats[n]; save(); }
function blockFriend(n){ if(!state.blocks.includes(n)) state.blocks.push(n); save(); }
function unblock(n){ state.blocks=state.blocks.filter(x=>x!==n); save(); }
function renderSocial(){
  const fl=el('friendList'); fl.innerHTML='';
  state.friends.forEach(n=>{
    const li=document.createElement('li'); li.innerHTML=`${n} <button class="btn secondary" onclick="blockFriend('${n}')">å°é–</button> <button class="btn secondary" onclick="removeFriend('${n}')">åˆªé™¤</button>`;
    fl.appendChild(li);
  });
  const bl=el('blockList'); bl.innerHTML='';
  state.blocks.forEach(n=>{
    const li=document.createElement('li'); li.innerHTML=`${n} <button class="btn secondary" onclick="unblock('${n}')">è§£é™¤</button>`;
    bl.appendChild(li);
  });
}
function renderChatSelectors(){
  const s=el('chatWith'); s.innerHTML='';
  state.friends.filter(n=>!state.blocks.includes(n)).forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; s.appendChild(o); });
}
function renderChat(){
  const withN=el('chatWith').value; const box=el('chatBox'); box.innerHTML='';
  const arr=state.chats[withN]||[];
  arr.forEach(m=>{ const d=document.createElement('div'); d.className='msg '+(m.me?'me':'other'); d.textContent=`${m.text}  Â·  ${m.time}`; box.appendChild(d); });
  box.scrollTop=box.scrollHeight;
}
function sendMsg(){
  const withN=el('chatWith').value; if(!withN) return;
  const t=el('chatMsg').value.trim(); if(!t) return;
  (state.chats[withN]=state.chats[withN]||[]).push({text:t,me:true,time:new Date().toLocaleTimeString()});
  el('chatMsg').value=''; save();
  setTimeout(()=>{ (state.chats[withN]=state.chats[withN]||[]).push({text:'ï¼ˆè‡ªå‹•å›è¦†ï¼‰å–µå–µï½',me:false,time:new Date().toLocaleTimeString()}); save(); }, 500);
}

/* ====== å½±ç‰‡ ====== */
function addVideo(e){
  const f=e.target.files[0]; if(!f) return;
  const url=URL.createObjectURL(f);
  const v=document.createElement('video'); v.src=url; v.onloadedmetadata=()=>{
    if(v.duration>30){ URL.revokeObjectURL(url); alert('è¶…é 30 ç§’'); return; }
    const rd=new FileReader(); rd.onload=()=>{ state.videos.push({src:rd.result,time:new Date().toLocaleString()}); save(); };
    rd.readAsDataURL(f);
  }
}
function renderVideos(){
  const g=el('videoGrid'); g.innerHTML='';
  state.videos.forEach(v=>{
    const d=document.createElement('div'); d.className='card';
    d.innerHTML=`<video src="${v.src}" controls style="width:100%;border-radius:12px"></video><div class="muted mt-1">${v.time}</div>`;
    g.appendChild(d);
  });
}

/* ====== åœ°åœ– ====== */
let _map,_mapReady=false;
async function initMap(){
  if(!_map){
    _map=L.map('map'); _mapReady=true;
    _map.setView([25.0330,121.5654],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(_map);
    try{
      const points=await (await fetch('./data/locations.json',{cache:'no-cache'})).json();
      points.forEach(p=>{
        const m=L.marker([p.lat,p.lng]).addTo(_map);
        const g=`https://www.google.com/maps?q=${p.lat},${p.lng}`;
        const a=`https://maps.apple.com/?q=${p.lat},${p.lng}`;
        m.bindPopup(`<b>${p.name}</b><br>${p.address||''}<br><a href='${g}' target='_blank'>Google Maps</a> ï½œ <a href='${a}' target='_blank'>Apple Maps</a>`);
      });
    }catch(e){}
  }
  if(_mapReady){ setTimeout(()=>_map.invalidateSize(),60); }
}

/* ====== è¯çµ¡è¡¨å–® ====== */
function submitForm(e){ e.preventDefault(); alert('å·²æ”¶åˆ°æ‚¨çš„è¨Šæ¯ï¼ˆç¤ºç¯„ï¼‰'); e.target.reset(); return false; }

/* ====== Render ====== */
function sanitizePets(){
  state.pets = (state.pets || []).map(p => ({
    id: p.id || crypto.randomUUID(),
    name: p.name || '',
    sex: p.sex || 'M',
    birth: p.birth || '',                // å¯èƒ½æ²’æœ‰å°±è£œæˆç©ºå­—ä¸²
    age: (typeof p.age === 'number')     // èˆŠè³‡æ–™æ²’æœ‰ birth/age éƒ½è™•ç†
        ? p.age
        : (p.birth ? Math.max(0, Math.floor((Date.now() - new Date(p.birth)) / (365.25*24*60*60*1000))) : 0),
    breed: p.breed || '',
    avatar: p.avatar || ''
  }));
}

// åœ¨ renderAll() çš„é–‹é ­å‘¼å«
async function renderAll(){
  sanitizePets();         // â† æ–°å¢é€™è¡Œ
  renderIdentity();
  renderGuild();
  renderPets();
  renderCart();
  renderSocial();
  renderVideos();
  renderVet();
  renderWall();
}
function boot(){
  restorePage();
  loadBreeds();
  loadProducts();
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
}
window.addEventListener('hashchange', restorePage);
window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
