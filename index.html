<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PurrGo å–µä¾†é€Ÿï½œå“ç‰Œå®˜ç¶² Demo</title>

  <!-- PWA / Icons -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./logo/favicon.png">
  <link rel="apple-touch-icon" sizes="192x192" href="./logo/logo-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="./logo/logo-512.png">
  <meta name="theme-color" content="#ff7f50"/>

  <link rel="stylesheet" href="./style.css"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body id="top">

<header class="site-header">
  <div class="nav container">
    <a class="brand" href="#home" onclick="route('home');return false;">
      <span class="logo">G</span><span class="brand-name">PurrGo å–µä¾†é€Ÿ</span>
    </a>

    <!-- æ¡Œé¢ -->
    <nav class="tabs hide-on-mobile" aria-label="ä¸»é¸å–®">
      <a class="tab" data-sec="home"      href="#home">é¦–é </a>
      <a class="tab" data-sec="products"  href="#products">ç”¢å“</a>
      <a class="tab" data-sec="guild"     href="#guild">å…¬æœƒ</a>
      <a class="tab" data-sec="kiosk"     href="#kiosk">æ“šé»</a>
      <a class="tab" data-sec="community" href="#community">ç…§ç‰‡ç‰†</a>
      <a class="tab" data-sec="social"    href="#social">ç¤¾ç¾¤</a>
      <a class="tab" data-sec="chat"      href="#chat">èŠå¤©</a>
      <a class="tab" data-sec="about"     href="#about">ç†å¿µ</a>
      <a class="tab" data-sec="contact"   href="#contact">è¯çµ¡</a>
    </nav>

    <!-- æ‰‹æ©Ÿæ¼¢å ¡ -->
    <button class="menu-toggle show-on-mobile" aria-label="å±•é–‹é¸å–®" onclick="toggleMenu()">
      <span class="menu-ico" aria-hidden="true"></span>
    </button>
  </div>

  <!-- æ‰‹æ©ŸæŠ½å±œ + èƒŒæ™¯é®ç½© -->
  <nav id="drawer" class="drawer" aria-label="æŠ½å±œé¸å–®" role="dialog" aria-modal="true">
    <div class="drawer-body">
      <a href="#home"      class="drawer-item" onclick="jump('home')">é¦–é </a>
      <a href="#products"  class="drawer-item" onclick="jump('products')">ç”¢å“</a>
      <a href="#guild"     class="drawer-item" onclick="jump('guild')">å…¬æœƒ</a>
      <a href="#kiosk"     class="drawer-item" onclick="jump('kiosk')">æ“šé»</a>
      <a href="#community" class="drawer-item" onclick="jump('community')">ç…§ç‰‡ç‰†</a>
      <a href="#avatar"    class="drawer-item" onclick="jump('avatar')">å»ºç«‹ä¸»å­</a>
      <a href="#social"    class="drawer-item" onclick="jump('social')">ç¤¾ç¾¤</a>
      <a href="#chat"      class="drawer-item" onclick="jump('chat')">èŠå¤©</a>
      <a href="#about"     class="drawer-item" onclick="jump('about')">ç†å¿µ</a>
      <a href="#contact"   class="drawer-item" onclick="jump('contact')">è¯çµ¡</a>
    </div>
  </nav>
  <div id="backdrop" class="backdrop" onclick="closeMenu()" aria-hidden="true"></div>
</header>

<main>
  <!-- Home -->
  <section id="home" class="page container">
    <div class="hero card">
      <div class="hero-copy">
        <span class="pill">PurrGo å–µä¾†é€Ÿ</span>
        <h1 class="hero-title">ä¾¿åˆ© Ã— å¯æ„› Ã— æ°¸çºŒ Ã— å…±å‰µ</h1>
        <p class="muted">å‰µæ–°é…é€ + å…¬æœƒåˆ¶åº¦ï¼Œè®“è£œçµ¦æ›´è°æ˜ã€æ›´ä¾¿å®œã€æ›´å¥½ç©ï¼›æŠŠã€Œè²·è²“ç ‚ã€è®Šæˆæœ‰æˆå°±æ„Ÿçš„é‡Œç¨‹ç¢‘éŠæˆ²ã€‚</p>
        <div class="inline">
          <a class="btn" href="#products" onclick="route('products');return false;">é–‹å§‹æ¢ç´¢ç”¢å“</a>
          <a class="btn secondary" href="#guild" onclick="route('guild');return false;">åŠ å…¥è²“å¥´å…¬æœƒ</a>
          <a class="btn tertiary" href="#avatar" onclick="route('avatar');return false;">å»ºç«‹ä¸»å­è§’è‰²</a>
        </div>
      </div>
      <div class="hero-art">
        <div class="hero-visual"><div class="hero-logo">G</div></div>
      </div>
    </div>
  </section>

  <!-- å»ºç«‹ä¸»å­è§’è‰² -->
  <section id="avatar" class="page container">
    <header class="section-head">
      <span class="pill">Avatar</span>
      <h2>å»ºç«‹ä¸»å­è§’è‰²</h2>
      <p class="section-sub">ä¸Šå‚³é ­åƒã€é¸å“ç¨®èˆ‡é…è‰²ï¼›æ”¯æ´å¤šè²“å®¶åº­ï¼Œæœƒé€£å‹•å¥æª¢èˆ‡ç…§ç‰‡ç‰†ã€‚</p>
    </header>

    <div class="grid g-2">
      <form class="card grid g-2" onsubmit="return saveCat(event)">
        <div class="gcol-2"><label>ä¸»å­åç¨±<input id="catName" class="input" placeholder="å–µçš‡å¤§å" required></label></div>
        <div><label>å“ç¨®<select id="catBreed" class="input"></select></label></div>
        <div class="inline">
          <label>æ¯›è‰² <input type="color" id="coatColor" value="#2e2e2e" class="input" style="width:120px"></label>
          <label>çœ¼ç› <input type="color" id="eyeColor"  value="#2ec1ac" class="input" style="width:120px"></label>
        </div>
        <div class="gcol-2 inline">
          <input id="catFile" type="file" accept="image/*" onchange="previewCat(event)">
          <button class="btn" type="submit">å„²å­˜ä¸»å­</button>
        </div>
        <div class="gcol-2">
          <div id="catPreview" class="avatar-preview"></div>
          <small class="muted">è‹¥æœªä¸Šå‚³ç…§ç‰‡ï¼Œç³»çµ±æœƒç”¨ç°¡å–® SVG é ­åƒé è¦½ã€‚</small>
        </div>
      </form>

      <div class="card">
        <h3 class="mt-0">æˆ‘çš„ä¸»å­</h3>
        <div id="catRow" class="hscroll"></div>
      </div>
    </div>
  </section>

  <!-- Products -->
  <section id="products" class="page container">
    <header class="section-head">
      <span class="pill">Products</span>
      <h2 class="nowrap">ç†±éŠ·èˆ‡æ–¹æ¡ˆ</h2>
      <p class="section-sub">æ©«å‘æ»‘å‹•å¡ç‰‡ï¼Œæ”¯æ´ç”¢å“ç…§ç‰‡ã€è©³æƒ…å½ˆçª—èˆ‡åŠ å…¥è³¼ç‰©è»Šã€‚</p>
    </header>
    <div class="hwrap"><div id="productRow" class="hscroll cards"></div></div>
    <div class="card mt-2">
      <h3 class="mt-0">è³¼ç‰©è»Šï¼ˆç¤ºç¯„ï¼‰</h3>
      <div id="cartItems" class="muted">å°šç„¡å•†å“</div>
      <div class="inline mt-1">
        <button class="btn" onclick="checkout()">çµå¸³ï¼ˆç¤ºç¯„ï¼‰</button>
        <button class="btn secondary" onclick="clearCart()">æ¸…ç©º</button>
      </div>
    </div>
  </section>

  <!-- Guild -->
  <section id="guild" class="page container">
    <header class="section-head">
      <span class="pill">Guild</span>
      <h2>å…¬æœƒåˆ¶åº¦ï¼šä¸€èµ·æˆé•·ã€ä¸€èµ·æ›´çœ</h2>
      <p class="section-sub">å‰µç«‹é–€æª»ã€VIP ç­‰ç´šã€è²¢ç»æ¢ã€æ¯æ—¥ä»»å‹™ã€å¥æª¢è²¢ç»â€¦</p>
    </header>

    <div class="grid g-2">
      <div class="card">
        <h3 class="mt-0">èº«ä»½ç¶å®š / VIP</h3>
        <div class="inline">
          <input class="input" id="phoneInput" placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼">
          <button class="btn" onclick="bindPhone(document.getElementById('phoneInput').value)">ç¶å®šæ‰‹æ©Ÿï¼ˆç¤ºæ„ï¼‰</button>
        </div>
        <div class="inline mt-1">
          <button id="lineBtn" class="btn secondary" onclick="toggleLine()">ç¶å®š LINEï¼ˆç¤ºæ„ï¼‰</button>
          <div id="identityInfo" class="muted">å°šæœªç¶å®šæ‰‹æ©Ÿ</div>
        </div>
        <div class="mt-1">ç´¯ç©æ¶ˆè²»ï¼š<b id="lifetimeSpend">$0</b> ï½œ VIP ç­‰ç´šï¼š<b id="vipLevel">V0</b> ï½œ ä¸‹ä¸€ç´šé‚„å·®ï¼š<b id="vipNext">$200</b></div>
        <div class="inline mt-1"><button class="btn" onclick="dailyCheckin()">æ¯æ—¥ç°½åˆ° + èƒ½é‡ / XP</button><span id="checkinInfo" class="muted"></span></div>
      </div>

      <div class="card">
        <h3 class="mt-0">å‰µç«‹å…¬æœƒ / è²¢ç»</h3>
        <div>å…¬æœƒåç¨±ï¼š<b id="guildName">ï¼ˆå°šæœªå‰µç«‹ï¼‰</b> ï½œ ç­‰ç´šï¼š<b id="guildLevel">â€“</b> ï½œ ç¸½è²¢ç»ï¼š<b id="guildContrib">0</b></div>
        <div class="inline mt-1">
          <button class="btn" onclick="createGuild()">å‰µç«‹å…¬æœƒ</button>
          <button class="btn secondary" onclick="contribute(50)">æç» +50ï¼ˆç¤ºç¯„ï¼‰</button>
          <button class="btn secondary" onclick="mockWar()">æ¨¡æ“¬æˆ°å ±ï¼ˆç¤ºç¯„ï¼‰</button>
        </div>
      </div>
    </div>

    <div class="card mt-2">
      <h3 class="mt-0">å…è²»å¥æª¢ï¼ˆç¤ºç¯„ï¼‰</h3>
      <p class="muted">åŠ å…¥å…¬æœƒå¾Œå¯é ç´„å¹´åº¦ä¸€æ¬¡å…è²»å¥æª¢ã€‚é¸ä¸»å­èˆ‡åœ°å€ â†’ é¡¯ç¤ºåˆä½œé™¢æ‰€ â†’ ä¸Šå‚³å ±å‘Šå¯å¾—å…¬æœƒè²¢ç»ï¼ˆç¤ºæ„ï¼‰ã€‚</p>
      <form class="grid g-2" onsubmit="return bookVet(event)">
        <div><label>ä¸»å­<select id="vetCat" class="input"></select></label></div>
        <div><label>åŸå¸‚<select class="input"><option>å°åŒ—</option><option>å°ä¸­</option><option>é«˜é›„</option></select></label></div>
        <div class="gcol-2"><label>å‚™è¨»<textarea class="input"></textarea></label></div>
        <div class="inline"><button class="btn" type="submit">é ç´„ï¼ˆç¤ºç¯„ï¼‰</button></div>
      </form>
      <div id="vetList" class="muted mt-1"></div>
    </div>

    <div class="card mt-2">
      <h3 class="mt-0">å±•é–‹ï¼šå€åŸŸæˆ°æ’è¡Œï¼ˆç¤ºç¯„ï¼‰</h3>
      <table class="table"><thead><tr><th>#</th><th>å…¬æœƒ</th><th>å€åŸŸ</th><th>åˆ†æ•¸</th></tr></thead><tbody id="warTable"><tr><td>1</td><td>ç¤ºä¾‹å…¬æœƒ</td><td>åŒ—å€</td><td>12345</td></tr></tbody></table>
    </div>
  </section>

  <!-- Kiosk -->
  <section id="kiosk" class="page container">
    <header class="section-head">
      <span class="pill">Kiosk</span>
      <h2>è²©è³£æ©Ÿé»ä½</h2>
      <p class="section-sub">é»æ“Šæ¨™è¨˜å¯é–‹å•Ÿ Google/Apple Maps å°èˆªã€‚</p>
    </header>
    <div id="map" class="map"></div>
  </section>

  <!-- Community -->
  <section id="community" class="page container">
    <header class="section-head">
      <span class="pill">Community</span>
      <h2>ç…§ç‰‡ç‰†ï¼ˆæœ¬æ©Ÿç¤ºç¯„ï¼‰</h2>
      <p class="section-sub">ä¸Šå‚³å„²å­˜åœ¨æœ¬æ©Ÿ localStorageï¼Œå¯ä¾ä¸»å­éæ¿¾ã€‚</p>
    </header>
    <div class="inline">
      <label>ä¸»å­<select id="photoCat" class="input" style="width:160px"></select></label>
      <input id="photoFile" type="file" accept="image/*" onchange="addPhoto(event)">
      <select id="photoFilter" class="input" style="width:160px" onchange="renderWall()"></select>
      <button class="btn secondary" onclick="clearWall()">æ¸…é™¤æ‰€æœ‰ç…§ç‰‡ï¼ˆæœ¬æ©Ÿï¼‰</button>
    </div>
    <div id="wall" class="grid g-3 mt-2"></div>
  </section>

  <!-- Socialï¼ˆéª¨æ¶ï¼‰ -->
  <section id="social" class="page container">
    <header class="section-head">
      <span class="pill">Social</span>
      <h2>ç¤¾ç¾¤ï¼ˆå±•ç¤ºéª¨æ¶ï¼‰</h2>
      <p class="section-sub">æŒ‰è®š / ç•™è¨€ / åˆ†äº«çš„äº’å‹•æ¡†æ¶ï¼Œä¾›å±•ç¤ºã€‚</p>
    </header>
    <div id="feed" class="grid g-2">
      <article class="card"><h3 class="mt-0">å…¬æœƒæ´»å‹•å›é¡§</h3><p class="muted">é€™æ˜¯ç¤ºç¯„è²¼æ–‡å…§å®¹â€¦</p><div class="inline"><button class="btn secondary" onclick="alert('è®š +1ï¼ˆç¤ºç¯„ï¼‰')">â™¥ Like</button><button class="btn secondary" onclick="alert('ç•™è¨€ï¼ˆç¤ºç¯„ï¼‰')">ğŸ’¬ Comment</button><button class="btn secondary" onclick="alert('åˆ†äº«ï¼ˆç¤ºç¯„ï¼‰')">â†— Share</button></div></article>
      <article class="card"><h3 class="mt-0">æ–°å“é«”é©—</h3><p class="muted">é€™æ˜¯ç¤ºç¯„è²¼æ–‡å…§å®¹â€¦</p><div class="inline"><button class="btn secondary" onclick="alert('è®š +1ï¼ˆç¤ºç¯„ï¼‰')">â™¥ Like</button><button class="btn secondary" onclick="alert('ç•™è¨€ï¼ˆç¤ºç¯„ï¼‰')">ğŸ’¬ Comment</button><button class="btn secondary" onclick="alert('åˆ†äº«ï¼ˆç¤ºç¯„ï¼‰')">â†— Share</button></div></article>
    </div>
  </section>

  <!-- Chatï¼ˆéª¨æ¶ï¼‰ -->
  <section id="chat" class="page container">
    <header class="section-head">
      <span class="pill">Chat</span>
      <h2>èŠå¤©ï¼ˆå±•ç¤ºéª¨æ¶ï¼‰</h2>
      <p class="section-sub">å¥½å‹åˆ—è¡¨ / å°è©±çª—éª¨æ¶ï¼Œä¾›æŠ•å½±ç‰‡å±•ç¤ºã€‚</p>
    </header>
    <div class="grid g-2">
      <aside class="card"><h3 class="mt-0">å¥½å‹</h3><ul class="list"><li>å°æ©˜</li><li>é»‘ç³–</li><li>èŠ±èŠ±</li></ul></aside>
      <div class="card"><h3 class="mt-0">èˆ‡å°æ©˜çš„å°è©±</h3><div class="empty">æ­¤ç‚ºç´”å‰ç«¯ç¤ºç¯„ï¼Œæœªé€£ç·šã€‚</div></div>
    </div>
  </section>

  <!-- About / Contact -->
  <section id="about" class="page container">
    <header class="section-head">
      <span class="pill">About</span>
      <h2>å“ç‰Œç†å¿µ</h2>
      <p class="section-sub">ä¾¿åˆ©ã€å¯æ„›ã€æ°¸çºŒã€å…±å‰µã€‚</p>
    </header>
    <div class="card"><p class="muted">æˆ‘å€‘ç›¸ä¿¡èˆ‡ç¤¾ç¾¤ä¸€èµ·å…±å‰µï¼ŒæŠŠæ—¥å¸¸è£œçµ¦è½‰åŒ–ç‚ºå¥½ç©ä¸”æ›´æœ‰æ•ˆç‡çš„é«”é©—ã€‚</p></div>
  </section>

  <section id="contact" class="page container">
    <header class="section-head">
      <span class="pill">Contact</span>
      <h2>è¯çµ¡æˆ‘å€‘</h2>
    </header>
    <form class="card grid g-2" onsubmit="return submitForm(event)">
      <div><label>æ‚¨çš„ç¨±å‘¼<input class="input" required></label></div>
      <div><label>Email<input type="email" class="input" required></label></div>
      <div class="gcol-2"><label>è¨Šæ¯<textarea class="input" required></textarea></label></div>
      <div class="inline"><button class="btn" type="submit">é€å‡º</button></div>
    </form>
    <p class="muted mt-1">ä¹Ÿå¯ä¾†ä¿¡ï¼š<a href="mailto:hello@purrgo.tw">hello@purrgo.tw</a> ï½œ LINE å®˜æ–¹ï¼š@purrgo</p>
  </section>
</main>

<footer class="container footer">Â© PurrGo å–µä¾†é€Ÿ ï½œ å…¬é–‹ Demo</footer>

<!-- FAB -->
<div class="fab" id="fab">
  <button class="fab-btn" title="Top"  onclick="route('home')">Top</button>
  <button class="fab-btn" title="Shop" onclick="route('products')">Shop</button>
  <button class="fab-btn" title="Guild" onclick="route('guild')">Guild</button>
  <button class="fab-btn" title="Map"  onclick="route('kiosk')">Map</button>
  <button class="fab-btn" title="Msg"  onclick="route('contact')">Msg</button>
</div>

<script>
/* ===== ç‹€æ…‹ ===== */
const LS_KEY='purrgoState';
const state=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
state.user ||= { phone:'', line:false, vipXp:0, lifetimeSpend:0, energy:0, lastCheckin:'' };
state.guild ||= { name:'', level:0, contribution:0 };
state.cart  ||= [];
state.vet   ||= [];         // {catId, city, note, time}
state.wall  ||= [];         // {src, catId, ts}
state.cats  ||= [];         // æˆ‘çš„ä¸»å­
save();

/* ===== è·¯ç”±ï¼ˆåˆ†é ï¼‰ ===== */
function route(id){ location.hash = '#'+id; renderRoute(); }
function renderRoute(){
  const hash=(location.hash||'#home').replace('#','');
  document.querySelectorAll('.page').forEach(sec=>sec.style.display = sec.id===hash ? 'block' : 'none');
  document.querySelectorAll('.tab').forEach(a=>a.setAttribute('aria-current', a.dataset.sec===hash?'page':'false'));
  window.scrollTo({top:0,behavior:'instant'});
}
window.addEventListener('hashchange', renderRoute);
window.addEventListener('DOMContentLoaded', renderRoute);

/* ===== æ¼¢å ¡ / æŠ½å±œ ===== */
const drawer=document.getElementById('drawer'), backdrop=document.getElementById('backdrop');
function toggleMenu(){ const open=drawer.classList.toggle('open'); backdrop.classList.toggle('open',open); document.body.classList.toggle('menu-open',open); }
function closeMenu(){ drawer.classList.remove('open'); backdrop.classList.remove('open'); document.body.classList.remove('menu-open'); }
function jump(id){ closeMenu(); setTimeout(()=>route(id),10); }

/* ===== èº«ä»½ / VIP ===== */
function bindPhone(v){ state.user.phone=v||''; save(); }
function toggleLine(){ state.user.line=!state.user.line; save(); }
function vipLevelByXp(x){ if(x>=5000) return 5; if(x>=3000) return 4; if(x>=1500) return 3; if(x>=600) return 2; if(x>=200) return 1; return 0; }
function nextVipNeed(x){ const br=[200,600,1500,3000,5000]; for(const b of br){ if(x<b) return b-x; } return 0; }
function renderIdentity(){
  document.getElementById('identityInfo').textContent = state.user.phone ? `å·²ç¶å®šï¼š${state.user.phone} ï½œ LINEï¼š${state.user.line?'å·²é€£çµ':'æœªé€£çµ'}` : 'å°šæœªç¶å®šæ‰‹æ©Ÿ';
  document.getElementById('lineBtn').textContent = state.user.line? 'å–æ¶ˆ LINE é€£çµï¼ˆç¤ºæ„ï¼‰':'ç¶å®š LINEï¼ˆç¤ºæ„ï¼‰';
}
function renderVIP(){
  const xp=state.user.vipXp|0;
  document.getElementById('lifetimeSpend').textContent = `$${(state.user.lifetimeSpend||0).toLocaleString()}`;
  document.getElementById('vipLevel').textContent = 'V'+vipLevelByXp(xp);
  document.getElementById('vipNext').textContent = nextVipNeed(xp)>0? `$${nextVipNeed(xp)}`:'å·²é”é ‚ç´š';
}
function dailyCheckin(){
  const today=new Date().toISOString().slice(0,10);
  if(state.user.lastCheckin===today){ document.getElementById('checkinInfo').textContent='ä»Šå¤©å·²ç°½åˆ°'; return; }
  state.user.lastCheckin=today; state.user.energy+=10; state.user.vipXp+=10; document.getElementById('checkinInfo').textContent='ç°½åˆ°æˆåŠŸï¼š+10 èƒ½é‡ã€+10 VIP XP'; save();
}

/* ===== å…¬æœƒ ===== */
const GUILD_CREATE_NEED = 1200;
function renderGuild(){
  document.getElementById('guildName').textContent = state.guild.name||'ï¼ˆå°šæœªå‰µç«‹ï¼‰';
  document.getElementById('guildLevel').textContent = state.guild.level||'â€“';
  document.getElementById('guildContrib').textContent = state.guild.contribution|0;
}
function createGuild(){ if((state.user.lifetimeSpend||0) < GUILD_CREATE_NEED){ return alert('å°šæœªé”åˆ°å‰µç«‹é–€æª»ï¼šç´¯ç©æ¶ˆè²» $1,200'); } const name = prompt('è¼¸å…¥å…¬æœƒåç¨±'); if(!name) return; state.guild.name=name; state.guild.level=1; save(); alert('å…¬æœƒå·²å‰µç«‹ï¼'); }
function contribute(n){ if(!state.guild.name) return alert('è«‹å…ˆå‰µç«‹å…¬æœƒ'); state.guild.contribution += n; if(state.guild.contribution >= (state.guild.level*500)){ state.guild.level++; alert('å…¬æœƒå‡ç´šï¼'); } save(); }
function mockWar(){ if(!state.guild.name) return alert('å…ˆå‰µç«‹å…¬æœƒ'); const add=Math.floor(Math.random()*500+100); const tr=document.createElement('tr'); tr.innerHTML=`<td>*</td><td>${state.guild.name}</td><td>ä½ çš„å€åŸŸ</td><td>+${add}</td>`; document.getElementById('warTable').prepend(tr); }

/* ===== ç”¢å“ / è³¼ç‰©è»Š ===== */
async function loadProducts(){
  try{
    const res = await fetch('./data/products.json',{cache:'no-cache'});
    const list = await res.json();
    const row = document.getElementById('productRow'); row.innerHTML='';
    list.forEach(p=>{
      const el=document.createElement('article'); el.className='card product';
      const imgStyle = p.img ? `background-image:url('${p.img}');background-size:cover;background-position:center;` : '';
      el.innerHTML = `
        <div class="product-photo" style="${imgStyle}">${p.img?'':'<div class="empty">No Photo</div>'}</div>
        <h3 class="mt-0">${p.name}</h3>
        <div class="muted">${p.spec||''}</div>
        <div class="price">NT$ ${p.price.toLocaleString()}</div>
        <ul class="list">${(p.bullets||[]).map(b=>`<li>${b}</li>`).join('')}</ul>
        <div class="inline mt-1">
          <button class="btn" onclick='addToCart(${JSON.stringify(p).replace(/'/g,"&#39;")})'>åŠ å…¥è³¼ç‰©è»Š</button>
          <button class="btn secondary">æŸ¥çœ‹è©³æƒ…</button>
        </div>`;
      row.appendChild(el);
    });
  }catch(e){ document.getElementById('productRow').innerHTML = '<div class="card">è®€å–ç”¢å“å¤±æ•—</div>'; }
}
function addToCart(p){ const item = state.cart.find(i=>i.id===p.id) || (state.cart.push({...p,qty:0}), state.cart.find(i=>i.id===p.id)); item.qty++; save(); }
function clearCart(){ state.cart=[]; save(); }
function renderCart(){
  const box=document.getElementById('cartItems'); if(!box) return;
  if(state.cart.length===0){ box.textContent='å°šç„¡å•†å“'; return; }
  let sum=0; box.innerHTML = state.cart.map(i=>{ sum+=i.price*i.qty; return `${i.name} Ã— ${i.qty} = NT$ ${(i.price*i.qty).toLocaleString()}`; }).join('<br>');
  box.innerHTML += `<div class="mt-1"><b>å°è¨ˆï¼šNT$ ${sum.toLocaleString()}</b></div>`;
}
function checkout(){
  if(state.cart.length===0) return alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
  const sum = state.cart.reduce((a,b)=>a+b.price*b.qty,0);
  state.user.lifetimeSpend = (state.user.lifetimeSpend||0) + sum;
  state.user.vipXp += Math.round(sum/10);
  state.user.energy += Math.round(sum/20);
  state.cart=[]; alert(`çµå¸³æˆåŠŸï¼ç´¯ç©æ¶ˆè²» +$${sum.toLocaleString()}ï¼ŒVIP XP èˆ‡èƒ½é‡å·²å¢åŠ `);
  save();
}

/* ===== ä¸»å­ï¼ˆAvatarï¼‰ ===== */
let breeds=[];
async function loadBreeds(){
  try{ const res=await fetch('./data/breeds.json',{cache:'no-cache'}); breeds=await res.json(); }catch(e){ breeds=[]; }
  const sel=document.getElementById('catBreed'); sel.innerHTML = (breeds.length?breeds:['æœªåˆ†é¡']).map(b=>`<option>${b}</option>`).join('');
}
function svgHead(coat='#2e2e2e',eye='#2ec1ac'){
  return `<svg viewBox="0 0 120 120" width="120" height="120" xmlns="http://www.w3.org/2000/svg">
    <defs><filter id="s" x="-10%" y="-10%" width="120%" height="120%"><feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity=".35"/></filter></defs>
    <g filter="url(#s)">
      <path d="M20 36 L40 20 L55 40 A35 35 0 0 1 65 40 L80 20 L100 36 Q110 80 60 96 Q10 80 20 36Z" fill="${coat}"/>
      <circle cx="45" cy="60" r="8" fill="${eye}"/><circle cx="75" cy="60" r="8" fill="${eye}"/>
      <circle cx="45" cy="60" r="3" fill="#000"/><circle cx="75" cy="60" r="3" fill="#000"/>
      <path d="M55 72 Q60 75 65 72" stroke="#000" stroke-width="2" fill="none"/>
    </g>
  </svg>`;
}
let catPreviewData=null;
function previewCat(e){
  const f=e.target.files[0]; if(!f){ catPreviewData=null; renderCatPreview(); return; }
  const r=new FileReader(); r.onload=()=>{ catPreviewData=r.result; renderCatPreview(); }; r.readAsDataURL(f);
}
function renderCatPreview(){
  const box=document.getElementById('catPreview'); const coat=document.getElementById('coatColor').value, eye=document.getElementById('eyeColor').value;
  box.innerHTML = catPreviewData ? `<img src="${catPreviewData}" class="avatar-img">` : svgHead(coat,eye);
}
function saveCat(ev){
  ev.preventDefault();
  const cat={ id:crypto.randomUUID(), name:catName.value.trim(), breed:catBreed.value, coat:coatColor.value, eye:eyeColor.value, avatar:catPreviewData };
  if(!cat.name){ alert('è«‹è¼¸å…¥ä¸»å­åç¨±'); return false; }
  state.cats.push(cat); save(); ev.target.reset(); catPreviewData=null; renderCatPreview(); alert('å·²å„²å­˜ä¸»å­'); return false;
}
function renderCats(){
  const row=document.getElementById('catRow'); if(!row) return;
  row.innerHTML='';
  if(!state.cats.length){ row.innerHTML='<div class="card">ç›®å‰æ²’æœ‰ä¸»å­ï¼Œå»ä¸Šæ–¹å»ºç«‹ä¸€éš»å§ï¼</div>'; return; }
  state.cats.forEach(c=>{
    const el=document.createElement('div'); el.className='card'; el.style.minWidth='240px';
    el.innerHTML = `<div class="inline">
      ${c.avatar?`<img src="${c.avatar}" class="avatar-thumb">`:`${svgHead(c.coat,c.eye)}`}
      <div><b>${c.name}</b><div class="muted">${c.breed||'æœªåˆ†é¡'}</div></div>
    </div>`;
    row.appendChild(el);
  });
}

/* ===== å¥æª¢ï¼ˆä¸»å­é¸æ“‡ï¼‰ ===== */
function bookVet(e){
  e.preventDefault();
  if(!state.guild.name) { alert('è«‹å…ˆåŠ å…¥æˆ–å‰µç«‹å…¬æœƒï¼ˆç¤ºç¯„é™åˆ¶ï¼‰'); return false; }
  const f=e.target;
  const rec={ catId:f[0].value, city:f[1].value, note:f[2].value, time:new Date().toLocaleString() };
  state.vet.push(rec); save(); f.reset(); alert('å·²å»ºç«‹é ç´„ï¼ˆç¤ºç¯„ï¼‰'); return false;
}
function renderVet(){
  const box=document.getElementById('vetList'); if(!box) return;
  if(!state.vet.length){ box.textContent='ç›®å‰ç„¡é ç´„ç´€éŒ„ï¼ˆç¤ºç¯„ï¼‰'; return;}
  box.innerHTML = 'é ç´„ç´€éŒ„ï¼š<br>'+state.vet.map(v=>{
    const cat=state.cats.find(c=>c.id===v.catId); return `${v.time}ï½œ${v.city}ï½œ${cat?cat.name:'æœªæŒ‡å'}`;
  }).join('<br>');
}

/* ===== ç…§ç‰‡ç‰†ï¼ˆä¸»å­ï¼‰ ===== */
function addPhoto(e){
  const file=e.target.files[0]; if(!file) return;
  const catId=document.getElementById('photoCat').value||'';
  const reader=new FileReader(); reader.onload=()=>{ state.wall.push({src:reader.result,catId,ts:Date.now()}); save(); };
  reader.readAsDataURL(file);
}
function clearWall(){ if(confirm('æ¸…é™¤æ‰€æœ‰æœ¬æ©Ÿç…§ç‰‡ï¼Ÿ')){ state.wall=[]; save(); }}
function renderWall(){
  const wall=document.getElementById('wall'); if(!wall) return; wall.innerHTML='';
  const filter=document.getElementById('photoFilter').value||'';
  const list = state.wall.filter(p=>!filter || p.catId===filter);
  if(!list.length){ wall.innerHTML='<div class="card">ç›®å‰æ²’æœ‰ç…§ç‰‡</div>'; return; }
  list.forEach(p=>{
    const wrap=document.createElement('div'); wrap.className='card'; wrap.innerHTML=`
      <img src="${p.src}" class="photo"/>
      <div class="muted mt-1">${(state.cats.find(c=>c.id===p.catId)||{}).name||'æœªæŒ‡å®š'}</div>`;
    wall.appendChild(wrap);
  });
}

/* ===== åœ°åœ– ===== */
async function initMap(){
  if(!window.L) return;
  const map=L.map('map',{zoomControl:true}).setView([25.0330,121.5654],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(map);
  try{
    const res = await fetch('./data/locations.json',{cache:'no-cache'}); const points = await res.json();
    points.forEach(p=>{
      const m=L.marker([p.lat,p.lng]).addTo(map);
      const gLink = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
      const aLink = `https://maps.apple.com/?q=${p.lat},${p.lng}`;
      m.bindPopup(`<b>${p.name}</b><br>${p.address||''}<br><a href='${gLink}' target='_blank'>Google Maps</a> ï½œ <a href='${aLink}' target='_blank'>Apple Maps</a>`);
    });
  }catch(e){}
}

/* ===== è¯çµ¡è¡¨å–® ===== */
function submitForm(e){ e.preventDefault(); alert('å·²æ”¶åˆ°æ‚¨çš„è¨Šæ¯ï¼ˆç¤ºç¯„ï¼‰'); e.target.reset(); return false; }

/* ===== ä¸‹æ‹‰ä¸»å­é¸å–®åŒæ­¥ ===== */
function renderCatSelects(){
  const selects=[document.getElementById('vetCat'),document.getElementById('photoCat'),document.getElementById('photoFilter')];
  selects.forEach(sel=>{
    if(!sel) return;
    const value=sel.value;
    sel.innerHTML = `<option value="">${sel.id==='photoFilter'?'å…¨éƒ¨ä¸»å­':'æœªæŒ‡å®š'}</option>` + state.cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    if(value) sel.value=value;
  });
}

/* ===== å­˜å–ï¼‹é‡ç¹ª ===== */
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); renderIdentity(); renderVIP(); renderGuild(); renderCart(); renderVet(); renderCats(); renderCatSelects(); renderWall(); }

/* ===== å•Ÿå‹• ===== */
window.addEventListener('DOMContentLoaded',async()=>{
  await loadBreeds();
  renderCatPreview();
  loadProducts();
  initMap();
  renderRoute();
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
});

/* æŠ½å±œé–‹å•Ÿæ™‚ FAB è‡ªå‹•éš±è— */
const fab=document.getElementById('fab');
new MutationObserver(()=>{ fab.classList.toggle('hidden', drawer.classList.contains('open')); })
.observe(drawer,{attributes:true});
</script>
</body>
</html>
