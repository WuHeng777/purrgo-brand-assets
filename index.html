<!doctype html>
<div><label>貓咪暱稱<input class="input" required></label></div>
<div><label>城市<select class="input"><option>台北</option><option>台中</option><option>高雄</option></select></label></div>
<div class="gcol-2"><label>備註<textarea class="input"></textarea></label></div>
<div class="inline"><button class="btn" type="submit">預約（示範）</button></div>
</form>
<div id="vetList" class="muted mt-1"></div>
</div>
</section>


<!-- Kiosk 地圖 -->
<section id="kiosk" class="card">
<span class="pill">Kiosk</span>
<h2 class="mt-0">販賣機點位</h2>
<div id="map" style="height:360px;border-radius:12px;overflow:hidden"></div>
<div class="muted mt-1">點擊標記可開啟 Google/Apple Maps 導航。</div>
</section>


<!-- Community 照片牆（本地示範） -->
<section id="community" class="card">
<span class="pill">Community</span>
<h2 class="mt-0">照片牆（本機示範）</h2>
<div class="inline">
<input type="file" accept="image/*" onchange="addPhoto(event)">
<button class="btn secondary" onclick="clearWall()">清除所有照片（本機）</button>
</div>
<div id="wall" class="grid g-3 mt-2"></div>
</section>


<!-- Contact 聯絡我們 -->
<section id="contact" class="card">
<span class="pill">Contact</span>
<h2 class="mt-0">聯絡我們</h2>
<form class="grid g-2" onsubmit="return submitForm(event)">
<div><label>您的稱呼<input class="input" required></label></div>
<div><label>Email<input type="email" class="input" required></label></div>
<div class="gcol-2"><label>訊息<textarea class="input" required></textarea></label></div>
<div class="inline"><button class="btn" type="submit">送出</button></div>
</form>
<p class="muted mt-1">也可來信：<a href="mailto:hello@purrgo.tw">hello@purrgo.tw</a> ｜ LINE 官方：@purrgo</p>
</section>
</main>


<footer class="container" style="padding:26px 0 60px;color:var(--muted)">
© PurrGo 喵來速 ｜ 品牌主色 #ff7f50 ｜ 公開 Demo（不含投資人資訊）
</footer>


<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>


<script>
// ===== 全域狀態（保存於 localStorage） =====
const LS_KEY = 'purrgoState';
const state = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
state.user ||= { phone:'', line:false, vipXp:0, lifetimeSpend:0, energy:0, lastCheckin:'' };
state.guild ||= { name:'', level:0, contribution:0 };
state.cart ||= [];
state.vet ||= [];
save();
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); renderIdentity(); renderVIP(); renderGuild(); renderCart(); renderWall(); }

// ===== Nav 高亮 =====
function highlight(){
const hash=(location.hash||'#home').replace('#','');
document.querySelectorAll('[data-sec]').forEach(a=>{
a.setAttribute('aria-current', a.dataset.sec===hash ? 'page' : 'false');
});
}
window.addEventListener('hashchange', highlight);
window.addEventListener('DOMContentLoaded', highlight);

// ===== 身份 / 綁定 =====
function bindPhone(v){ state.user.phone=v||''; save(); }
function toggleLine(){ state.user.line=!state.user.line; save(); }
function renderIdentity(){
document.getElementById('identityInfo').textContent = state.user.phone ? `已綁定：${state.user.phone} ｜ LINE：${state.user.line?'已連結':'未連結'}` : '尚未綁定手機';
document.getElementById('lineBtn').textContent = state.user.line? '取消 LINE 連結（示意）':'綁定 LINE（示意）';
}

// ===== VIP / 簽到 =====
function vipLevelByXp(x){ if(x>=5000) return 5; if(x>=3000) return 4; if(x>=1500) return 3; if(x>=600) return 2; if(x>=200) return 1; return 0; }
function nextVipNeed(x){ const br=[200,600,1500,3000,5000]; for(const b of br){ if(x<b) return b-x; } return 0; }
function renderVIP(){
const xp = state.user.vipXp|0;
document.getElementById('lifetimeSpend').textContent = `$${(state.user.lifetimeSpend||0).toLocaleString()}`;
document.getElementById('vipLevel').textContent = 'V'+vipLevelByXp(xp);
document.getElementById('vipNext').textContent = nextVipNeed(xp)>0? `$${nextVipNeed(xp)}`:'已達頂級';
}
function dailyCheckin(){
const today = new Date().toISOString().slice(0,10);
if(state.user.lastCheckin===today){ document.getElementById('checkinInfo').textContent='今天已簽到'; return; }
state.user.lastCheckin=today; state.user.energy+=10; state.user.vipXp+=10; document.getElementById('checkinInfo').textContent='簽到成功：+10 能量、+10 VIP XP'; save();
}

// ===== 產品 / 購物示範 =====
async function loadProducts(){
try{
const res = await fetch('/data/products.json',{cache:'no-cache'}); const list = await res.json();
const grid = document.getElementById('productGrid'); grid.innerHTML='';
list.forEach(p=>{
const el = document.createElement('div'); el.className='card';
el.innerHTML = `<h3 class="mt-0">${p.name}</h3>
<div class="muted">規格：${p.spec}</div>
<div class="mt-1"><b>NT$ ${p.price.toLocaleString()}</b></div>
<ul class="list">${(p.bullets||[]).map(b=>`<li>${b}</li>`).join('')}</ul>
<div class="inline mt-1">
<button class="btn" onclick='addToCart(${JSON.stringify(p).replace(/'/g,"&#39;")})'>加入購物車</button>
</div>`;
grid.appendChild(el);
});
}catch(e){ document.getElementById('productGrid').innerHTML='<div class="empty">讀取產品失敗</div>'; }
}
function addToCart(p){ const item = state.cart.find(i=>i.id===p.id) || (state.cart.push({...p,qty:0}), state.cart.find(i=>i.id===p.id)); item.qty++; save(); }
function clearCart(){ state.cart=[]; save(); }
function renderCart(){
const box = document.getElementById('cartItems'); if(!box) return;
if(state.cart.length===0){ box.textContent='尚無商品'; return; }
let sum=0; box.innerHTML = state.cart.map(i=>{ sum+=i.price*i.qty; return `${i.name} × ${i.qty} = NT$ ${(i.price*i.qty).toLocaleString()}`; }).join('<br>');
box.innerHTML += `<div class="mt-1"><b>小計：NT$ ${sum.toLocaleString()}</b></div>`;
}
function checkout(){
if(state.cart.length===0) return alert('購物車是空的');
const sum = state.cart.reduce((a,b)=>a+b.price*b.qty,0);
state.user.lifetimeSpend = (state.user.lifetimeSpend||0) + sum;
state.user.vipXp += Math.round(sum/10); // \$10 = 1 XP（示範）
state.user.energy += Math.round(sum/20);
state.cart=[]; alert(`結帳成功！累積消費 +$${sum.toLocaleString()}，VIP XP 與能量已增加`);
save();
}

// ===== 公會 =====
const GUILD_CREATE_NEED = 1200;
function renderGuild(){
document.getElementById('guildName').textContent = state.guild.name||'（尚未創立）';
document.getElementById('guildLevel').textContent = state.guild.level||'–';
document.getElementById('guildContrib').textContent = state.guild.contribution|0;
}
function createGuild(){
if((state.user.lifetimeSpend||0) < GUILD_CREATE_NEED){ return alert('尚未達到創立門檻：累積消費 $1,200'); }
const name = prompt('輸入公會名稱'); if(!name) return;
state.guild.name=name; state.guild.level=1; save(); alert('公會已創立！');
}
function contribute(n){ if(!state.guild.name) return alert('請先創立公會'); state.guild.contribution += n; if(state.guild.contribution>= (state.guild.level*500)) { state.guild.level++; alert('公會升級！'); } save(); }
function mockWar(){ if(!state.guild.name) return alert('先創立公會'); const add=Math.floor(Math.random()*500+100); const tr=document.createElement('tr'); tr.innerHTML=`<td>*</td><td>${state.guild.name}</td><td>你的區域</td><td>+${add}</td>`; document.getElementById('warTable').prepend(tr); }

// ===== 健檢預約（示範，保存在本機） =====
function bookVet(e){ e.preventDefault(); const f=e.target; const rec={ name:f[0].value, city:f[1].value, note:f[2].value, time:new Date().toLocaleString() }; state.vet.push(rec); save(); f.reset(); alert('已建立預約（示範，本機存檔）'); return false; }
function renderVet(){ const box=document.getElementById('vetList'); if(!box) return; if(!state.vet.length){ box.textContent='目前無預約紀錄（示範）'; return;} box.innerHTML = '預約紀錄：<br>'+state.vet.map(v=>`${v.time}｜${v.city}｜${v.name}`).join('<br>'); }


// ===== 照片牆（本機） =====
function addPhoto(e){ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ state.wall = state.wall||[]; state.wall.push(reader.result); save(); }; reader.readAsDataURL(file); }
function renderWall(){ const wall=document.getElementById('wall'); if(!wall) return; wall.innerHTML=''; (state.wall||[]).forEach(src=>{ const img=new Image(); img.src=src; img.style.borderRadius='12px'; wall.appendChild(img); }); }
function clearWall(){ if(confirm('清除所有本機照片？')){ state.wall=[]; save(); }}


// ===== 地圖（Leaflet + OSM） =====
async function initMap(){
const map=L.map('map').setView([25.0330,121.5654],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
try{
const res = await fetch('/data/locations.json',{cache:'no-cache'}); const points = await res.json();
points.forEach(p=>{
const m=L.marker([p.lat,p.lng]).addTo(map);
const gLink = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
const aLink = `https://maps.apple.com/?q=${p.lat},${p.lng}`;
m.bindPopup(`<b>${p.name}</b><br>${p.address||''}<br><a href='${gLink}' target='_blank'>Google Maps</a> ｜ <a href='${aLink}' target='_blank'>Apple Maps</a>`);
});
}catch(e){ /* ignore */ }
}

// ===== 聯絡表單（示範） =====
function submitForm(e){ e.preventDefault(); alert('已收到您的訊息（示範）'); e.target.reset(); return false; }


// ===== 啟動 =====
window.addEventListener('DOMContentLoaded',()=>{ loadProducts(); initMap(); renderVet(); if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js').catch(()=>{}); } });
</script>
</body>
</html>
