<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PurrGo 喵來速｜品牌官網 Demo</title>

<!-- PWA / Icons（可保留你原檔） -->
<link rel="manifest" href="./manifest.webmanifest">
<link rel="icon" href="./logo/favicon.png">
<link rel="apple-touch-icon" sizes="192x192" href="./logo/logo-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="./logo/logo-512.png">
<meta name="theme-color" content="#ff7f50">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>

<style>
/* ========== Design Token ========== */
:root{
  --brand:#ff7f50; --brand-ink:#000;
  --bg:#0f0f10; --ink:#eaeaea; --muted:#aeb2b7; --line:#242628;
  --card:#17181a;
  --radius:18px; --radius-lg:24px;
  --shadow:0 10px 28px rgba(0,0,0,.28);
  --shadow-strong:0 18px 48px rgba(0,0,0,.45);
  --ease:cubic-bezier(.2,.7,.2,1);
}
@media (prefers-color-scheme: light){
  :root{ --bg:#fff; --ink:#101114; --muted:#667085; --line:#e7e8ea; --card:#f7f8f9 }
}

/* ========== Base ========== */
*{box-sizing:border-box}
html,body{margin:0;padding:0}
body{
  background:var(--bg); color:var(--ink);
  font:16px/1.65 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC",sans-serif;
  overflow-x:hidden;
}
a{color:inherit;text-decoration:none}
img{max-width:100%;display:block}
h1,h2,h3{margin:.2em 0 .4em}
.container{width:min(1120px,92vw);margin:auto}

/* ========== Header ========== */
header{
  position:sticky; top:0; z-index:3000;
  background:color-mix(in oklab,var(--bg),transparent 8%);
  backdrop-filter:saturate(160%) blur(8px);
  border-bottom:1px solid var(--line);
}
.navbar{display:flex;align-items:center;justify-content:space-between;padding:12px 0;gap:16px}
.brand{display:flex;align-items:center;gap:12px;font-weight:900;letter-spacing:.6px}
.brand-logo{width:28px;height:28px;border-radius:9px;overflow:hidden;display:grid;place-items:center;background:var(--brand);box-shadow:var(--shadow)}
.brand-logo img{width:100%;height:100%;object-fit:cover}
.nav-links{display:flex;gap:12px;flex-wrap:wrap}
.nav-links a{padding:8px 12px;border:1px solid var(--line);border-radius:999px;font-weight:700}
.nav-links a.active{background:var(--brand);color:var(--brand-ink);border-color:var(--brand)}

/* Hamburger */
.menu-toggle{
  height:44px;width:56px;border-radius:14px;border:1px solid var(--line);
  background:color-mix(in oklab,var(--bg),#fff 4%);
  display:grid;place-items:center;cursor:pointer;
  transition:transform .15s var(--ease), box-shadow .25s var(--ease), background .25s;
}
.menu-toggle:hover{transform:translateY(-1px); box-shadow:var(--shadow)}
.menu-ico{
  position:relative; width:26px; height:18px; display:block;
  color:var(--ink);
}
.menu-ico::before, .menu-ico::after, .menu-ico span{
  content:""; position:absolute; left:0; right:0; height:2px; border-radius:2px;
  background:currentColor;
}
.menu-ico::before{top:0}
.menu-ico::after{bottom:0}
.menu-ico span{top:8px}

/* Drawer & Backdrop */
.menu{position:fixed; inset:0 0 0 auto; width:84%; max-width:420px;
  background:color-mix(in oklab,var(--bg),#000 6%); border-left:1px solid var(--line);
  transform:translateX(102%); transition:transform .28s var(--ease); z-index:9000;
  padding:20px 18px; overflow:auto;
}
.menu a{
  display:block; padding:16px 14px; margin:0 0 14px; font-weight:800; border-radius:16px;
  background:color-mix(in oklab,var(--bg),#fff 2%); border:1px solid var(--line);
}
.menu.open{transform:none}
.menu-backdrop{
  position:fixed; inset:0; background:rgba(15,15,16,.55); backdrop-filter:blur(4px);
  opacity:0; pointer-events:none; transition:opacity .25s; z-index:8000;
}
.menu-backdrop.show{opacity:1; pointer-events:auto}
body.menu-open{overflow:hidden}

/* ========== Pages & Sections ========== */
main{padding:28px 0 80px}
.page{display:none}
.page.active{display:block}
.section{background:linear-gradient(180deg,color-mix(in oklab,var(--bg),#fff 6%),color-mix(in oklab,var(--bg),#000 1%)); border:1px solid var(--line);
  border-radius:var(--radius); box-shadow:var(--shadow); padding:22px; margin:16px 0}
.section-head{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;margin-bottom:14px}
.pill{display:inline-block;padding:8px 14px;border-radius:999px;background:color-mix(in oklab,var(--brand),#fff 80%);color:#000;font-weight:900}
.hero{display:grid;grid-template-columns:1.2fr .8fr;gap:22px;align-items:center}
@media(max-width:900px){.hero{grid-template-columns:1fr}}
.hero-visual{border-radius:24px;overflow:hidden;box-shadow:var(--shadow-strong);background:radial-gradient(1200px 500px at 80% 20%, rgba(255,127,80,.22), transparent 40%), #0b0c0d}
.hero-logo{width:100%;height:auto;border-radius:24px}

/* Buttons & Inputs */
.btn{display:inline-grid;place-items:center;height:46px;padding:0 18px;border-radius:14px;font-weight:900;border:1.5px solid #000;background:var(--brand);color:var(--brand-ink);cursor:pointer}
.btn.secondary{background:transparent;border-color:var(--line);color:var(--ink)}
.btn.ghost{background:transparent;border-color:transparent;color:var(--ink)}
.input, select, textarea{width:100%;height:44px;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:transparent;color:inherit}
textarea{height:120px;resize:vertical}
.inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:14px}
.g2{grid-template-columns:repeat(2,1fr)}
.g3{grid-template-columns:repeat(3,1fr)}
@media(max-width:900px){ .g2,.g3{grid-template-columns:1fr} }
.badge{padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px}
.kv{display:grid;grid-template-columns:120px 1fr;gap:6px;margin:6px 0}
hr.sep{border:none;height:1px;background:var(--line);margin:16px 0}

/* Carousel */
.hwrap{position:relative}
.hscroll{display:grid;grid-auto-flow:column;grid-auto-columns:min(88vw,340px);gap:16px;overflow-x:auto;scroll-snap-type:x mandatory;padding:6px 4px}
.hscroll::-webkit-scrollbar{height:8px}.hscroll::-webkit-scrollbar-thumb{background:#444;border-radius:99px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px;scroll-snap-align:start}
.card img.cover{width:100%;height:220px;object-fit:cover;border-radius:12px;}

/* Modal */
.modal{position:fixed;inset:0;display:none;place-items:center;z-index:7000}
.modal.show{display:grid}
.modal .sheet{width:min(680px,92vw);max-height:86vh;overflow:auto;background:var(--bg);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow-strong);padding:18px}

/* FAB */
.fab{position:fixed;right:16px;bottom:18px;display:grid;gap:12px;z-index:6000}
.fab button{
  width:78px;height:78px;border-radius:50%;border:none;cursor:pointer;
  background: radial-gradient(120% 120% at 30% 20%, #ffa77f 0%, #ff7f50 60%, #e56538 100%);
  color:#111;font-weight:900;box-shadow:var(--shadow-strong);transition:transform .15s var(--ease),opacity .15s;
}
.fab button:active{transform:scale(.98)}
.fab.hidden{opacity:.2;pointer-events:none}

/* Leaflet over z-index fix */
.leaflet-container{z-index:0;border-radius:16px;overflow:hidden;border:1px solid var(--line);}

/* Misc */
.notice{padding:10px 12px;border:1px dashed var(--line);border-radius:12px;color:var(--muted)}
.footer{padding:28px 0 64px;color:var(--muted);text-align:left}
.nowrap{white-space:nowrap}

/* Prevent overlay bleed when menu is open */
body.menu-open #kioskMap{filter:blur(1px);pointer-events:none}
body.menu-open .fab{pointer-events:none;opacity:.4}

/* Avatar list / chips */
.cat-strip{display:grid;grid-auto-flow:column;grid-auto-columns:220px;gap:12px;overflow-x:auto;padding-bottom:6px}
.cat-card{display:grid;grid-template-columns:64px 1fr;gap:10px;align-items:center;border:1px solid var(--line);border-radius:14px;padding:10px;background:var(--card)}
.cat-card img{width:64px;height:64px;border-radius:14px;object-fit:cover}

/* Photo wall */
.wall{columns:2;column-gap:12px}
@media(min-width:760px){.wall{columns:3}}
.wall .ph{break-inside:avoid;margin-bottom:12px;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#000}
.wall .ph img, .wall .ph video{width:100%;display:block}
.ph-bar{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:color-mix(in oklab,var(--bg),#fff 3%)}
.ph-acts{display:flex;gap:8px}
.ph-acts button{height:32px;padding:0 10px;border-radius:999px;border:1px solid var(--line);background:transparent;color:inherit;cursor:pointer}
.toggle{display:inline-flex;align-items:center;gap:6px}
.toggle input{accent-color:var(--brand)}
/* Title keep in one line on mobile */
h2{line-height:1.15}
h2.nowrap{white-space:nowrap}
</style>
</head>
<body>

<header>
  <div class="container navbar">
    <div class="brand">
      <div class="brand-logo"><img src="./logo/logo-192.png" alt="logo"></div>
      <div>PurrGo 喵來速</div>
    </div>

    <nav class="nav-links" id="desktopNav">
      <a data-go="home" class="active">首頁</a>
      <a data-go="products">產品</a>
      <a data-go="guild">公會</a>
      <a data-go="kiosk">據點</a>
      <a data-go="community">照片牆</a>
      <a data-go="social">社群</a>
      <a data-go="chat">聊天</a>
      <a data-go="shorts">短影片</a>
      <a data-go="about">理念</a>
      <a data-go="contact">聯絡</a>
    </nav>

    <button class="menu-toggle" id="menuBtn" aria-label="開啟選單"><span class="menu-ico"><span></span></span></button>
  </div>

  <!-- Drawer -->
  <div class="menu-backdrop" id="menuBackdrop"></div>
  <nav class="menu" id="menu">
    <a href="#home"      data-go="home">首頁</a>
    <a href="#products"  data-go="products">產品</a>
    <a href="#guild"     data-go="guild">公會</a>
    <a href="#kiosk"     data-go="kiosk">據點</a>
    <a href="#community" data-go="community">照片牆</a>
    <a href="#social"    data-go="social">社群</a>
    <a href="#chat"      data-go="chat">聊天</a>
    <a href="#shorts"    data-go="shorts">短影片</a>
    <a href="#about"     data-go="about">理念</a>
    <a href="#contact"   data-go="contact">聯絡</a>
  </nav>
</header>

<main class="container">

  <!-- ========== Home ========== -->
  <section id="page-home" class="page active">
    <div class="section hero">
      <div>
        <span class="pill">PurrGo 喵來速</span>
        <h1 class="nowrap">便利 × 可愛 × 永續 × 共創</h1>
        <p class="muted">用創新配送 + 公會制度，讓補給更聰明、更便宜、更好玩。把「買貓砂」變成有成就感的里程碑遊戲。</p>
        <div class="inline">
          <button class="btn" data-go="products">開始探索產品</button>
          <button class="btn secondary" data-go="guild">加入貓奴公會</button>
          <button class="btn ghost" data-go="about">了解品牌理念</button>
        </div>
      </div>
      <div class="hero-visual">
        <img class="hero-logo" src="./img/000/tofu-adult.jpg" alt="Hero artwork">
      </div>
    </div>

    <div class="section">
      <div class="section-head"><h2 class="nowrap">建立主子角色</h2><span class="badge">不限數量</span></div>
      <form id="catForm" class="grid g2">
        <label class="kv"><b>暱稱</b><input class="input" name="name" required></label>
        <label class="kv"><b>性別</b>
          <select class="input" name="sex">
            <option>公</option><option>母</option><option>未知</option>
          </select>
        </label>
        <label class="kv"><b>生日</b><input class="input" name="birthday" type="date" required></label>
        <label class="kv"><b>品種</b>
          <select class="input" name="breed" id="breedSel"><option value="">讀取中…</option></select>
        </label>
        <label class="kv g2"><b>大頭照</b><input class="input" name="avatar" type="file" accept="image/*"></label>
        <div class="inline"><button class="btn" type="submit">新增主子</button></div>
      </form>
      <div id="catStrip" class="cat-strip mt-1"></div>
    </div>
  </section>

  <!-- ========== Products ========== -->
  <section id="page-products" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Products</span><h2 class="nowrap">熱銷與方案</h2></div></div>
      <p class="muted">橫向滑動卡片，支援產品照片、詳情彈窗與加入購物車。</p>

      <div class="hwrap">
        <div id="productRow" class="hscroll"></div>
      </div>

      <div class="section mt-2">
        <h3 class="mt-0">購物車（示範）</h3>
        <div id="cartList" class="muted">尚無商品</div>
        <div class="inline mt-1">
          <button class="btn" id="checkoutBtn">結帳（示範）</button>
          <button class="btn secondary" id="clearCartBtn">清空</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== Guild ========== -->
  <section id="page-guild" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Guild</span><h2 class="nowrap">公會制度：一起成長、一起更省</h2></div></div>
      <p class="muted">建立門檻、VIP 等級、貢獻條、每日任務…（Demo 版）</p>

      <div class="section">
        <h3 class="mt-0">加入 / 綁定</h3>
        <div id="guildStatus" class="notice">尚未加入公會</div>
        <div class="inline mt-1">
          <input class="input" id="bindPhone" placeholder="輸入手機（示意）" style="width:220px">
          <button class="btn" id="joinGuildBtn">加入公會</button>
        </div>
      </div>

      <div class="section">
        <h3 class="mt-0">免費貓咪健檢（每隻主子一年 1 次）</h3>
        <div class="kv">
          <b>城市</b>
          <select class="input" id="citySel"></select>
        </div>
        <div class="kv">
          <b>合作獸醫</b>
          <select class="input" id="hospitalSel"></select>
        </div>
        <div id="reportArea" class="grid g2 mt-1"></div>
      </div>
    </div>
  </section>

  <!-- ========== Kiosk ========== -->
  <section id="page-kiosk" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Kiosk</span><h2 class="nowrap">販賣機點位</h2></div></div>
      <div id="kioskMap" style="height:380px"></div>
      <p class="muted">點標記可開啟 Google/Apple Maps 導航。</p>
    </div>
  </section>

  <!-- ========== Community (Photo wall) ========== -->
  <section id="page-community" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Community</span><h2 class="nowrap">照片牆</h2></div></div>
      <div class="inline">
        <input type="file" id="photoInput" accept="image/*" multiple>
        <label class="toggle"><input type="checkbox" id="photoPublic" checked> 公開</label>
        <button class="btn secondary" id="clearWallBtn">清除（本機）</button>
      </div>
      <div id="wall" class="wall mt-1"></div>
    </div>
  </section>

  <!-- ========== Social / Friends ========== -->
  <section id="page-social" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Social</span><h2 class="nowrap">社群（Demo）</h2></div></div>
      <div class="grid g2">
        <div class="section">
          <h3 class="mt-0">註冊 / 登入（本機示範）</h3>
          <div class="inline">
            <input class="input" id="loginId" placeholder="設定你的社群 ID" style="width:240px">
            <button class="btn" id="loginBtn">登入</button>
          </div>
          <div id="loginState" class="notice mt-1">目前為訪客模式</div>
        </div>
        <div class="section">
          <h3 class="mt-0">新增好友</h3>
          <div class="inline">
            <input class="input" id="friendId" placeholder="輸入對方 ID" style="width:240px">
            <button class="btn secondary" id="addFriendBtn">新增</button>
          </div>
          <div id="friendList" class="mt-1 muted">尚無好友</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== Chat ========== -->
  <section id="page-chat" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Chat</span><h2 class="nowrap">聊天（Demo，本機）</h2></div></div>
      <div class="grid g2">
        <div class="section">
          <h3 class="mt-0">選擇好友</h3>
          <div id="chatPeers" class="muted">請先至「社群」新增好友</div>
        </div>
        <div class="section">
          <h3 class="mt-0">訊息</h3>
          <div id="chatThread" class="notice" style="height:220px;overflow:auto">尚未選擇好友</div>
          <div class="inline mt-1">
            <input class="input" id="chatText" placeholder="輸入訊息">
            <button class="btn" id="sendMsgBtn">送出</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== Shorts ========== -->
  <section id="page-shorts" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Shorts</span><h2 class="nowrap">短影片（Demo）</h2></div></div>
      <div class="inline">
        <input type="file" accept="video/*" id="shortInput" multiple>
        <span class="muted">建議 30 秒內，示範僅於本機瀏覽。</span>
      </div>
      <div id="shortList" class="wall mt-1"></div>
    </div>
  </section>

  <!-- ========== About ========== -->
  <section id="page-about" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">About</span><h2 class="nowrap">我們的理念</h2></div></div>
      <p>便利 × 可愛 × 永續 × 共創。用科技與社群，把日常補給變成好玩又有成就的參與。</p>
    </div>
  </section>

  <!-- ========== Contact ========== -->
  <section id="page-contact" class="page">
    <div class="section">
      <div class="section-head"><div><span class="pill">Contact</span><h2 class="nowrap">聯絡我們</h2></div></div>
      <form id="contactForm" class="grid g2">
        <label class="kv"><b>稱呼</b><input class="input" required></label>
        <label class="kv"><b>Email</b><input class="input" type="email" required></label>
        <label class="kv g2"><b>訊息</b><textarea class="input" required></textarea></label>
        <div class="inline"><button class="btn" type="submit">送出</button></div>
      </form>
      <p class="muted mt-1">也可來信：<a href="mailto:hello@purrgo.tw">hello@purrgo.tw</a></p>
    </div>
  </section>

</main>

<footer class="container footer">© PurrGo 喵來速 ｜ 公開 Demo（不含投資人資訊）</footer>

<!-- Product Modal -->
<div id="productModal" class="modal" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="inline" style="justify-content:space-between">
      <h3 id="pmTitle" class="mt-0">商品詳情</h3>
      <button class="btn secondary" id="pmClose">關閉</button>
    </div>
    <img id="pmImg" class="cover" src="" alt="" style="height:280px;margin-bottom:10px;object-fit:cover;border-radius:12px">
    <div id="pmBody" class="muted"></div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

<script>
/* =========================================================
   State & Helpers (LocalStorage Demo)
========================================================= */
const LS = {
  load:(k,def)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
  save:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};
const S = LS.load('purrgoState',{
  user:{ id:"guest-"+Math.random().toString(36).slice(2,7), guild:false },
  cats:[],
  products:[],
  cart:[],
  photos:[],   // {src, public, likes, comments:[]}
  friends:[],  // ids
  chats:{},    // { peerId: [ {from,text,time} ] }
  shorts:[]
});

/* Router */
const PAGES = ["home","products","guild","kiosk","community","social","chat","shorts","about","contact"];
function go(page){
  PAGES.forEach(p=>document.getElementById("page-"+p).classList.toggle("active", p===page));
  [...document.querySelectorAll('.nav-links a')].forEach(a=>a.classList.toggle('active', a.dataset.go===page));
  history.replaceState({}, "", "#"+page);
  // 收起 drawer
  closeMenu();
  // lazy init
  if(page==="kiosk" && !window._mapInited) initMap();
}
function current(){ return (location.hash||"#home").replace("#","") }
function bindNav(){
  document.getElementById('desktopNav').addEventListener('click',e=>{
    if(e.target.dataset.go) go(e.target.dataset.go);
  });
  document.getElementById('menu').addEventListener('click',e=>{
    if(e.target.dataset.go){ go(e.target.dataset.go) }
  });
  document.querySelectorAll('[data-go]').forEach(b=>b.addEventListener('click',()=>go(b.dataset.go)));
}

/* Drawer */
const menu = document.getElementById('menu');
const backdrop = document.getElementById('menuBackdrop');
const menuBtn = document.getElementById('menuBtn');
function openMenu(){ menu.classList.add('open'); backdrop.classList.add('show'); document.body.classList.add('menu-open') }
function closeMenu(){ menu.classList.remove('open'); backdrop.classList.remove('show'); document.body.classList.remove('menu-open') }
menuBtn.addEventListener('click', openMenu);
backdrop.addEventListener('click', closeMenu);
window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeMenu() });

/* FAB */
document.body.insertAdjacentHTML('beforeend', `
  <div class="fab" id="fab">
    <button data-go="home">Top</button>
    <button data-go="products">Shop</button>
    <button data-go="guild">Guild</button>
    <button data-go="kiosk">Map</button>
    <button data-go="chat">Msg</button>
  </div>
`);
document.getElementById('fab').addEventListener('click', e=>{
  if(e.target.tagName==='BUTTON' && e.target.dataset.go) go(e.target.dataset.go)
});

/* ========== Home: breeds + cats ========== */
async function loadBreeds(){
  try{
    const res = await fetch('./data/breeds.json',{cache:'no-cache'});
    const list = await res.json();
    const sel = document.getElementById('breedSel'); sel.innerHTML='';
    list.forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; sel.appendChild(o) })
  }catch{ document.getElementById('breedSel').innerHTML='<option>家貓</option>' }
}
function ageFromBirthday(iso){
  const b = new Date(iso), now=new Date();
  let y=now.getFullYear()-b.getFullYear();
  let m=now.getMonth()-b.getMonth();
  if(m<0){ y--; m+=12 }
  return `${y} 歲 ${m} 月`;
}
function renderCats(){
  const wrap = document.getElementById('catStrip'); wrap.innerHTML='';
  if(!S.cats.length) wrap.innerHTML='<div class="notice">尚未建立主子</div>';
  S.cats.forEach((c,i)=>{
    const el = document.createElement('div'); el.className='cat-card';
    el.innerHTML = `
      <img src="${c.avatar||'./logo/logo-192.png'}" alt="">
      <div>
        <div><b>${c.name}</b>｜${c.breed||'家貓'}</div>
        <div class="muted">${c.sex}｜${ageFromBirthday(c.birthday)}</div>
        <div class="inline mt-1">
          <button class="btn secondary" data-edit="${i}">編輯</button>
          <button class="btn secondary" data-del="${i}">刪除</button>
        </div>
      </div>`;
    wrap.appendChild(el);
  });
}
document.getElementById('catForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const obj = Object.fromEntries(fd.entries());
  if(fd.get('avatar')?.size){
    obj.avatar = await fileToDataURL(fd.get('avatar'));
  }
  S.cats.push(obj); LS.save('purrgoState',S); e.target.reset(); renderCats(); seedFirstAvatarToWall();
});
document.getElementById('catStrip').addEventListener('click', async e=>{
  const i = e.target.dataset.edit ?? e.target.dataset.del;
  if(i==null) return;
  if(e.target.dataset.del!=null){
    if(confirm('確定刪除此主子？')){ S.cats.splice(Number(i),1); LS.save('purrgoState',S); renderCats(); renderReportArea(); }
    return;
  }
  // 編輯
  const c = S.cats[i];
  const name = prompt('主子暱稱', c.name); if(name==null) return;
  const sex = prompt('性別（公/母/未知）', c.sex) ?? c.sex;
  const birthday = prompt('生日（YYYY-MM-DD）', c.birthday) ?? c.birthday;
  const breed = prompt('品種', c.breed) ?? c.breed;
  S.cats[i] = {...c, name, sex, birthday, breed};
  LS.save('purrgoState',S); renderCats(); renderReportArea();
});
async function fileToDataURL(file){ return new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(file) })}

/* 把第一張主子頭貼自動帶入照片牆一次（若牆上還沒有） */
function seedFirstAvatarToWall(){
  if(!S.photos.length && S.cats[0]?.avatar){
    S.photos.push({src:S.cats[0].avatar, public:true, likes:0, comments:[]});
    LS.save('purrgoState',S); renderWall();
  }
}

/* ========== Products ========== */
async function loadProducts(){
  try{
    const res = await fetch('./data/products.json',{cache:'no-cache'});
    S.products = await res.json();
  }catch{
    S.products = [
      {id:1, name:'幼貓專用豆腐砂', spec:'2.5kg / 低粉塵', price:220, bullets:['高纖低塵','瞬吸結團'], img:'./img/tofu-young.jpg', detail:'幼貓配方示意'},
      {id:2, name:'成貓日常豆腐砂', spec:'2.5kg / 強效除臭', price:200, bullets:['活性炭除臭','結團強'], img:'./img/tofu-adult.jpg', detail:'成貓配方示意'},
      {id:3, name:'熟齡關節豆腐砂', spec:'2.5kg / 溫和', price:240, bullets:['抑味加強','溫和不刺激'], img:'./img/tofu-senior.jpg', detail:'熟齡配方示意'},
    ];
  }
  renderProducts();
}
function renderProducts(){
  const row = document.getElementById('productRow'); row.innerHTML='';
  S.products.forEach(p=>{
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      <img class="cover" src="${p.img||'./img/000/tofu-adult.jpg'}" alt="">
      <h3 class="mt-1">${p.name}</h3>
      <div class="muted">${p.spec||''}</div>
      <div class="mt-1"><b>NT$ ${Number(p.price||0).toLocaleString()}</b></div>
      <ul style="margin:10px 0 0 18px">${(p.bullets||[]).map(b=>`<li>${b}</li>`).join('')}</ul>
      <div class="inline mt-1">
        <button class="btn" data-add="${p.id}">加入購物車</button>
        <button class="btn secondary" data-detail="${p.id}">查看詳情</button>
      </div>`;
    row.appendChild(el);
  });
}
document.getElementById('productRow').addEventListener('click', e=>{
  const id = e.target.dataset.add ?? e.target.dataset.detail;
  if(!id) return;
  const p = S.products.find(x=>x.id==id);
  if(e.target.dataset.add){
    S.cart.push({id:p.id, name:p.name, price:p.price}); LS.save('purrgoState',S); renderCart();
  }else{
    openProductModal(p);
  }
});
function renderCart(){
  const box=document.getElementById('cartList');
  if(!S.cart.length){ box.textContent='尚無商品'; return }
  box.innerHTML = S.cart.map((c,i)=>`<div class="inline" style="justify-content:space-between;border-bottom:1px solid var(--line);padding:8px 0">
    <div>${c.name}</div><div>NT$ ${c.price}</div><button class="btn secondary" data-rm="${i}">移除</button></div>`).join('');
}
document.getElementById('cartList').addEventListener('click',e=>{
  if(e.target.dataset.rm){ S.cart.splice(Number(e.target.dataset.rm),1); LS.save('purrgoState',S); renderCart() }
});
document.getElementById('checkoutBtn').addEventListener('click',()=>alert('示範：送出訂單（未串金流）'));
document.getElementById('clearCartBtn').addEventListener('click',()=>{ S.cart=[]; LS.save('purrgoState',S); renderCart() });
function openProductModal(p){
  document.getElementById('pmTitle').textContent = p.name;
  document.getElementById('pmImg').src = p.img||'./img/000/tofu-adult.jpg';
  document.getElementById('pmBody').innerHTML = `
    <div class="muted">${p.spec||''}</div><hr class="sep">
    <div>售價：<b>NT$ ${p.price}</b></div>
    <ul style="margin:10px 0 0 18px">${(p.bullets||[]).map(b=>`<li>${b}</li>`).join('')}</ul>`;
  document.getElementById('productModal').classList.add('show');
}
document.getElementById('pmClose').addEventListener('click',()=>document.getElementById('productModal').classList.remove('show'));
document.getElementById('productModal').addEventListener('click',e=>{ if(e.target.id==='productModal') e.currentTarget.classList.remove('show') });

/* ========== Guild / Hospitals / Reports ========== */
async function loadHospitals(){
  try{
    const res = await fetch('./data/hospitals.json',{cache:'no-cache'});
    const all = await res.json(); // {city:[{name,lat,lng}]}
    const citySel = document.getElementById('citySel');
    const hospSel = document.getElementById('hospitalSel');
    citySel.innerHTML = Object.keys(all).map(c=>`<option>${c}</option>`).join('');
    function fill(){ hospSel.innerHTML = (all[citySel.value]||[]).map(h=>`<option>${h.name}</option>`).join('') }
    citySel.onchange = fill; fill();
  }catch{
    document.getElementById('citySel').innerHTML='<option>台北</option><option>台中</option><option>高雄</option>';
    document.getElementById('hospitalSel').innerHTML='<option>示範動物醫院</option>';
  }
}
function renderGuild(){
  document.getElementById('guildStatus').textContent = S.user.guild ? `已加入公會（ID: ${S.user.id}）` : '尚未加入公會';
}
document.getElementById('joinGuildBtn').addEventListener('click',()=>{
  if(!document.getElementById('bindPhone').value) return alert('請輸入手機（示意）');
  S.user.guild = true; LS.save('purrgoState',S); renderGuild(); renderReportArea();
});
function renderReportArea(){
  const area = document.getElementById('reportArea'); if(!area) return;
  area.innerHTML='';
  if(!S.user.guild){ area.innerHTML='<div class="notice">請先加入公會後方可上傳健檢報告。</div>'; return }
  if(!S.cats.length){ area.innerHTML='<div class="notice">請先在首頁建立主子。</div>'; return }
  S.cats.forEach((c,idx)=>{
    const uploaded = c.report?.year === (new Date()).getFullYear();
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      <div class="inline" style="justify-content:space-between">
        <h4 class="mt-0">${c.name}｜${ageFromBirthday(c.birthday)}</h4>
        <span class="badge">${uploaded?'已上傳':''}</span>
      </div>
      <div class="muted">項目：血檢</div>
      <div class="inline mt-1">
        <input type="file" accept="image/*,application/pdf" ${uploaded?'disabled':''} id="r${idx}">
        <button class="btn" ${uploaded?'disabled':''} data-report="${idx}">上傳報告</button>
      </div>`;
    area.appendChild(el);
  });
}
document.getElementById('reportArea')?.addEventListener('click', async e=>{
  const i = e.target.dataset.report; if(i==null) return;
  const inp = document.getElementById('r'+i);
  if(!inp.files?.length) return alert('請選擇檔案');
  S.cats[i].report = { year:(new Date()).getFullYear(), time:Date.now() };
  LS.save('purrgoState',S); renderReportArea(); alert('上傳完成！已登錄公會貢獻（示意）');
});

/* ========== Kiosk Map ========== */
async function initMap(){
  window._mapInited = true;
  const map = L.map('kioskMap',{scrollWheelZoom:false}).setView([25.033,121.5654],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);
  try{
    const res = await fetch('./data/locations.json',{cache:'no-cache'});
    const pts = await res.json();
    pts.forEach(p=>{
      const m = L.marker([p.lat,p.lng]).addTo(map);
      const g = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
      const a = `https://maps.apple.com/?q=${p.lat},${p.lng}`;
      m.bindPopup(`<b>${p.name}</b><br>${p.address||''}<br><a target=_blank href="${g}">Google Maps</a> ｜ <a target=_blank href="${a}">Apple Maps</a>`);
    })
  }catch{
    L.marker([25.033,121.5654]).addTo(map).bindPopup('示範位置');
  }
}

/* ========== Photo Wall ========== */
function renderWall(){
  const wall=document.getElementById('wall'); if(!wall) return; wall.innerHTML='';
  S.photos.forEach((p,idx)=>{
    const el = document.createElement('div'); el.className='ph';
    el.innerHTML = `
      <img src="${p.src}" alt="">
      <div class="ph-bar">
        <div class="toggle"><input type="checkbox" ${p.public?'checked':''} data-pub="${idx}"><span>${p.public?'公開':'私人'}</span></div>
        <div class="ph-acts">
          <button data-like="${idx}">🐾 ${p.likes||0}</button>
          <button data-cmt="${idx}">留言</button>
          <button data-delphoto="${idx}">刪除</button>
        </div>
      </div>
      <div style="padding:8px 10px"><div class="muted">${(p.comments||[]).map(c=>`<div>💬 ${c}</div>`).join('')}</div></div>`;
    wall.appendChild(el);
  });
}
document.getElementById('photoInput')?.addEventListener('change', async e=>{
  for(const f of e.target.files){
    const src = await fileToDataURL(f);
    S.photos.unshift({src, public:document.getElementById('photoPublic').checked, likes:0, comments:[]});
  }
  LS.save('purrgoState',S); renderWall();
});
document.getElementById('wall')?.addEventListener('click', e=>{
  if(e.target.dataset.like){ const i=e.target.dataset.like; S.photos[i].likes=(S.photos[i].likes||0)+1; LS.save('purrgoState',S); renderWall(); }
  if(e.target.dataset.cmt){ const i=e.target.dataset.cmt; const t=prompt('留下你的留言'); if(t){ (S.photos[i].comments??=[]).push(t); LS.save('purrgoState',S); renderWall(); } }
  if(e.target.dataset.delphoto){ const i=e.target.dataset.delphoto; if(confirm('刪除此照片？')){ S.photos.splice(i,1); LS.save('purrgoState',S); renderWall(); } }
});
document.getElementById('wall')?.addEventListener('change', e=>{
  if(e.target.dataset.pub){ const i=e.target.dataset.pub; S.photos[i].public = e.target.checked; LS.save('purrgoState',S); renderWall(); }
});
document.getElementById('clearWallBtn')?.addEventListener('click',()=>{ if(confirm('清除所有照片（本機）？')){ S.photos=[]; LS.save('purrgoState',S); renderWall(); }});

/* ========== Social / Chat ========== */
function renderLogin(){ document.getElementById('loginState').textContent = S.user?.id ? `目前登入：${S.user.id}` : '目前為訪客模式'; }
document.getElementById('loginBtn')?.addEventListener('click',()=>{
  const id = document.getElementById('loginId').value?.trim(); if(!id) return alert('請輸入 ID');
  S.user.id = id; LS.save('purrgoState',S); renderLogin(); renderFriends();
});
document.getElementById('addFriendBtn')?.addEventListener('click',()=>{
  const id = document.getElementById('friendId').value?.trim(); if(!id) return;
  if(!S.friends.includes(id)) S.friends.push(id);
  LS.save('purrgoState',S); renderFriends(); renderPeers();
});
function renderFriends(){
  const box = document.getElementById('friendList'); if(!box) return;
  box.innerHTML = S.friends.length ? S.friends.map(i=>`<span class="badge">${i}</span>`).join(' ') : '尚無好友';
}
function renderPeers(){
  const box = document.getElementById('chatPeers'); if(!box) return;
  box.innerHTML = S.friends.length ? S.friends.map(i=>`<button class="btn secondary" data-peer="${i}">${i}</button>`).join(' ') : '請先至「社群」新增好友';
}
let CUR_PEER=null;
document.getElementById('chatPeers')?.addEventListener('click',e=>{
  if(e.target.dataset.peer){ CUR_PEER=e.target.dataset.peer; renderThread() }
});
function renderThread(){
  const box = document.getElementById('chatThread'); if(!box) return;
  const list = S.chats[CUR_PEER]||[]; box.innerHTML = list.map(m=>`<div style="margin:6px 0"><b>${m.from}：</b>${m.text}</div>`).join('') || '尚無訊息';
}
document.getElementById('sendMsgBtn')?.addEventListener('click',()=>{
  if(!CUR_PEER) return alert('請先選擇好友');
  const t = document.getElementById('chatText').value.trim(); if(!t) return;
  (S.chats[CUR_PEER]??=[]).push({from:S.user.id,text:t,time:Date.now()});
  LS.save('purrgoState',S); document.getElementById('chatText').value=''; renderThread();
});

/* ========== Shorts ========== */
document.getElementById('shortInput')?.addEventListener('change', async e=>{
  for(const f of e.target.files){
    const url = await fileToDataURL(f);
    S.shorts.unshift({src:url});
  }
  LS.save('purrgoState',S); renderShorts();
});
function renderShorts(){
  const wall=document.getElementById('shortList'); if(!wall) return; wall.innerHTML='';
  S.shorts.forEach(v=>{
    const el=document.createElement('div'); el.className='ph';
    el.innerHTML=`<video src="${v.src}" controls muted playsinline></video>`;
    wall.appendChild(el);
  });
}

/* =========================================================
   Boot
========================================================= */
function boot(){
  bindNav();
  go(PAGES.includes(current())? current() : 'home');
  loadBreeds(); renderCats(); seedFirstAvatarToWall();
  loadProducts(); renderCart();
  loadHospitals(); renderGuild(); renderReportArea();
  renderWall(); renderLogin(); renderFriends(); renderPeers(); renderShorts();
}
boot();

/* Service Worker（可留可刪） */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}) }
</script>
</body>
</html>
