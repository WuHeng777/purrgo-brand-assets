<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>PurrGo 喵來速</title>
<link rel="icon" href="./logo/favicon.png" />

<!-- ===== 覆寫樣式：整站配色 + 導覽 + 登入卡 + IG相簿 + 聊天輸入列 等 ===== -->
<style>
:root{
  --bg:#0f1011; --bg-2:#151618; --card:#131416; --text:#eaeaea; --muted:#9aa0a6;
  --brand:#ff7f50; --chip:#ffe0d3; --chip-text:#2b2b2b;
  --stroke:#222428; --stroke-2:#1d1f22;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,system-ui,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;line-height:1.65}
a{color:inherit;text-decoration:none}
.container{max-width:1120px;margin:0 auto;padding:0 16px}
.section{padding:22px 0 44px}
.card{background:radial-gradient(130% 120% at 100% 0%,#1a1b1e 0%,#111214 60%);border-radius:18px;padding:22px;border:1px solid var(--stroke-2)}
.pill{display:inline-block;background:var(--chip);color:var(--chip-text);padding:8px 14px;border-radius:999px;font-weight:800}
h1,h2,h3{margin:.2rem 0 1rem}
.section-caption{font-size:.95rem;color:var(--muted);margin:8px 0 18px}

/* ==== Header ==== */
header{position:sticky;top:0;z-index:80;background:linear-gradient(#0f1011cc,#0f1011cc)}
.nav{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
.brand{display:flex;align-items:center;gap:10px}
.brand img{width:34px;height:34px;border-radius:8px}
.brand b{letter-spacing:.02em}
.user-pill{display:flex;align-items:center;gap:10px;border:1px solid var(--stroke);border-radius:20px;padding:6px 10px 6px 14px;background:#191b1e}
.user-pill .name{min-width:4em;white-space:nowrap}
.user-pill .divider{opacity:.25}
.user-pill button{height:34px;min-width:54px;border:0;border-radius:12px;padding:0 12px;background:#26282b;color:#eaeaea;font-weight:700}
.menu-toggle{width:48px;height:48px;border-radius:14px;background:#232427;border:0;display:grid;place-items:center}
.menu-ico,.menu-ico::before,.menu-ico::after{content:"";display:block;width:22px;height:2px;background:#fff;border-radius:2px;position:relative}
.menu-ico::before{position:absolute;top:-6px}
.menu-ico::after{position:absolute;top:6px}

/* ==== Drawer Menu ==== */
.menu{position:fixed;inset:0 0 0 auto;width:min(86vw,360px);transform:translateX(100%);transition:transform .25s ease;background:#0c0d0f;z-index:120;padding:16px;border-left:1px solid var(--stroke)}
.menu.open{transform:none}
.menu a{display:block;padding:16px;border-radius:16px;background:#17181b;border:1px solid var(--stroke);margin:10px 0}
.menu-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .2s;z-index:110}
.menu-backdrop.show{opacity:1;pointer-events:auto}

/* ==== Hero ==== */
.hero{display:grid;grid-template-columns:1.25fr .9fr;gap:16px;align-items:center}
.hero h1{font-size:clamp(24px,5.6vw,40px);line-height:1.25}
.hero-buttons .btn{margin-right:10px;margin-bottom:10px}
.hero-visual{display:flex;align-items:center;justify-content:center}
.hero-logo{width:min(56vw,260px);aspect-ratio:1/1;border-radius:22px;object-fit:cover;box-shadow:0 10px 24px rgba(0,0,0,.35)}

/* ==== Common inputs/buttons ==== */
.input,select.input,textarea.input{width:100%;padding:14px;border-radius:12px;border:1px solid var(--stroke);background:#0f1113;color:var(--text)}
.btn{background:var(--brand);color:#191919;border:0;border-radius:14px;padding:12px 16px;font-weight:900}
.btn.secondary{background:#26282b;color:#ddd;border:1px solid var(--stroke)}
.btn.ghost{background:transparent;border:1px dashed var(--stroke);color:#aeb4ba}
.inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.grid{display:grid}
.g-2{grid-template-columns:repeat(2,1fr);gap:14px}
@media (max-width:900px){.hero{grid-template-columns:1fr}.g-2{grid-template-columns:1fr}}

.empty{padding:22px;border:1px dashed var(--stroke);border-radius:14px;text-align:center;color:var(--muted)}

/* ==== Product list ==== */
.hscroll{display:flex;gap:14px;overflow:auto;scroll-snap-type:x mandatory;padding:2px 2px 10px}
.product{min-width:280px;scroll-snap-align:start}
.prod-img{width:100%;height:190px;object-fit:cover;border-radius:14px;border:1px solid var(--stroke)}

/* ==== Pets ==== */
.pets{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
.p-card{display:flex;gap:12px;align-items:center;background:#17181b;border:1px solid var(--stroke);border-radius:14px;padding:10px}
.p-avatar{width:60px;height:60px;border-radius:14px;object-fit:cover;background:#0f1011}

/* ==== Photos (IG grid) ==== */
.ig-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.ig-grid .ig{position:relative;aspect-ratio:1/1;border-radius:10px;overflow:hidden;border:1px solid var(--stroke)}
.ig-grid img{width:100%;height:100%;object-fit:cover;display:block}
.ig-grid .count{position:absolute;right:6px;bottom:6px;background:#000a;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px}

/* Photo Modal */
dialog{border:0;padding:0;background:transparent}
dialog::backdrop{background:rgba(0,0,0,.55)}
.pm{background:var(--bg-2);border:1px solid var(--stroke);border-radius:20px;padding:16px;max-width:min(92vw,720px);margin:auto}
.pm img{width:100%;max-height:70vh;object-fit:contain;border-radius:14px;background:#0c0d0e}
.pm .row{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}

/* ==== Chat (輸入列置底 + 清除) ==== */
.chat-wrap{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:900px){.chat-wrap{grid-template-columns:1fr}}
.chatbox{height:320px;overflow:auto;border:1px solid var(--stroke);border-radius:14px;padding:10px;background:#0f1113}
.msg{padding:10px 12px;border-radius:12px;margin:6px 0;display:inline-block;max-width:88%}
.msg.me{background:#2a2b2f}.msg.other{background:#202124}
.chat-inputbar{display:flex;gap:10px;align-items:center;margin-top:10px}
.chat-inputbar input{flex:1}
.chat-inputbar .btn{height:44px;border-radius:12px}

/* ==== FAB Top ==== */
.fab{position:fixed;right:14px;bottom:16px;z-index:90}
.fab-btn{width:66px;height:66px;border-radius:50%;
  background:linear-gradient(180deg,#ff8d63,#e56d3b);border:0;color:#181818;font-weight:900;
  box-shadow:0 10px 22px rgba(0,0,0,.35)}

/* ==== Auth Dialog ==== */
#authDialog::backdrop{background:rgba(0,0,0,.55)}
.auth-outer{background:#0b0c0d;border:1px solid var(--stroke);border-radius:22px;padding:14px}
.auth-card{background:#16181b;border:1px solid var(--stroke-2);border-radius:18px;padding:18px}
.auth-title{font-size:28px;font-weight:900;margin:4px 0 16px}
@media (prefers-color-scheme: light){
  body{background:#fbfbfb;color:#222}
  .card{background:#fff;border-color:#eee}
  .user-pill{background:#f4f5f6}
  .menu{background:#fff}
  .menu a{background:#f3f4f6}
  .auth-outer{background:#f6f7f8;border-color:#e6e7ea}
  .auth-card{background:#fff;border-color:#e9e9ee}
  .auth-title{color:#111}
}

/* 小工具 */
.m-0{margin:0}.mt-1{margin-top:.5rem}.mt-2{margin-top:1rem}
.muted{color:var(--muted)}
.center{display:flex;justify-content:center;align-items:center}
hr.sep{border:0;border-top:1px dashed var(--stroke);margin:12px 0}
</style>
</head>

<body>
<header>
  <div class="container nav">
    <div class="brand">
      <img src="./logo/logo-192.png" alt="logo"/>
      <b>PurrGo 喵來速</b>
    </div>

    <!-- 訪客 / 登入（橫向） -->
    <div class="user-pill" id="userPill">
      <span class="name" id="userName">訪客</span>
      <span class="divider">|</span>
      <button id="loginBtn" type="button">登入</button>
    </div>

    <!-- 漢堡 -->
    <button class="menu-toggle" id="menuToggle" aria-label="open menu">
      <span class="menu-ico"></span>
    </button>
  </div>
</header>

<!-- Drawer -->
<div class="menu" id="menu">
  <div class="container">
    <a href="#home" data-nav>首頁</a>
    <a href="#products" data-nav>產品</a>
    <a href="#guild" data-nav>公會</a>
    <a href="#kiosk" data-nav>據點</a>
    <a href="#photos" data-nav>照片牆</a>
    <a href="#chat" data-nav>聊天</a>
    <a href="#contact" data-nav>聯絡</a>
  </div>
</div>
<div class="menu-backdrop" id="menuBackdrop"></div>

<main>
  <!-- 首頁 -->
  <section id="home" class="section">
    <div class="container">
      <div class="section-caption">首頁</div>
      <div class="card">
        <div class="hero">
          <div>
            <span class="pill">PurrGo 喵來速</span>
            <h1>便利 × 可愛 × 永續 × 共創</h1>
            <p class="muted">用創新配送＋公會制度，讓補給更聰明、更便宜、更好玩。把「買貓砂」變成有成就感的里程碑遊戲。</p>
            <div class="hero-buttons">
              <a class="btn" href="#products">開始探索產品</a>
              <a class="btn secondary" href="#guild">加入貓奴公會</a>
              <a class="btn ghost" href="#concept">了解品牌理念</a>
            </div>
          </div>
          <div class="hero-visual"><img class="hero-logo" src="./logo/logo-512.png" alt="logo square"/></div>
        </div>
      </div>

      <!-- 建立主子 -->
      <div class="card mt-2">
        <span class="pill">主子</span>
        <h2>建立主子角色</h2>
        <div class="grid g-2">
          <div>
            <label>暱稱</label>
            <input id="petName" class="input" placeholder="例如：夯夯"/>
          </div>
          <div>
            <label>性別</label>
            <select id="petGender" class="input">
              <option value="公">公</option><option value="母">母</option>
            </select>
          </div>
          <div>
            <label>生日</label>
            <input id="petBirth" class="input" type="date"/>
          </div>
          <div>
            <label>品種</label>
            <select id="petBreed" class="input">
              <option>美國短毛貓</option><option>英國短毛貓</option>
              <option>米克斯</option><option>其他</option>
            </select>
          </div>
          <div class="g-2">
            <label>大頭照</label>
            <input id="petAvatar" class="input" type="file" accept="image/*"/>
          </div>
        </div>
        <div class="mt-2"><button class="btn" id="addPetBtn">新增主子</button></div>
        <hr class="sep" />
        <div id="petList" class="pets"><div class="empty">尚未建立主子</div></div>
      </div>
    </div>
  </section>

  <!-- 產品 -->
  <section id="products" class="section">
    <div class="container">
      <div class="section-caption">Products</div>
      <div class="card">
        <h2>產品</h2>
        <div class="hscroll" id="prodList"></div>
      </div>

      <div class="card mt-2">
        <h3>購物車（示範）</h3>
        <div id="cartBox" class="empty">尚無商品</div>
        <div class="inline mt-1">
          <button class="btn" id="checkoutBtn">結帳（示範）</button>
          <button class="btn secondary" id="clearCartBtn">清空</button>
        </div>
      </div>
    </div>
  </section>

  <!-- 公會 / VIP -->
  <section id="guild" class="section">
    <div class="container">
      <div class="section-caption">Guild</div>
      <div class="card">
        <h2>公會制度：一起成長、一起更省</h2>

        <div class="grid g-2">
          <div>
            <h3>身份綁定 / VIP</h3>
            <label>輸入手機號碼</label>
            <input id="vipPhone" class="input" placeholder="09xxxxxxxx"/>
            <div class="inline mt-1">
              <button class="btn" id="bindPhoneBtn">綁定手機（示意）</button>
              <button class="btn" id="checkinBtn">每日簽到 + 能量 / XP</button>
            </div>
            <p class="muted mt-1" id="vipInfo">累積消費：$0｜VIP 等級：V0｜下一級還差：$200</p>
          </div>

          <div>
            <h3>創立門檻</h3>
            <div class="inline">
              <input id="guildName" class="input" placeholder="你的公會名稱"/>
              <button class="btn" id="createGuildBtn">建立公會</button>
            </div>
            <p class="muted" id="guildInfo">公會：（尚未創立）</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 據點：簡化占位（避免地圖覆蓋抽屜） -->
  <section id="kiosk" class="section">
    <div class="container">
      <div class="section-caption">Kiosk</div>
      <div class="card">
        <h2>販賣機據點</h2>
        <div class="empty">地圖功能暫以佔位容器示意（避免與抽屜重疊問題）。</div>
      </div>
    </div>
  </section>

  <!-- 照片牆 -->
  <section id="photos" class="section">
    <div class="container">
      <div class="section-caption">Photos</div>
      <div class="card">
        <h2>照片牆（依主子分相簿）</h2>
        <div class="grid g-2">
          <div>
            <label>主子</label>
            <select id="photoPet" class="input"></select>
          </div>
          <div>
            <label>上傳本機照片</label>
            <input id="photoInput" class="input" type="file" accept="image/*" multiple />
          </div>
        </div>
        <div id="igGrid" class="ig-grid mt-2"></div>
      </div>
    </div>
  </section>

  <!-- Chat -->
  <section id="chat" class="section">
    <div class="container">
      <div class="section-caption">Chat</div>
      <div class="card">
        <h2>私訊聊天（示範）</h2>

        <div class="chat-wrap">
          <div>
            <label>選擇好友</label>
            <select id="friend" class="input">
              <option>小橘</option><option>小黑</option><option>貓掌</option>
            </select>

            <div id="chatBox" class="chatbox mt-1"></div>

            <div class="chat-inputbar">
              <input id="chatInput" class="input" placeholder="輸入訊息..." />
              <button id="sendBtn" class="btn">送出</button>
              <button id="clearTypingBtn" class="btn secondary">清除</button>
            </div>
          </div>

          <div>
            <p class="muted">示範用途：所有內容僅存本機，不會上傳。</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 聯絡 -->
  <section id="contact" class="section">
    <div class="container">
      <div class="section-caption">Contact</div>
      <div class="card">
        <h2>聯絡我們</h2>
        <p class="muted">Email：hello@purrgo.example</p>
      </div>
    </div>
  </section>

  <section id="concept" class="section">
    <div class="container">
      <div class="card"><h2>品牌理念</h2><p class="muted">用可愛、可持續、一起玩的方式，讓補給變得更聰明。</p></div>
    </div>
  </section>
</main>

<footer class="section">
  <div class="container muted">© PurrGo 喵來速 ｜ 公開 Demo（不含投資人資訊）</div>
</footer>

<!-- Top -->
<div class="fab"><button class="fab-btn" id="toTop">Top</button></div>

<!-- 登入 Dialog（避免自動跳鍵盤：開啟時不聚焦輸入框） -->
<dialog id="authDialog">
  <div class="auth-outer">
    <div class="auth-card">
      <div class="auth-title">註冊 / 登入</div>
      <form id="authForm" onsubmit="return false;">
        <div>
          <label>註冊 ID（社群名稱）</label>
          <input id="authId" class="input" placeholder="你的社群名稱" autocomplete="off" />
        </div>
        <div class="mt-1">
          <label>密碼</label>
          <input id="authPwd" class="input" type="password" placeholder="......" />
        </div>
        <div class="mt-1">
          <label>手機號碼驗證</label>
          <input id="authPhone" class="input" placeholder="09xxxxxxxx" inputmode="numeric" />
        </div>
        <div class="inline mt-2">
          <button class="btn" id="authOk">開始使用</button>
          <button class="btn secondary" id="authCancel">取消</button>
        </div>
        <hr class="sep" />
        <div class="inline">
          <button class="btn secondary" type="button">使用 LINE 登入（示意）</button>
          <button class="btn secondary" type="button">使用 Facebook 登入（示意）</button>
          <button class="btn secondary" type="button">使用 Instagram 登入（示意）</button>
          <button class="btn secondary" type="button">使用 Gmail 登入（示意）</button>
        </div>
      </form>
      <!-- 轉移焦點的隱形按鈕（避免 iOS 自動打開鍵盤） -->
      <button id="authNoFocus" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0" aria-hidden="true"></button>
    </div>
  </div>
</dialog>

<!-- Photo Modal -->
<dialog id="photoModal">
  <div class="pm">
    <img id="pmImg" alt="photo"/>
    <div class="row">
      <span id="pmMeta" class="muted">相片 0 / 0</span>
      <span class="inline" style="margin-left:auto;gap:8px">
        <button class="btn" id="pmLikeBtn">❤ <span id="pmLike">0</span></button>
        <button class="btn secondary" id="pmCommentBtn">留言</button>
        <button class="btn secondary" id="pmCloseBtn">關閉</button>
      </span>
    </div>
    <div id="pmComments" class="mt-1"></div>
  </div>
</dialog>

<!-- ===== 主程式（本機 state + UI） ===== -->
<script>
const $ = id => document.getElementById(id);

/* ---------- State ---------- */
const state = JSON.parse(localStorage.getItem('purrgo')||'{}');
state.user   ||= { name:null, phone:null };
state.pets   ||= [];                // [{id,name,gender,birth,breed,avatar}]
state.photos ||= {};               // {petId: [{src,likes,comments:[]}]}
state.cart   ||= { items:[] };     // [{id,title,price,qty,img}]
state.vip    ||= { spend:0, level:0, next:200, lastCheckin:'' };
state.guild  ||= { name:null };
save();

/* ---------- Helpers ---------- */
function save(){ localStorage.setItem('purrgo', JSON.stringify(state)); }
function toast(msg){ alert(msg); }
function smoothTo(hash){ closeMenu(); document.querySelector(hash)?.scrollIntoView({behavior:'smooth',block:'start'}); }

/* ---------- Header：登入/登出 Pill ---------- */
function renderUserPill(){
  $('userName').textContent = state.user?.name || '訪客';
  $('loginBtn').textContent = state.user?.name ? '登出' : '登入';
}
$('loginBtn').addEventListener('click', ()=>{
  if(state.user?.name){ state.user = {name:null,phone:null}; save(); renderUserPill(); return; }
  $('authDialog').showModal();
  // 阻止 iOS 自動開鍵盤
  setTimeout(()=> $('authNoFocus').focus(), 0);
});
$('authCancel').addEventListener('click', ()=> $('authDialog').close());
$('authOk').addEventListener('click', ()=>{
  const id = $('authId').value.trim();
  if(!id){ toast('請輸入註冊 ID'); return; }
  state.user.name  = id;
  state.user.phone = $('authPhone').value.trim() || null;
  save(); renderUserPill(); $('authDialog').close();
});

/* ---------- Drawer ---------- */
function openMenu(){ $('menu').classList.add('open'); $('menuBackdrop').classList.add('show'); }
function closeMenu(){ $('menu').classList.remove('open'); $('menuBackdrop').classList.remove('show'); }
$('menuToggle').addEventListener('click', openMenu);
$('menuBackdrop').addEventListener('click', closeMenu);
document.querySelectorAll('[data-nav]').forEach(a=> a.addEventListener('click', e=>{
  e.preventDefault(); smoothTo(a.getAttribute('href'));
}));

/* ---------- Top FAB ---------- */
$('toTop').addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));

/* ---------- Products + Cart ---------- */
const demoProducts = [
  {id:'p1',title:'幼貓專用豆腐砂',spec:'2.5kg / 低粉塵',price:220,img:'./img/p1.jpg'},
  {id:'p2',title:'成貓用凝結砂',spec:'6L / 高凝結',price:250,img:'./img/p2.jpg'},
  {id:'p3',title:'無香環保砂',spec:'3kg / 植物纖維',price:210,img:'./img/p3.jpg'},
];
function renderProducts(){
  const box = $('prodList'); box.innerHTML='';
  demoProducts.forEach(p=>{
    const d = document.createElement('div'); d.className='product card';
    d.innerHTML = `
      <img class="prod-img" src="${p.img}" alt="">
      <h3>${p.title}</h3>
      <p class="muted">規格：${p.spec}</p>
      <h3>NT$ ${p.price}</h3>
      <div class="inline">
        <button class="btn" data-add="${p.id}">加入購物車</button>
        <button class="btn secondary">查看詳情</button>
      </div>`;
    box.appendChild(d);
  });
  box.querySelectorAll('[data-add]').forEach(btn=>{
    btn.onclick = () => addToCart(btn.getAttribute('data-add'));
  });
}
function addToCart(pid){
  const p = demoProducts.find(x=>x.id===pid); if(!p) return;
  const line = state.cart.items.find(x=>x.id===p.id);
  if(line) line.qty += 1; else state.cart.items.push({id:p.id,title:p.title,price:p.price,qty:1,img:p.img});
  save(); renderCart();
}
function renderCart(){
  const box = $('cartBox');
  if(!state.cart.items.length){ box.className='empty'; box.textContent='尚無商品'; return; }
  box.className=''; box.innerHTML='';
  let total=0;
  state.cart.items.forEach(it=>{
    total += it.price*it.qty;
    const row = document.createElement('div');
    row.className='inline'; row.style.justifyContent='space-between';
    row.innerHTML = `<div>${it.title} × ${it.qty}</div><b>NT$ ${it.price*it.qty}</b>`;
    box.appendChild(row);
  });
  box.appendChild(Object.assign(document.createElement('hr'),{className:'sep'}));
  const sum = document.createElement('div'); sum.className='inline'; sum.style.justifyContent='space-between';
  sum.innerHTML = `<div>合計</div><h3>NT$ ${total}</h3>`;
  box.appendChild(sum);
}
$('clearCartBtn').onclick = ()=>{ state.cart.items=[]; save(); renderCart(); };
$('checkoutBtn').onclick = ()=>{
  const total = state.cart.items.reduce((a,b)=>a+b.price*b.qty,0);
  // 結帳示意：累計 VIP 消費
  state.vip.spend += total;
  // 升級規則：每 $200 升一級
  const lv = Math.floor(state.vip.spend/200);
  state.vip.level = lv;
  state.vip.next  = Math.max(0, (lv+1)*200 - state.vip.spend);
  state.cart.items=[]; save(); renderCart(); renderVip();
  toast('結帳完成（示範）');
};

/* ---------- VIP / 公會 ---------- */
function renderVip(){
  $('vipInfo').textContent = `累積消費：$${state.vip.spend}｜VIP 等級：V${state.vip.level}｜下一級還差：$${state.vip.next}`;
}
$('bindPhoneBtn').onclick = ()=>{ 
  const ph = $('vipPhone').value.trim();
  if(!ph){ toast('請輸入手機'); return; }
  state.user.phone = ph; save(); toast('已綁定（示意）');
};
$('checkinBtn').onclick = ()=>{
  const today = new Date().toISOString().slice(0,10);
  if(state.vip.lastCheckin === today){ toast('今天已簽到'); return; }
  state.vip.lastCheckin = today;
  // 簽到加 10 元等效值，推進等級
  state.vip.spend += 10;
  const lv = Math.floor(state.vip.spend/200);
  state.vip.level = lv; state.vip.next = Math.max(0,(lv+1)*200 - state.vip.spend);
  save(); renderVip(); toast('簽到成功 +10（示意）');
};
$('createGuildBtn').onclick = ()=>{
  const name = $('guildName').value.trim(); if(!name){ toast('請輸入公會名稱'); return; }
  state.guild.name = name; save(); renderGuild();
};
function renderGuild(){
  $('guildInfo').textContent = state.guild.name ? `公會：${state.guild.name}` : '公會：（尚未創立）';
}

/* ---------- Pets ---------- */
function uid(){ return Math.random().toString(36).slice(2,9); }
$('addPetBtn').onclick = async ()=>{
  const name = $('petName').value.trim(); if(!name){ toast('請輸入暱稱'); return; }
  const gender = $('petGender').value; const birth = $('petBirth').value; const breed = $('petBreed').value;
  let avatarData = null;
  const f = $('petAvatar').files?.[0];
  if(f){ avatarData = await fileToDataURL(f); }

  const p = { id: uid(), name, gender, birth, breed, avatar: avatarData };
  state.pets.push(p);
  if(p.avatar){ // 自動把頭像塞到相簿第一張
    (state.photos[p.id] = state.photos[p.id] || []).unshift({src:p.avatar,likes:0,comments:[]});
  }
  save(); renderPets(); renderPhotoSelector();
  $('petName').value=''; $('petBirth').value=''; $('petAvatar').value='';
  toast('主子已新增');
};
function fileToDataURL(file){
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
}
function renderPets(){
  const box = $('petList'); box.innerHTML='';
  if(!state.pets.length){ box.innerHTML='<div class="empty">尚未建立主子</div>'; return; }
  state.pets.forEach(p=>{
    const d = document.createElement('div'); d.className='p-card';
    d.innerHTML = `
      <img class="p-avatar" src="${p.avatar||'./img/placeholder.png'}" alt="">
      <div style="flex:1">
        <b>${p.name}</b><div class="muted">${p.breed}｜${p.gender}｜${p.birth||'-'}</div>
      </div>
      <button class="btn secondary" data-edit="${p.id}">編輯</button>`;
    box.appendChild(d);
  });
  box.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=> editPet(b.getAttribute('data-edit')));
}
function editPet(pid){
  const p = state.pets.find(x=>x.id===pid); if(!p) return;
  $('petName').value  = p.name;
  $('petGender').value= p.gender;
  $('petBirth').value = p.birth||'';
  $('petBreed').value = p.breed||'';
  // 編輯後按新增 => 視為新增新版本；進階：可加「儲存」與「刪除」按鈕（此處簡化）
  toast('已帶入主子資訊，可修改後再按「新增主子」覆蓋新增（示範）');
}

/* ---------- Photos（IG Grid + Modal） ---------- */
function renderPhotoSelector(){
  const sel = $('photoPet'); sel.innerHTML='';
  state.pets.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o); });
  if(state.pets[0]) sel.value = state.pets[0].id;
  renderIgGrid();
}
$('photoInput').addEventListener('change', async (e)=>{
  const pid = $('photoPet').value; if(!pid){ toast('請先建立主子'); return; }
  const files = [...e.target.files];
  if(!files.length) return;
  const arr = state.photos[pid] = state.photos[pid] || [];
  for(const f of files){ const src = await fileToDataURL(f); arr.unshift({src,likes:0,comments:[]}); }
  save(); renderIgGrid(); e.target.value='';
});
function renderIgGrid(){
  const pid = $('photoPet').value; const grid = $('igGrid'); grid.innerHTML='';
  const list = (state.photos[pid]||[]);
  if(!list.length){ grid.innerHTML = '<div class="empty" style="grid-column:1/-1">尚未上傳照片</div>'; return; }
  list.forEach((ph,idx)=>{
    const cell = document.createElement('div'); cell.className='ig';
    cell.innerHTML = `<img src="${ph.src}"/><span class="count">❤ ${ph.likes||0}</span>`;
    cell.onclick = ()=> openPhoto(pid, idx);
    grid.appendChild(cell);
  });
}

/* Photo modal controls */
let _pm = { pid:null, idx:-1 };
function openPhoto(pid, idx){
  _pm = { pid, idx };
  const ph = (state.photos[pid]||[])[idx]; if(!ph) return;
  $('pmImg').src = ph.src;
  $('pmLike').textContent = ph.likes||0;
  $('pmMeta').textContent = `相片 ${idx+1} ／ 共 ${state.photos[pid].length} 張`;
  renderPhotoComments(ph);
  $('photoModal').showModal();
}
$('pmCloseBtn').onclick = ()=> $('photoModal').close();
$('pmLikeBtn').onclick = ()=>{
  if(!_pm.pid) return;
  const ph = state.photos[_pm.pid][_pm.idx]; ph.likes = (ph.likes||0)+1; save();
  $('pmLike').textContent = ph.likes;
  renderIgGrid();
};
$('pmCommentBtn').onclick = ()=>{
  if(!_pm.pid) return; const t = prompt('留言內容'); if(!t) return;
  const ph = state.photos[_pm.pid][_pm.idx]; (ph.comments=ph.comments||[]).push({text:t,time:new Date().toLocaleString()});
  save(); renderPhotoComments(ph);
};
function renderPhotoComments(ph){
  const box = $('pmComments'); box.innerHTML='';
  (ph.comments||[]).slice().reverse().forEach(c=>{
    const d = document.createElement('div'); d.className='muted'; d.textContent = `${c.text} · ${c.time}`; box.appendChild(d);
  });
}

/* ---------- Chat ---------- */
const chat = JSON.parse(localStorage.getItem('purrgo-chat')||'{"logs":[]}')
function renderChat(){ 
  const box = $('chatBox'); box.innerHTML=''; 
  chat.logs.forEach(m=>{
    const d = document.createElement('div'); d.className = 'msg '+(m.me?'me':'other'); d.textContent = m.text; box.appendChild(d);
  });
  box.scrollTop = box.scrollHeight;
}
$('sendBtn').onclick = ()=>{
  const t = $('chatInput').value.trim(); if(!t) return;
  chat.logs.push({me:true,text:t,time:Date.now()}); localStorage.setItem('purrgo-chat',JSON.stringify(chat));
  $('chatInput').value=''; renderChat();
}
$('clearTypingBtn').onclick = ()=> $('chatInput').value='';

/* ---------- 初始渲染 ---------- */
renderUserPill();
renderProducts();
renderCart();
renderVip();
renderGuild();
renderPets();
renderPhotoSelector();
renderChat();
</script>
</body>
</html>
