<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PurrGo 喵來速｜品牌官網 Demo</title>

  <!-- PWA / Icons -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./logo/favicon.png">
  <link rel="apple-touch-icon" sizes="192x192" href="./logo/logo-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="./logo/logo-512.png">
  <meta name="theme-color" content="#ff7f50">

  <!-- Styles -->
  <link rel="stylesheet" href="./style.css"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body id="top">

<!-- ===== Header / 導覽 ===== -->
<header class="site-header">
  <div class="nav container">
    <a class="brand" href="#home" onclick="route('home');return false;">
      <span class="logo">G</span><span class="brand-name">PurrGo 喵來速</span>
    </a>

    <!-- 桌面 Tabs -->
    <nav class="tabs hide-on-mobile" aria-label="主選單">
      <a class="tab" data-sec="home"      href="#home">首頁</a>
      <a class="tab" data-sec="products"  href="#products">產品</a>
      <a class="tab" data-sec="guild"     href="#guild">公會</a>
      <a class="tab" data-sec="kiosk"     href="#kiosk">據點</a>
      <a class="tab" data-sec="community" href="#community">照片牆</a>
      <a class="tab" data-sec="about"     href="#about">理念</a>
      <a class="tab" data-sec="contact"   href="#contact">聯絡</a>
    </nav>

    <!-- 手機：漢堡 -->
    <button class="menu-toggle show-on-mobile" aria-label="展開選單" onclick="toggleMenu()">
      <span class="menu-ico" aria-hidden="true"></span>
    </button>
  </div>

  <!-- 手機：抽屜選單 + 遮罩 -->
  <nav id="drawer" class="drawer" aria-label="抽屜選單" role="dialog" aria-modal="true">
    <div class="drawer-body">
      <a href="#home"      class="drawer-item" onclick="jump('home')">首頁</a>
      <a href="#products"  class="drawer-item" onclick="jump('products')">產品</a>
      <a href="#guild"     class="drawer-item" onclick="jump('guild')">公會</a>
      <a href="#kiosk"     class="drawer-item" onclick="jump('kiosk')">據點</a>
      <a href="#community" class="drawer-item" onclick="jump('community')">照片牆</a>
      <a href="#about"     class="drawer-item" onclick="jump('about')">理念</a>
      <a href="#contact"   class="drawer-item" onclick="jump('contact')">聯絡</a>
    </div>
  </nav>
  <div id="backdrop" class="backdrop" onclick="closeMenu()" aria-hidden="true"></div>
</header>

<main>

  <!-- ===== Home ===== -->
  <section id="home" class="page container">
    <div class="hero card">
      <div class="hero-copy">
        <span class="pill">PurrGo 喵來速</span>
        <h1 class="hero-title">便利 × 可愛 × 永續 × 共創</h1>
        <p class="muted">創新配送 + 公會制度，讓補給更聰明、更便宜、更好玩；把「買貓砂」變成有成就感的里程碑遊戲。</p>
        <div class="inline">
          <a class="btn" href="#products" onclick="route('products');return false;">開始探索產品</a>
          <a class="btn secondary" href="#guild" onclick="route('guild');return false;">加入貓奴公會</a>
          <a class="btn tertiary" href="#about" onclick="route('about');return false;">了解品牌理念</a>
        </div>
      </div>
      <div class="hero-art">
        <div class="hero-visual"><div class="hero-logo">G</div></div>
      </div>
    </div>

    <!-- 建立貓主子（多貓家庭支援） -->
    <div class="card mt-2">
      <h3 class="mt-0">建立貓主子</h3>
      <p class="muted">可新增多隻主子。上傳大頭照、選擇品種與基本資料；與健檢、照片牆串接。</p>
      <form class="grid g-2" onsubmit="return addCat(event)">
        <input class="input" id="catName" placeholder="主子名字" required>
        <select class="input" id="catBreed">
          <option>米克斯</option><option>英短</option><option>美短</option>
          <option>曼赤肯</option><option>布偶</option><option>緬因</option>
          <option>波斯</option><option>蘇格蘭摺耳</option>
        </select>
        <select class="input" id="catSex"><option>公</option><option>母</option></select>
        <input class="input" id="catAge" type="number" min="0" max="30" placeholder="年齡（歲）">
        <input class="input gcol-2" id="catAvatar" type="file" accept="image/*">
        <div class="inline gcol-2">
          <button class="btn" type="submit">新增主子</button>
          <button class="btn secondary" type="button" onclick="clearCats()">清空主子（本機）</button>
        </div>
      </form>

      <!-- 主子列表（橫向卡片） -->
      <div class="hwrap mt-2">
        <div id="catRow" class="hscroll cards"></div>
      </div>
    </div>
  </section>

  <!-- ===== Products ===== -->
  <section id="products" class="page container">
    <header class="section-head">
      <span class="pill">Products</span>
      <h2>熱銷與方案</h2>
      <p class="section-sub">橫向滑動卡片，支援產品照片、詳情與加入購物車。</p>
    </header>

    <div class="hwrap">
      <div id="productRow" class="hscroll cards"></div>
    </div>

    <div class="card mt-2">
      <h3 class="mt-0">購物車（示範）</h3>
      <div id="cartItems" class="muted">尚無商品</div>
      <div class="inline mt-1">
        <button class="btn" onclick="checkout()">結帳（示範）</button>
        <button class="btn secondary" onclick="clearCart()">清空</button>
      </div>
    </div>
  </section>

  <!-- ===== Guild ===== -->
  <section id="guild" class="page container">
    <header class="section-head">
      <span class="pill">Guild</span>
      <h2>公會制度：一起成長、一起更省</h2>
      <p class="section-sub">創立門檻、VIP 等級、貢獻條、每日任務、健檢貢獻…</p>
    </header>

    <div class="grid g-2">
      <div class="card">
        <h3 class="mt-0">身份綁定 / VIP</h3>
        <div class="inline">
          <input class="input" id="phoneInput" placeholder="輸入手機號碼">
          <button class="btn" onclick="bindPhone(document.getElementById('phoneInput').value)">綁定手機（示意）</button>
        </div>
        <div class="inline mt-1">
          <button id="lineBtn" class="btn secondary" onclick="toggleLine()">綁定 LINE（示意）</button>
          <div id="identityInfo" class="muted">尚未綁定手機</div>
        </div>
        <div class="mt-1">累積消費：<b id="lifetimeSpend">$0</b> ｜ VIP 等級：<b id="vipLevel">V0</b> ｜ 下一級還差：<b id="vipNext">$200</b></div>
        <div class="inline mt-1"><button class="btn" onclick="dailyCheckin()">每日簽到 + 能量 / XP</button><span id="checkinInfo" class="muted"></span></div>
      </div>

      <div class="card">
        <h3 class="mt-0">創立公會 / 貢獻</h3>
        <div>公會名稱：<b id="guildName">（尚未創立）</b> ｜ 等級：<b id="guildLevel">–</b> ｜ 總貢獻：<b id="guildContrib">0</b></div>
        <div class="inline mt-1">
          <button class="btn" onclick="createGuild()">創立公會</button>
          <button class="btn secondary" onclick="contribute(50)">捐獻 +50（示範）</button>
          <button class="btn secondary" onclick="mockWar()">模擬戰報（示範）</button>
        </div>
      </div>
    </div>

    <!-- 健檢預約（本機示範） -->
    <div class="card mt-2">
      <h3 class="mt-0">免費健檢（示範）</h3>
      <p class="muted">加入公會後可預約年度一次免費健檢。選地區 → 顯示合作院所 → 上傳報告可得公會貢獻（示意流程）。</p>

      <!-- Gate：未加入公會提示 -->
      <div id="guildGate" class="empty" style="display:none">請先「創立公會」或加入既有公會後，再使用健檢服務。</div>

      <form id="vetForm" class="grid g-2" onsubmit="return bookVet(event)">
        <div>
          <label>選擇主子
            <select class="input" id="vetCatSelect"></select>
          </label>
        </div>
        <div>
          <label>城市
            <select class="input" id="vetCity">
              <option>台北</option><option>台中</option><option>高雄</option>
            </select>
          </label>
        </div>
        <div class="gcol-2"><label>備註<textarea class="input" id="vetNote"></textarea></label></div>
        <div class="inline gcol-2">
          <input class="input" id="vetReport" type="file" accept="image/*,.pdf">
          <button class="btn" type="submit">預約（示範）</button>
        </div>
      </form>
      <div id="vetList" class="muted mt-1"></div>
    </div>

    <!-- 區域戰（示意） -->
    <div class="card mt-2">
      <h3 class="mt-0">展開：區域戰排行（示範）</h3>
      <table class="table">
        <thead><tr><th>#</th><th>公會</th><th>區域</th><th>分數</th></tr></thead>
        <tbody id="warTable"><tr><td>1</td><td>示例公會</td><td>北區</td><td>12345</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- ===== Kiosk / Map ===== -->
  <section id="kiosk" class="page container">
    <header class="section-head">
      <span class="pill">Kiosk</span>
      <h2>販賣機點位</h2>
      <p class="section-sub">點擊標記可開啟 Google/Apple Maps 導航。</p>
    </header>
    <div id="map" class="map"></div>
  </section>

  <!-- ===== Community / 照片牆（本機示範） ===== -->
  <section id="community" class="page container">
    <header class="section-head">
      <span class="pill">Community</span>
      <h2>照片牆（按主子分相簿）</h2>
      <p class="section-sub">上傳只儲存在本機 localStorage；清除後不可復原。</p>
    </header>

    <!-- 依主子切換相簿 -->
    <div class="inline">
      <select class="input" id="wallCatSelect" style="max-width:220px"></select>
      <input type="file" accept="image/*" onchange="addPhoto(event)">
      <button class="btn secondary" onclick="clearWall()">清除此主子的所有照片（本機）</button>
    </div>

    <!-- 橫向相簿卡 -->
    <div class="hwrap mt-2">
      <div id="wallRow" class="hscroll cards"></div>
    </div>
  </section>

  <!-- ===== About / Contact ===== -->
  <section id="about" class="page container">
    <header class="section-head">
      <span class="pill">About</span>
      <h2>品牌理念</h2>
      <p class="section-sub">便利、可愛、永續、共創。</p>
    </header>
    <div class="card"><p class="muted">我們相信與社群一起共創，把日常補給轉化為好玩且更有效率的體驗。</p></div>
  </section>

  <section id="contact" class="page container">
    <header class="section-head">
      <span class="pill">Contact</span>
      <h2>聯絡我們</h2>
    </header>
    <form class="card grid g-2" onsubmit="return submitForm(event)">
      <div><label>您的稱呼<input class="input" required></label></div>
      <div><label>Email<input type="email" class="input" required></label></div>
      <div class="gcol-2"><label>訊息<textarea class="input" required></textarea></label></div>
      <div class="inline"><button class="btn" type="submit">送出</button></div>
    </form>
    <p class="muted mt-1">也可來信：<a href="mailto:hello@purrgo.tw">hello@purrgo.tw</a> ｜ LINE 官方：@purrgo</p>
  </section>
</main>

<footer class="container footer">© PurrGo 喵來速 ｜ 公開 Demo（不含投資人資訊）</footer>

<!-- ===== FAB ===== -->
<div class="fab" id="fab">
  <button class="fab-btn" title="Top"  onclick="route('home')">Top</button>
  <button class="fab-btn" title="Shop" onclick="route('products')">Shop</button>
  <button class="fab-btn" title="Guild" onclick="route('guild')">Guild</button>
  <button class="fab-btn" title="Map"  onclick="route('kiosk')">Map</button>
  <button class="fab-btn" title="Msg"  onclick="route('contact')">Msg</button>
</div>

<!-- ===== Script（整合原功能＋主子/相簿） ===== -->
<script>
/* ===== 狀態 ===== */
const LS_KEY='purrgoState';
const state=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
state.user   ||= { phone:'', line:false, vipXp:0, lifetimeSpend:0, energy:0, lastCheckin:'' };
state.guild  ||= { name:'', level:0, contribution:0 };
state.cart   ||= [];
state.vet    ||= [];
state.cats   ||= [];   // 主子清單：[{id,name,breed,sex,age,avatarDataUrl}]
state.albums ||= {};   // 相簿：{catId: [dataUrl,...]}
save();

/* ===== 路由（分頁顯示） ===== */
function route(id){ location.hash='#'+id; renderRoute(); }
function renderRoute(){
  const hash=(location.hash||'#home').replace('#','');
  document.querySelectorAll('.page').forEach(sec=>{ sec.style.display=sec.id===hash?'block':'none'; });
  document.querySelectorAll('.tab').forEach(a=>{ a.setAttribute('aria-current', a.dataset.sec===hash?'page':'false'); });
  window.scrollTo({top:0,behavior:'instant'});
}
window.addEventListener('hashchange', renderRoute);
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });
window.addEventListener('DOMContentLoaded', renderRoute);

/* ===== 漢堡 / 抽屜 ===== */
const drawer=document.getElementById('drawer');
const backdrop=document.getElementById('backdrop');
function toggleMenu(){ const open=drawer.classList.toggle('open'); backdrop.classList.toggle('open',open); document.body.classList.toggle('menu-open',open); }
function closeMenu(){ drawer.classList.remove('open'); backdrop.classList.remove('open'); document.body.classList.remove('menu-open'); }
function jump(id){ closeMenu(); setTimeout(()=>route(id),10); }

/* ===== 儲存＋重繪 ===== */
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state));
  renderIdentity(); renderVIP(); renderGuild(); renderCart(); renderVet();
  renderCats(); renderWallSelectors(); renderWall(); }

/* ===== 身份 / 綁定 / VIP ===== */
function bindPhone(v){ state.user.phone=v||''; save(); }
function toggleLine(){ state.user.line=!state.user.line; save(); }
function vipLevelByXp(x){ if(x>=5000) return 5; if(x>=3000) return 4; if(x>=1500) return 3; if(x>=600) return 2; if(x>=200) return 1; return 0; }
function nextVipNeed(x){ const br=[200,600,1500,3000,5000]; for(const b of br){ if(x<b) return b-x; } return 0; }
function renderIdentity(){
  const info=document.getElementById('identityInfo'); const btn=document.getElementById('lineBtn');
  if(info){ info.textContent = state.user.phone ? `已綁定：${state.user.phone} ｜ LINE：${state.user.line?'已連結':'未連結'}` : '尚未綁定手機'; }
  if(btn){ btn.textContent = state.user.line? '取消 LINE 連結（示意）':'綁定 LINE（示意）'; }
}
function renderVIP(){
  const xp=state.user.vipXp|0;
  const $ = (id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };
  $('lifetimeSpend', `$${(state.user.lifetimeSpend||0).toLocaleString()}`);
  $('vipLevel', 'V'+vipLevelByXp(xp));
  $('vipNext', nextVipNeed(xp)>0? `$${nextVipNeed(xp)}`:'已達頂級');
}
function dailyCheckin(){
  const today=new Date().toISOString().slice(0,10);
  if(state.user.lastCheckin===today){ const el=document.getElementById('checkinInfo'); if(el) el.textContent='今天已簽到'; return; }
  state.user.lastCheckin=today; state.user.energy+=10; state.user.vipXp+=10;
  const el=document.getElementById('checkinInfo'); if(el) el.textContent='簽到成功：+10 能量、+10 VIP XP';
  save();
}

/* ===== 公會 ===== */
const GUILD_CREATE_NEED=1200;
function renderGuild(){
  const $=(id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };
  $('guildName', state.guild.name||'（尚未創立）');
  $('guildLevel', state.guild.level||'–');
  $('guildContrib', state.guild.contribution|0);

  // 健檢入口 Gate
  const gate=document.getElementById('guildGate');
  const form=document.getElementById('vetForm');
  if(gate && form){
    const allow = !!state.guild.name;
    gate.style.display = allow ? 'none' : 'block';
    form.style.display = allow ? 'grid' : 'none';
  }

  // 健檢主子下拉
  const sel=document.getElementById('vetCatSelect');
  if(sel){ sel.innerHTML = (state.cats.length? state.cats:[]).map(c=>`<option value="${c.id}">${c.name}</option>`).join(''); }
}
function createGuild(){
  if((state.user.lifetimeSpend||0) < GUILD_CREATE_NEED){ return alert('尚未達到創立門檻：累積消費 $1,200'); }
  const name=prompt('輸入公會名稱'); if(!name) return;
  state.guild.name=name; state.guild.level=1; save(); alert('公會已創立！');
}
function contribute(n){
  if(!state.guild.name) return alert('請先創立公會');
  state.guild.contribution+=n;
  if(state.guild.contribution >= (state.guild.level*500)){ state.guild.level++; alert('公會升級！'); }
  save();
}
function mockWar(){
  if(!state.guild.name) return alert('先創立公會');
  const add=Math.floor(Math.random()*500+100);
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>*</td><td>${state.guild.name}</td><td>你的區域</td><td>+${add}</td>`;
  document.getElementById('warTable').prepend(tr);
}

/* ===== 主子（多貓） ===== */
function uid(){ return Math.random().toString(36).slice(2,10); }
function addCat(e){
  e.preventDefault();
  const name=document.getElementById('catName').value.trim();
  const breed=document.getElementById('catBreed').value;
  const sex=document.getElementById('catSex').value;
  const age=parseInt(document.getElementById('catAge').value||'0',10);
  const file=document.getElementById('catAvatar').files[0];

  const finalize=(avatarDataUrl)=>{
    const cat={ id:uid(), name, breed, sex, age, avatarDataUrl: avatarDataUrl||'' };
    state.cats.push(cat);
    state.albums[cat.id] ||= [];
    save();
    e.target.reset();
    alert('已新增主子！');
  };

  if(file){
    const reader=new FileReader();
    reader.onload=()=>finalize(reader.result);
    reader.readAsDataURL(file);
  }else{
    finalize('');
  }
  return false;
}
function clearCats(){
  if(!confirm('清空所有主子與其相簿（本機）？')) return;
  state.cats=[]; state.albums={}; save();
}
function renderCats(){
  const row=document.getElementById('catRow'); if(!row) return;
  row.innerHTML='';
  if(!state.cats.length){
    const empty=document.createElement('div');
    empty.className='empty'; empty.textContent='尚未建立主子';
    row.appendChild(empty); return;
  }
  state.cats.forEach(c=>{
    const el=document.createElement('article'); el.className='card catcard';
    el.innerHTML=`
      <div class="cat-avatar" style="${c.avatarDataUrl?`background-image:url('${c.avatarDataUrl}')`:''}"></div>
      <h3 class="mt-0">${c.name}</h3>
      <div class="muted">${c.breed} ｜ ${c.sex} ｜ ${c.age||0} 歲</div>
      <div class="inline mt-1">
        <button class="btn" onclick="route('community'); setTimeout(()=>setWallCat('${c.id}'),50)">看相簿</button>
        <button class="btn secondary" onclick="route('guild'); setTimeout(()=>selectVetCat('${c.id}'),50)">去健檢</button>
      </div>`;
    row.appendChild(el);
  });
}
function selectVetCat(id){
  const sel=document.getElementById('vetCatSelect'); if(!sel) return;
  sel.value=id;
}

/* ===== 相簿 / 照片牆（依主子） ===== */
function renderWallSelectors(){
  const sel=document.getElementById('wallCatSelect'); if(!sel) return;
  const opts = state.cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  sel.innerHTML = opts || `<option value="">尚未建立主子</option>`;
}
function setWallCat(id){
  const sel=document.getElementById('wallCatSelect'); if(sel){ sel.value=id; renderWall(); }
}
function currentWallCatId(){
  const sel=document.getElementById('wallCatSelect'); return sel && sel.value ? sel.value : (state.cats[0]?.id || '');
}
function addPhoto(e){
  const file=e.target.files[0]; if(!file) return;
  const cid=currentWallCatId(); if(!cid){ alert('請先建立主子'); return; }
  const reader=new FileReader();
  reader.onload=()=>{ state.albums[cid] ||= []; state.albums[cid].push(reader.result); save(); };
  reader.readAsDataURL(file);
}
function renderWall(){
  const cid=currentWallCatId();
  const row=document.getElementById('wallRow'); if(!row) return; row.innerHTML='';
  if(!cid || !state.albums[cid] || state.albums[cid].length===0){
    const empty=document.createElement('div'); empty.className='empty'; empty.textContent='此主子目前沒有照片';
    row.appendChild(empty); return;
  }
  state.albums[cid].forEach(src=>{
    const el=document.createElement('article'); el.className='card photo';
    el.innerHTML = `<div class="photo-img" style="background-image:url('${src}')"></div>
      <div class="inline mt-1">
        <button class="btn secondary" onclick="likePhoto('${cid}','${src}')">❤ 喜歡</button>
        <button class="btn secondary" onclick="sharePhoto('${cid}','${src}')">↗ 分享</button>
        <button class="btn secondary" onclick="commentPhoto('${cid}','${src}')">💬 留言</button>
      </div>`;
    row.appendChild(el);
  });
}
function clearWall(){
  const cid=currentWallCatId(); if(!cid) return alert('請先建立主子');
  if(!confirm('清除此主子所有照片？')) return;
  state.albums[cid]=[]; save();
}
function likePhoto(){ alert('已按讚（展示版）'); }
function sharePhoto(){ alert('已分享（展示版）'); }
function commentPhoto(){ alert('留言功能將在正式版提供'); }

/* ===== 產品 / 購物車 ===== */
async function loadProducts(){
  try{
    const res = await fetch('./data/products.json',{cache:'no-cache'});
    const list = await res.json();
    const row = document.getElementById('productRow'); row.innerHTML='';
    list.forEach(p=>{
      const el=document.createElement('article'); el.className='card product';
      el.innerHTML = `
        <div class="product-photo" style="${p.img?`background-image:url('${p.img}');background-size:cover;background-position:center;`:''}"></div>
        <h3 class="mt-0">${p.name}</h3>
        <div class="muted">${p.spec||''}</div>
        <div class="price">NT$ ${p.price.toLocaleString()}</div>
        <ul class="list">${(p.bullets||[]).map(b=>`<li>${b}</li>`).join('')}</ul>
        <div class="inline mt-1">
          <button class="btn" onclick='addToCart(${JSON.stringify(p).replace(/'/g,"&#39;")})'>加入購物車</button>
          <button class="btn secondary">查看詳情</button>
        </div>`;
      row.appendChild(el);
    });
  }catch(e){
    document.getElementById('productRow').innerHTML = '<div class="card">讀取產品失敗</div>';
  }
}
function addToCart(p){ const item = state.cart.find(i=>i.id===p.id) || (state.cart.push({...p,qty:0}), state.cart.find(i=>i.id===p.id)); item.qty++; save(); }
function clearCart(){ state.cart=[]; save(); }
function renderCart(){
  const box=document.getElementById('cartItems'); if(!box) return;
  if(state.cart.length===0){ box.textContent='尚無商品'; return; }
  let sum=0;
  box.innerHTML = state.cart.map(i=>{ sum+=i.price*i.qty; return `${i.name} × ${i.qty} = NT$ ${(i.price*i.qty).toLocaleString()}`; }).join('<br>');
  box.innerHTML += `<div class="mt-1"><b>小計：NT$ ${sum.toLocaleString()}</b></div>`;
}
function checkout(){
  if(state.cart.length===0) return alert('購物車是空的');
  const sum = state.cart.reduce((a,b)=>a+b.price*b.qty,0);
  state.user.lifetimeSpend = (state.user.lifetimeSpend||0) + sum;
  state.user.vipXp += Math.round(sum/10);
  state.user.energy += Math.round(sum/20);
  state.cart=[]; alert(`結帳成功！累積消費 +$${sum.toLocaleString()}，VIP XP 與能量已增加`);
  save();
}

/* ===== 地圖（Leaflet + OSM） ===== */
async function initMap(){
  if(!window.L) return;
  const map=L.map('map',{zoomControl:true}).setView([25.0330,121.5654],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
  try{
    const res = await fetch('./data/locations.json',{cache:'no-cache'}); const points = await res.json();
    points.forEach(p=>{
      const m=L.marker([p.lat,p.lng]).addTo(map);
      const gLink = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
      const aLink = `https://maps.apple.com/?q=${p.lat},${p.lng}`;
      m.bindPopup(`<b>${p.name}</b><br>${p.address||''}<br><a href='${gLink}' target='_blank'>Google Maps</a> ｜ <a href='${aLink}' target='_blank'>Apple Maps</a>`);
    });
  }catch(e){}
}

/* ===== 聯絡表單（示範） ===== */
function submitForm(e){ e.preventDefault(); alert('已收到您的訊息（示範）'); e.target.reset(); return false; }

/* ===== 啟動 ===== */
window.addEventListener('DOMContentLoaded',()=>{
  loadProducts(); initMap(); renderRoute();
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
});

/* 抽屜開啟時，FAB 自動隱藏 */
const fab=document.getElementById('fab');
new MutationObserver(()=>{ fab.classList.toggle('hidden', drawer.classList.contains('open')); })
.observe(drawer,{attributes:true});
</script>
</body>
</html>
