<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PurrGo å–µä¾†é€Ÿï½œå“ç‰Œå®˜ç¶² Demo</title>

  <!-- PWA / Icons -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./logo/favicon.png">
  <link rel="apple-touch-icon" sizes="192x192" href="./logo/logo-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="./logo/logo-512.png">
  <meta name="theme-color" content="#ff7f50">

  <!-- Site CSSï¼ˆåŠ ç‰ˆæœ¬åƒæ•¸é¿å…å¿«å–ï¼‰ -->
  <link rel="stylesheet" href="./style.css?v=5">

  <!-- Leaflet CSS / JSï¼ˆåœ°åœ–ï¼‰ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
</head>
<body>

<!-- ========== Header ========== -->
<header class="container">
  <div class="nav">
    <a class="brand" href="#home" onclick="scrollToHash('home');return false;">
      <span class="logo">ğŸ¾</span>
      <span>PurrGo å–µä¾†é€Ÿ</span>
    </a>

    <!-- æ¡Œæ©Ÿï¼šé ç±¤ -->
    <nav class="tabs" aria-label="ä¸»é¸å–®">
      <a class="tab" data-sec="home">é¦–é </a>
      <a class="tab" data-sec="products">ç”¢å“</a>
      <a class="tab" data-sec="guild">å…¬æœƒ</a>
      <a class="tab" data-sec="kiosk">æ“šé»</a>
      <a class="tab" data-sec="community">ç…§ç‰‡ç‰†</a>
      <a class="tab" data-sec="about">ç†å¿µ</a>
      <a class="tab" data-sec="contact">è¯çµ¡</a>
    </nav>

    <!-- æ‰‹æ©Ÿï¼šæ¼¢å ¡æŒ‰éˆ• -->
    <button class="menu-toggle" aria-label="é–‹å•Ÿé¸å–®" aria-expanded="false">
      <span class="menu-ico" aria-hidden="true"></span>
    </button>
  </div>

  <!-- æ‰‹æ©Ÿï¼šæŠ½å±œå¼é¸å–® -->
  <nav id="menu" class="menu" aria-label="æ‰‹æ©Ÿé¸å–®">
    <a href="#home" onclick="closeMenu();scrollToHash('home')">é¦–é </a>
    <a href="#products" onclick="closeMenu();scrollToHash('products')">ç”¢å“</a>
    <a href="#guild" onclick="closeMenu();scrollToHash('guild')">å…¬æœƒ</a>
    <a href="#kiosk" onclick="closeMenu();scrollToHash('kiosk')">æ“šé»</a>
    <a href="#community" onclick="closeMenu();scrollToHash('community')">ç…§ç‰‡ç‰†</a>
    <a href="#about" onclick="closeMenu();scrollToHash('about')">ç†å¿µ</a>
    <a href="#contact" onclick="closeMenu();scrollToHash('contact')">è¯çµ¡</a>
  </nav>
</header>

<!-- æ‰‹æ©Ÿï¼šåŠé€æ˜é®ç½©ï¼ˆå“ç‰Œæ©˜ 30%ï¼‰ -->
<div id="menuBackdrop" class="menu-backdrop"></div>

<!-- ========== Main ========== -->
<main class="container">

  <!-- Hero -->
  <section id="home" class="page card hero">
    <div class="hero-copy">
      <span class="pill">PurrGo å–µä¾†é€Ÿ</span>
      <h1 class="hero-title">ä¾¿åˆ© Ã— å¯æ„› Ã— æ°¸çºŒ Ã— å…±å‰µ</h1>
      <p class="muted">
        å‰µæ–°é…é€ + å…¬æœƒåˆ¶åº¦ï¼Œè®“è£œçµ¦æ›´è°æ˜ã€æ›´ä¾¿å®œã€æ›´å¥½ç©ã€‚<br>
        æŠŠæ—¥å¸¸è£œçµ¦è®Šæˆä¸€èµ·å‡ç´šæ‹¿ç¦åˆ©çš„é‡Œç¨‹ç¢‘éŠæˆ²ã€‚
      </p>
      <div class="inline mt-1">
        <a class="btn" onclick="scrollToHash('products')">é–‹å§‹æ¢ç´¢ç”¢å“</a>
        <a class="btn secondary" onclick="scrollToHash('guild')">åŠ å…¥è²“å¥´å…¬æœƒ</a>
      </div>
      <div class="inline mt-1">
        <a class="btn ghost" onclick="scrollToHash('avatar')">å»ºç«‹ä¸»å­è§’è‰²</a>
      </div>
    </div>
    <div class="hero-art">
      <div class="hero-visual">
        <img src="./logo/logo-512.png" alt="PurrGo Logo" class="hero-logo">
      </div>
    </div>
  </section>

  <!-- Products -->
  <section id="products" class="page">
    <section class="band">
      <header class="section-head">
        <div>
          <span class="pill">Products</span>
          <h2 class="mt-0">ç†±éŠ·èˆ‡æ–¹æ¡ˆ</h2>
          <p class="section-sub">æ©«å‘æ»‘å‹•å¡ç‰‡ï¼Œæ”¯æ´ç”¢å“ç…§ç‰‡ã€è©³æƒ…å½ˆçª—èˆ‡åŠ å…¥è³¼ç‰©è»Šã€‚</p>
        </div>
      </header>

      <!-- æ©«å‘æ»‘å‹• -->
      <div class="hwrap">
        <button class="hbtn prev" aria-label="ä¸Šä¸€æ’">&lsaquo;</button>
        <div id="productRow" class="hscroll"></div>
        <button class="hbtn next" aria-label="ä¸‹ä¸€æ’">&rsaquo;</button>
      </div>

      <div class="card">
        <h3 class="mt-0">è³¼ç‰©è»Šï¼ˆç¤ºç¯„ï¼‰</h3>
        <div id="cartItems" class="muted">å°šç„¡å•†å“</div>
        <div class="inline mt-1">
          <button class="btn" onclick="checkout()">çµå¸³ï¼ˆç¤ºç¯„ï¼‰</button>
          <button class="btn secondary" onclick="clearCart()">æ¸…ç©º</button>
        </div>
      </div>
    </section>
  </section>

  <!-- Guild -->
  <section id="guild" class="page">
    <section class="band">
      <header class="section-head">
        <div>
          <span class="pill">Guild</span>
          <h2 class="mt-0">å…¬æœƒåˆ¶åº¦ï¼šä¸€èµ·æˆé•·ãƒ»ä¸€èµ·æ›´çœ</h2>
          <p class="section-sub">å‰µç«‹é–€æª»ã€VIP ç­‰ç´šã€è²¢ç»æ¢ã€ä»»å‹™å¡ç‰‡åŒ–å‘ˆç¾ã€‚</p>
        </div>
      </header>

      <!-- æ©«å‘å¡ç‰‡ï¼ˆåŒæ¨£é–“è·ï¼‰ -->
      <div class="hwrap">
        <button class="hbtn prev" aria-label="ä¸Šä¸€æ’">&lsaquo;</button>
        <div class="hscroll" id="guildRow">
          <div class="card">
            <h3 class="mt-0">å‰µç«‹é–€æª»</h3>
            <p>æœƒé•·è³‡æ ¼ï¼šç´¯ç©æ¶ˆè²» â‰§ $1,200ï¼ˆç¤ºç¯„ï¼‰</p>
            <div class="inline">
              <input id="phone" class="input" placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼" oninput="bindPhone(this.value)">
              <button class="btn" onclick="alert('ç¤ºæ„ï¼šç¶å®šæˆåŠŸ')">ç¶å®šæ‰‹æ©Ÿï¼ˆç¤ºæ„ï¼‰</button>
            </div>
            <p id="identityInfo" class="muted mt-1">å°šæœªç¶å®šæ‰‹æ©Ÿ</p>
            <button class="btn ghost mt-1" onclick="createGuild()">å‰µç«‹å…¬æœƒ</button>
          </div>

          <div class="card">
            <h3 class="mt-0">VIP ç­‰ç´š / ç°½åˆ°</h3>
            <p>ç´¯ç©æ¶ˆè²»ï¼š<b id="lifetimeSpend">$0</b> ï½œ ç›®å‰ç­‰ç´šï¼š<b id="vipLevel">V0</b></p>
            <p class="muted">ä¸‹ä¸€ç´šé‚„å·®ï¼š<span id="vipNext">$200</span></p>
            <div class="inline">
              <button class="btn" onclick="dailyCheckin()">æ¯æ—¥ç°½åˆ°</button>
              <button class="btn secondary" id="lineBtn" onclick="toggleLine()">ç¶å®š LINEï¼ˆç¤ºæ„ï¼‰</button>
            </div>
            <p id="checkinInfo" class="muted mt-1"></p>
          </div>

          <div class="card">
            <h3 class="mt-0">ä»»å‹™èˆ‡è²¢ç»</h3>
            <p>å…¬æœƒï¼š<b id="guildName">ï¼ˆå°šæœªå‰µç«‹ï¼‰</b> ï½œ ç­‰ç´šï¼š<b id="guildLevel">â€“</b></p>
            <p>è²¢ç»ï¼š<b id="guildContrib">0</b></p>
            <div class="inline">
              <button class="btn" onclick="contribute(50)">æ—¥å¸¸ä»»å‹™ +50</button>
              <button class="btn secondary" onclick="mockWar()">åƒèˆ‡å€åŸŸæˆ°</button>
            </div>
            <table class="table mt-1">
              <thead><tr><th>åæ¬¡</th><th>å…¬æœƒ</th><th>å€åŸŸ</th><th>åˆ†æ•¸</th></tr></thead>
              <tbody id="warTable"></tbody>
            </table>
          </div>
        </div>
        <button class="hbtn next" aria-label="ä¸‹ä¸€æ’">&rsaquo;</button>
      </div>

      <div class="card">
        <h3 class="mt-0">åŠ å…¥å…¬æœƒå¯äº«å…è²»å¥æª¢ï¼ˆå¹´ 1 æ¬¡ï¼‰</h3>
        <p class="muted">é¸åœ°å€ â†’ é¡¯ç¤ºåˆä½œç¸é†«ã€‚å¥æª¢å®Œæˆå›å‚³å ±å‘Šå¯å¾—å…¬æœƒè²¢ç»ã€‚</p>
        <form class="grid g-2" onsubmit="return bookVet(event)">
          <div><label>è²“å’ªæš±ç¨±<input class="input" required></label></div>
          <div><label>åŸå¸‚<select id="vetCity" class="input"></select></label></div>
          <div class="gcol-2"><label>å‚™è¨»<textarea class="input"></textarea></label></div>
          <div class="inline"><button class="btn" type="submit">é ç´„ï¼ˆç¤ºç¯„ï¼‰</button></div>
        </form>
        <div id="vetList" class="muted mt-1"></div>
      </div>
    </section>
  </section>

  <!-- Avatar (è§’è‰²å»ºç«‹å…¥å£ï¼Œå…ˆåšä½”ä½) -->
  <section id="avatar" class="page card">
    <span class="pill">Avatar</span>
    <h2 class="mt-0">å»ºç«‹ä¸»å­è§’è‰²ï¼ˆé ç•™ï¼‰</h2>
    <p class="muted">ä¸Šå‚³å¤§é ­ç…§ã€é¸å“ç¨®ã€èª¿æ•´å¤–è§€ï¼ˆæœè£ã€é…ä»¶ã€è‡‰éƒ¨ç´‹è·¯â€¦ï¼‰ã€‚æ­¤å€å…ˆåšå°è¦½èªªæ˜ï¼Œå¾ŒçºŒå†æ¥å®Œæ•´ç·¨è¼¯å™¨ã€‚</p>
    <div class="inline">
      <button class="btn">ä¸Šå‚³å¤§é ­ç…§ï¼ˆç¤ºç¯„ï¼‰</button>
      <button class="btn secondary">é¸æ“‡å“ç¨®ï¼ˆç¤ºç¯„ï¼‰</button>
    </div>
  </section>

  <!-- Kiosk -->
  <section id="kiosk" class="page">
    <section class="band band-alt">
      <header class="section-head">
        <div>
          <span class="pill">Kiosk</span>
          <h2 class="mt-0">è²©è³£æ©Ÿé»ä½</h2>
          <p class="section-sub">é»æ“Šæ¨™è¨˜å¯é–‹å•Ÿ Google/Apple Maps å°èˆªã€‚</p>
        </div>
      </header>
      <div id="map" class="map"></div>
    </section>
  </section>

  <!-- Community -->
  <section id="community" class="page">
    <section class="band">
      <header class="section-head">
        <div>
          <span class="pill">Community</span>
          <h2 class="mt-0">ç…§ç‰‡ç‰†ï¼ˆæœ¬æ©Ÿç¤ºç¯„ï¼‰</h2>
        </div>
      </header>
      <div class="card">
        <div class="inline">
          <input type="file" accept="image/*" onchange="addPhoto(event)">
          <button class="btn secondary" onclick="clearWall()">æ¸…é™¤æ‰€æœ‰ç…§ç‰‡ï¼ˆæœ¬æ©Ÿï¼‰</button>
        </div>
        <div id="wall" class="grid g-3 mt-2"></div>
      </div>
    </section>
  </section>

  <!-- About -->
  <section id="about" class="page">
    <section class="band band-alt">
      <header class="section-head">
        <div>
          <span class="pill">About</span>
          <h2 class="mt-0">æˆ‘å€‘çš„ç†å¿µ</h2>
        </div>
      </header>
      <div class="grid g-3">
        <div class="card"><h3 class="mt-0">ä¾¿åˆ©</h3><p class="muted">å¿«é€Ÿåˆ°è²¨ã€é è³¼/è¨‚é–±ã€åœ¨åœ°æ“šé»è£œçµ¦ã€‚</p></div>
        <div class="card"><h3 class="mt-0">å¯æ„›</h3><p class="muted">è§’è‰²é¤Šæˆèˆ‡ä»»å‹™åŒ–ï¼Œè£œçµ¦ä¹Ÿèƒ½å¾ˆæœ‰è¶£ã€‚</p></div>
        <div class="card"><h3 class="mt-0">æ°¸çºŒ</h3><p class="muted">æ¸›å°‘åŒ…æã€é›†ä¸­é…é€ã€é¼“å‹µå›æ”¶å†åˆ©ç”¨ã€‚</p></div>
      </div>
    </section>
  </section>

  <!-- Contact -->
  <section id="contact" class="page">
    <section class="band">
      <header class="section-head">
        <div>
          <span class="pill">Contact</span>
          <h2 class="mt-0">è¯çµ¡æˆ‘å€‘</h2>
        </div>
      </header>
      <div class="card">
        <form class="grid g-2" onsubmit="return submitForm(event)">
          <div><label>æ‚¨çš„ç¨±å‘¼<input class="input" required></label></div>
          <div><label>Email<input type="email" class="input" required></label></div>
          <div class="gcol-2"><label>è¨Šæ¯<textarea class="input" required></textarea></label></div>
          <div class="inline"><button class="btn" type="submit">é€å‡º</button></div>
        </form>
        <p class="muted mt-1">ä¹Ÿå¯ä¾†ä¿¡ï¼š<a href="mailto:hello@purrgo.tw">hello@purrgo.tw</a> ï½œ LINE å®˜æ–¹ï¼š@purrgo</p>
      </div>
    </section>
  </section>

</main>

<footer class="container footer">
  Â© PurrGo å–µä¾†é€Ÿ ï½œ å…¬é–‹ Demo
</footer>

<!-- å³ä¸‹æµ®å‹•æŒ‰éˆ• FABï¼ˆç”¨æ–‡å­—ï¼‰ -->
<div class="fab" id="fab" aria-label="å¿«é€Ÿå°è¦½">
  <button class="fab-btn" onclick="scrollToHash('home')"><span>Top</span></button>
  <button class="fab-btn" onclick="scrollToHash('products')"><span>Shop</span></button>
  <button class="fab-btn" onclick="scrollToHash('guild')"><span>Guild</span></button>
  <button class="fab-btn" onclick="scrollToHash('kiosk')"><span>Map</span></button>
  <button class="fab-btn" onclick="scrollToHash('contact')"><span>Msg</span></button>
</div>

<!-- ========== Main Script ========== -->
<script>
/* ===== å…¨åŸŸ Stateï¼ˆæœ¬æ©Ÿå­˜ï¼‰ ===== */
const LS_KEY = 'purrgoState';
const state = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
state.user   ||= { phone:'', line:false, vipXp:0, lifetimeSpend:0, energy:0, lastCheckin:'' };
state.guild  ||= { name:'', level:0, contribution:0 };
state.cart   ||= [];
state.wall   ||= [];
state.vet    ||= [];
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); renderIdentity(); renderVIP(); renderGuild(); renderCart(); renderWall(); }

/* ===== Nav é«˜äº®ï¼ˆæ¡Œæ©Ÿ tabsï¼‰ ===== */
function highlight(){
  const hash=(location.hash||'#home').replace('#','');
  document.querySelectorAll('.tab').forEach(a=>{
    a.setAttribute('aria-current', a.dataset.sec===hash ? 'page' : 'false');
  });
}
window.addEventListener('hashchange', highlight);

/* ===== å¹³æ»‘æ»¾å‹• ===== */
function scrollToHash(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.scrollIntoView({ behavior:'smooth', block:'start' });
  setTimeout(highlight, 300);
}

/* ===== æ¼¢å ¡é¸å–® ===== */
const menu          = document.getElementById('menu');
const menuBackdrop  = document.getElementById('menuBackdrop');
const menuToggleBtn = document.querySelector('.menu-toggle');

function openMenu(){
  document.body.classList.add('menu-open');
  menu.classList.add('open');
  menuBackdrop.classList.add('show');
  menuToggleBtn?.setAttribute('aria-expanded','true');
}
function closeMenu(){
  document.body.classList.remove('menu-open');
  menu.classList.remove('open');
  menuBackdrop.classList.remove('show');
  menuToggleBtn?.setAttribute('aria-expanded','false');
}
function toggleMenu(){ menu.classList.contains('open') ? closeMenu() : openMenu(); }
menuToggleBtn?.addEventListener('click', toggleMenu);
menuBackdrop?.addEventListener('click', closeMenu);
window.addEventListener('keydown', e => { if(e.key === 'Escape') closeMenu(); });

/* ===== èº«åˆ† / ç¶å®š / VIP ===== */
function bindPhone(v){ state.user.phone=v||''; save(); }
function toggleLine(){ state.user.line=!state.user.line; save(); }
function renderIdentity(){
  const el = document.getElementById('identityInfo');
  if(!el) return;
  el.textContent = state.user.phone ? `å·²ç¶å®šï¼š${state.user.phone} ï½œ LINEï¼š${state.user.line?'å·²é€£çµ':'æœªé€£çµ'}` : 'å°šæœªç¶å®šæ‰‹æ©Ÿ';
  const lb = document.getElementById('lineBtn');
  if(lb) lb.textContent = state.user.line? 'å–æ¶ˆ LINE é€£çµï¼ˆç¤ºæ„ï¼‰' : 'ç¶å®š LINEï¼ˆç¤ºæ„ï¼‰';
}
function vipLevelByXp(x){ if(x>=5000) return 5; if(x>=3000) return 4; if(x>=1500) return 3; if(x>=600) return 2; if(x>=200) return 1; return 0; }
function nextVipNeed(x){ const br=[200,600,1500,3000,5000]; for(const b of br){ if(x<b) return b-x; } return 0; }
function renderVIP(){
  const xp = state.user.vipXp|0;
  const spend = (state.user.lifetimeSpend||0);
  const elSpend=document.getElementById('lifetimeSpend');
  const elLv=document.getElementById('vipLevel');
  const elNext=document.getElementById('vipNext');
  if(elSpend) elSpend.textContent = `$${spend.toLocaleString()}`;
  if(elLv)    elLv.textContent = 'V'+vipLevelByXp(xp);
  if(elNext)  elNext.textContent = nextVipNeed(xp)>0? `$${nextVipNeed(xp)}`:'å·²é”é ‚ç´š';
}
function dailyCheckin(){
  const today = new Date().toISOString().slice(0,10);
  if(state.user.lastCheckin===today){ const i=document.getElementById('checkinInfo'); if(i) i.textContent='ä»Šå¤©å·²ç°½åˆ°'; return; }
  state.user.lastCheckin=today; state.user.energy+=10; state.user.vipXp+=10;
  const i=document.getElementById('checkinInfo'); if(i) i.textContent='ç°½åˆ°æˆåŠŸï¼š+10 èƒ½é‡ã€+10 VIP XP'; save();
}

/* ===== ç”¢å“ / è³¼ç‰©è»Š ===== */
async function loadProducts(){
  try{
    const res = await fetch('./data/products.json',{cache:'no-cache'});
    const list = await res.json();
    const row = document.getElementById('productRow');
    if(!row) return;
    row.innerHTML='';
    list.forEach(p=>{
      const el = document.createElement('div'); el.className='card product';
      el.innerHTML = `
        <img src="${p.img||''}" alt="" class="product-img" onerror="this.style.display='none'">
        <h3 class="mt-0">${p.name}</h3>
        <div class="muted">${p.spec||''}</div>
        <div class="mt-1"><b>NT$ ${p.price.toLocaleString()}</b></div>
        <ul class="list">${(p.bullets||[]).map(b=>`<li>${b}</li>`).join('')}</ul>
        <div class="inline mt-1">
          <button class="btn" onclick='addToCart(${JSON.stringify(p).replace(/'/g,"&#39;")})'>åŠ å…¥è³¼ç‰©è»Š</button>
          <button class="btn secondary" onclick='alert(${JSON.stringify(p.desc||"å•†å“ä»‹ç´¹ï¼ˆç¤ºç¯„ï¼‰").replace(/'/g,"&#39;")})'>æŸ¥çœ‹è©³æƒ…</button>
        </div>`;
      row.appendChild(el);
    });
  }catch(e){ console.error(e); }
}
function addToCart(p){ const item = state.cart.find(i=>i.id===p.id) || (state.cart.push({...p,qty:0}), state.cart.find(i=>i.id===p.id)); item.qty++; save(); }
function clearCart(){ state.cart=[]; save(); }
function renderCart(){
  const box = document.getElementById('cartItems'); if(!box) return;
  if(state.cart.length===0){ box.textContent='å°šç„¡å•†å“'; return; }
  let sum=0; box.innerHTML = state.cart.map(i=>{ sum+=i.price*i.qty; return `${i.name} Ã— ${i.qty} = NT$ ${(i.price*i.qty).toLocaleString()}`; }).join('<br>');
  box.innerHTML += `<div class="mt-1"><b>å°è¨ˆï¼šNT$ ${sum.toLocaleString()}</b></div>`;
}
function checkout(){
  if(state.cart.length===0) return alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
  const sum = state.cart.reduce((a,b)=>a+b.price*b.qty,0);
  state.user.lifetimeSpend = (state.user.lifetimeSpend||0) + sum;
  state.user.vipXp += Math.round(sum/10);
  state.user.energy += Math.round(sum/20);
  state.cart=[]; alert(`çµå¸³æˆåŠŸï¼ç´¯ç©æ¶ˆè²» +$${sum.toLocaleString()}ï¼ŒVIP XP èˆ‡èƒ½é‡å·²å¢åŠ `);
  save();
}

/* ===== å…¬æœƒ ===== */
const GUILD_CREATE_NEED = 1200;
function renderGuild(){
  const g=state.guild;
  const Q=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=v; };
  Q('guildName', g.name||'ï¼ˆå°šæœªå‰µç«‹ï¼‰');
  Q('guildLevel', g.level||'â€“');
  Q('guildContrib', g.contribution|0);
}
function createGuild(){
  if((state.user.lifetimeSpend||0) < GUILD_CREATE_NEED){ return alert('å°šæœªé”åˆ°å‰µç«‹é–€æª»ï¼šç´¯ç©æ¶ˆè²» $1,200'); }
  const name = prompt('è¼¸å…¥å…¬æœƒåç¨±'); if(!name) return;
  state.guild.name=name; state.guild.level=1; save(); alert('å…¬æœƒå·²å‰µç«‹ï¼');
}
function contribute(n){ if(!state.guild.name) return alert('è«‹å…ˆå‰µç«‹å…¬æœƒ'); state.guild.contribution += n; if(state.guild.contribution>= (state.guild.level*500)) { state.guild.level++; alert('å…¬æœƒå‡ç´šï¼'); } save(); }
function mockWar(){ if(!state.guild.name) return alert('è«‹å…ˆå‰µç«‹å…¬æœƒ'); const add=Math.floor(Math.random()*500+100); const tr=document.createElement('tr'); tr.innerHTML=`<td>*</td><td>${state.guild.name}</td><td>ä½ çš„å€åŸŸ</td><td>+${add}</td>`; document.getElementById('warTable').prepend(tr); }

/* ===== å¥æª¢é ç´„ï¼ˆç¤ºç¯„ï¼‰ ===== */
async function initVetCities(){
  try{
    const res=await fetch('./data/hospitals.json',{cache:'no-cache'});
    const list=await res.json();
    const citySet=[...new Set(list.map(x=>x.city))];
    const sel=document.getElementById('vetCity'); if(!sel) return;
    sel.innerHTML = citySet.map(c=>`<option>${c}</option>`).join('');
  }catch(e){}
}
function bookVet(e){ e.preventDefault(); const f=e.target; const rec={ name:f[0].value, city:f[1].value, note:f[2].value, time:new Date().toLocaleString() }; state.vet.push(rec); save(); f.reset(); alert('å·²å»ºç«‹é ç´„ï¼ˆç¤ºç¯„ï¼‰'); return false; }
function renderVet(){ const box=document.getElementById('vetList'); if(!box) return; if(!state.vet.length){ box.textContent='ç›®å‰ç„¡é ç´„ç´€éŒ„ï¼ˆç¤ºç¯„ï¼‰'; return;} box.innerHTML = 'é ç´„ç´€éŒ„ï¼š<br>'+state.vet.map(v=>`${v.time}ï½œ${v.city}ï½œ${v.name}`).join('<br>'); }

/* ===== ç…§ç‰‡ç‰†ï¼ˆæœ¬æ©Ÿï¼‰ ===== */
function addPhoto(e){ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ state.wall.push(reader.result); save(); }; reader.readAsDataURL(file); }
function renderWall(){ const wall=document.getElementById('wall'); if(!wall) return; wall.innerHTML=''; (state.wall||[]).forEach(src=>{ const img=new Image(); img.src=src; img.style.borderRadius='12px'; wall.appendChild(img); }); }
function clearWall(){ if(confirm('æ¸…é™¤æ‰€æœ‰æœ¬æ©Ÿç…§ç‰‡ï¼Ÿ')){ state.wall=[]; save(); }}

/* ===== åœ°åœ– ===== */
async function initMap(){
  const map=L.map('map').setView([25.0330,121.5654],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(map);
  try{
    const res = await fetch('./data/locations.json',{cache:'no-cache'}); const points = await res.json();
    points.forEach(p=>{
      const m=L.marker([p.lat,p.lng]).addTo(map);
      const gLink = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
      const aLink = `https://maps.apple.com/?q=${p.lat},${p.lng}`;
      m.bindPopup(`<b>${p.name}</b><br>${p.address||''}<br><a href='${gLink}' target='_blank'>Google</a> ï½œ <a href='${aLink}' target='_blank'>Apple</a>`);
    });
  }catch(e){}
}

/* ===== æ©«å‘æ»‘å‹•æŒ‰éˆ•ï¼ˆå·¦å³ï¼‰ ===== */
function setupHScroll(){
  document.querySelectorAll('.hwrap').forEach(w=>{
    const prev=w.querySelector('.prev'), next=w.querySelector('.next'), row=w.querySelector('.hscroll');
    if(!row) return;
    const step = () => row.clientWidth * 0.8;
    prev?.addEventListener('click', ()=> row.scrollBy({left:-step(), behavior:'smooth'}));
    next?.addEventListener('click', ()=> row.scrollBy({left:+step(), behavior:'smooth'}));
  });
}

/* ===== å•Ÿå‹• ===== */
window.addEventListener('DOMContentLoaded', async () => {
  highlight();
  setupHScroll();
  await loadProducts();
  await initVetCities();
  renderVet();
  renderCart();
  renderWall();
  renderIdentity(); renderVIP(); renderGuild();
  initMap();

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js?v=6').catch(()=>{});
  }
});
</script>
</body>
</html>
