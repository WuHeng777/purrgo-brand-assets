<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PurrGo 喵來速｜品牌官網 Demo</title>

  <!-- PWA / Icons（相對路徑） -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./logo/favicon.png">
  <link rel="apple-touch-icon" sizes="192x192" href="./logo/logo-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="./logo/logo-512.png">
  <meta name="theme-color" content="#ff7f50">
  <link rel="stylesheet" href="./style.css?v=20250904-1">
</head>
<body>

<!-- ===== 頂部：品牌、訪客/登入、漢堡 ===== -->
<header>
  <div class="container topbar">
    <a class="brand" href="#home" onclick="showPage('home');return false;">
      <img src="./logo/logo-192.png" alt="PurrGo"><span>PurrGo 喵來速</span>
    </a>
    <div class="auth">
      <span id="userLabel">訪客</span><span class="sep">｜</span>
      <a class="link" href="#" onclick="openLogin();return false;">登入</a>
    </div>
    <button class="menu-toggle" aria-label="開啟選單" onclick="openMenu()">
      <span class="menu-ico" aria-hidden="true"></span>
    </button>
  </div>
  <nav id="menu" class="menu" aria-label="主選單">
    <a href="#home"     onclick="navTo('home')">首頁</a>
    <a href="#products" onclick="navTo('products')">產品</a>
    <a href="#guild"    onclick="navTo('guild')">公會</a>
    <a href="#kiosk"    onclick="navTo('kiosk')">據點</a>
    <a href="#photos"   onclick="navTo('photos')">照片牆</a>
    <a href="#social"   onclick="navTo('social')">社群</a>
    <a href="#chat"     onclick="navTo('chat')">聊天</a>
    <a href="#video"    onclick="navTo('video')">短影片</a>
    <a href="#about"    onclick="navTo('about')">理念</a>
    <a href="#contact"  onclick="navTo('contact')">聯絡</a>
  </nav>
  <div id="menuBackdrop" class="menu-backdrop" onclick="closeMenu()"></div>
</header>

<!-- ===== 主內容 ===== -->
<main class="container">

  <!-- ============ 首頁 ============ -->
  <section id="page-home" class="page">
    <div class="section-caption">首頁</div>

    <section class="hero card">
      <div class="hero-copy">
        <span class="pill">PurrGo 喵來速</span>
        <h1 class="hero-title">便利 × 可愛 × 永續 × 共創</h1>
        <p class="muted">用創新配送＋公會制度，讓補給更聰明、更便宜、更好玩。把「買貓砂」變成有成就感的里程碑遊戲。</p>
        <div class="inline mt-1">
          <a class="btn" onclick="showPage('products')">開始探索產品</a>
          <a class="btn secondary" onclick="showPage('guild')">加入貓奴公會</a>
          <a class="btn secondary" onclick="showPage('about')">了解品牌理念</a>
        </div>
      </div>
      <div class="hero-visual">
        <img class="hero-logo" src="./logo/logo-512.png" alt="PurrGo Logo">
      </div>
    </section>

    <!-- 建立主子角色：不限數量、生日自動算年齡、第一張頭像自動進相簿 -->
    <section class="card">
      <span class="pill">主子</span>
      <h2 class="mt-0">建立主子角色</h2>
      <form class="grid g-2" onsubmit="return addPet(event)">
        <div><label>暱稱<input class="input" name="name" required></label></div>
        <div><label>性別<select class="input" name="sex"><option value="M">公</option><option value="F">母</option></select></label></div>
        <div><label>生日<input class="input" name="birth" type="date" required></label></div>
        <div><label>品種<select class="input" id="breedSelect" name="breed"></select></label></div>
        <div class="gcol-2"><label>大頭照<input class="input" name="avatar" type="file" accept="image/*"></label></div>
        <div class="inline"><button class="btn" type="submit">新增主子</button></div>
      </form>
      <div id="petRow" class="p-row mt-2"></div>
    </section>
  </section>

  <!-- ============ 產品 ============ -->
  <section id="page-products" class="page" hidden>
    <div class="section-caption">產品</div>
    <section class="band">
      <header class="section-head"><div>
        <span class="pill">Products</span>
        <h2 class="mt-0">熱銷與方案</h2>
        <p class="muted">橫向滑動卡片，支援產品照片、詳情彈窗與加入購物車。</p>
      </div></header>

      <div class="hwrap" style="position:relative">
        <button class="hbtn prev" aria-label="上一個" onclick="scrollH('productRow',-1)" style="position:absolute;left:-6px;top:50%;transform:translateY(-50%);border:0;background:#1a1b1e;color:#fff;width:36px;height:36px;border-radius:50%">‹</button>
        <div id="productRow" class="hscroll" style="display:flex;gap:12px;overflow:auto;scroll-snap-type:x mandatory;padding-bottom:6px"></div>
        <button class="hbtn next" aria-label="下一個" onclick="scrollH('productRow',1)"  style="position:absolute;right:-6px;top:50%;transform:translateY(-50%);border:0;background:#1a1b1e;color:#fff;width:36px;height:36px;border-radius:50%">›</button>
      </div>

      <section class="card mt-2">
        <h3 class="mt-0">購物車（示範）</h3>
        <div id="cartItems" class="muted">尚無商品</div>
        <div class="inline mt-1">
          <button class="btn" onclick="checkout()">結帳（示範）</button>
          <button class="btn secondary" onclick="clearCart()">清空</button>
        </div>
      </section>
    </section>
  </section>

  <!-- ============ 公會 / 健檢 ============ -->
  <section id="page-guild" class="page" hidden>
    <div class="section-caption">公會</div>
    <section class="band">
      <header class="section-head"><div>
        <span class="pill">Guild</span>
        <h2 class="mt-0">公會制度：一起成長、一起更省</h2>
        <p class="muted">創立門檻、VIP 等級、貢獻條、每日任務…</p>
      </div></header>

      <!-- 身分綁定 / VIP -->
      <section class="card">
        <h3 class="mt-0">身份綁定 / VIP</h3>
        <div class="grid g-2">
          <div>
            <label>輸入手機號碼<input class="input" id="phoneInput" placeholder="09xxxxxxxx"></label>
            <div class="inline mt-1">
              <button class="btn" onclick="bindPhone(document.getElementById('phoneInput').value)">綁定手機（示意）</button>
              <button id="lineBtn" class="btn secondary" onclick="toggleLine()">綁定 LINE（示意）</button>
            </div>
            <div id="identityInfo" class="muted mt-1"></div>
          </div>
          <div>
            <div>累積消費：<b id="lifetimeSpend">$0</b></div>
            <div class="mt-1">VIP 等級：<b id="vipLevel">V0</b> ｜ 下一級還差：<b id="vipNext">$0</b></div>
            <div class="inline mt-1">
              <button class="btn" onclick="dailyCheckin()">每日簽到 + 能量 / XP</button>
              <span id="checkinInfo" class="muted"></span>
            </div>
          </div>
        </div>
      </section>

      <!-- 健檢報告上傳（需先有主子 & 公會） -->
      <section class="card">
        <h3 class="mt-0">免費健檢（每年 1 次 / 需加入公會）</h3>
        <div class="grid g-3">
          <div>
            <label>選擇主子
              <select class="input" id="vetPet"></select>
            </label>
          </div>
          <div>
            <label>選擇城市
              <select class="input" id="vetCity" onchange="renderHospitals()">
                <option>台北</option><option>台中</option><option>高雄</option>
              </select>
            </label>
          </div>
          <div>
            <label>合作醫院
              <select class="input" id="vetHospital"></select>
            </label>
          </div>
          <div class="gcol-2">
            <label>上傳健檢報告（圖片 / PDF）
              <input class="input" id="vetFile" type="file" accept="image/*,.pdf">
            </label>
          </div>
          <div class="inline"><button class="btn" onclick="uploadVet()">送出並獲取公會貢獻</button></div>
        </div>
        <div id="vetList" class="muted mt-1">目前無健檢紀錄</div>
      </section>

      <!-- 公會基本：創立 / 貢獻條 / 區域戰 -->
      <section class="card">
        <div class="inline">
          <button class="btn" onclick="createGuild()">創立門檻（示意）</button>
          <button class="btn secondary" onclick="contribute(100)">貢獻 +100（示意）</button>
          <button class="btn secondary" onclick="mockWar()">展開：區域戰（示意）</button>
        </div>
        <div class="mt-1">公會：<b id="guildName">（尚未創立）</b> ｜ 等級：<b id="guildLevel">–</b> ｜ 貢獻值：<b id="guildContrib">0</b></div>
        <table class="table mt-2" style="width:100%;border-collapse:collapse">
          <thead><tr><th>名次</th><th>公會</th><th>區域</th><th>分數</th></tr></thead>
          <tbody id="warTable"><tr><td>1</td><td>台北抓抓隊</td><td>台北</td><td>12,340</td></tr></tbody>
        </table>
      </section>
    </section>
  </section>

  <!-- ============ 據點 / 地圖 ============ -->
  <section id="page-kiosk" class="page" hidden>
    <div class="section-caption">據點</div>
    <section class="card">
      <span class="pill">Kiosk</span>
      <h2 class="mt-0">販賣機點位</h2>
      <div id="map" style="height:360px;border-radius:12px;overflow:hidden;position:relative;z-index:1"></div>
      <div class="muted mt-1">點擊標記可開啟 Google/Apple Maps 導航。</div>
    </section>
  </section>

  <!-- ============ 照片牆 ============ -->
  <section id="page-photos" class="page" hidden>
    <div class="section-caption">照片牆</div>
    <section class="card">
      <span class="pill">Photos</span>
      <h2 class="mt-0">照片牆（依主子分相簿）</h2>
      <div class="inline">
        <label>主子
          <select class="input" id="photoPet" onchange="renderWall()"></select>
        </label>
        <input id="photoPicker" type="file" accept="image/*" multiple onchange="addPhoto(event)">
        <button class="btn secondary" onclick="clearWall()">清除本機照片</button>
      </div>
      <div id="wall" class="grid-photos mt-2"></div>
    </section>
  </section>

  <!-- ============ 社群 / 聊天 / 短影片 / 理念 / 聯絡（保留） ============ -->
  <section id="page-social"   class="page" hidden><div class="section-caption">社群</div><section class="card"><span class="pill">Social</span><h2 class="mt-0">社群（示範保留）</h2></section></section>
  <section id="page-chat"     class="page" hidden><div class="section-caption">聊天</div><section class="card"><span class="pill">Chat</span><h2 class="mt-0">聊天（示範保留）</h2></section></section>
  <section id="page-video"    class="page" hidden><div class="section-caption">短影片</div><section class="card"><span class="pill">Video</span><h2 class="mt-0">短影片（示範保留）</h2></section></section>
  <section id="page-about"    class="page" hidden><div class="section-caption">理念</div><section class="card"><span class="pill">About</span><h2 class="mt-0">我們相信「便利 × 可愛 × 永續 × 共創」</h2><p class="muted">用創新配送結合公會化社群；永續思維把日常消耗品變成參與式里程碑。</p></section></section>
  <section id="page-contact"  class="page" hidden><div class="section-caption">聯絡</div><section class="card"><span class="pill">Contact</span><h2 class="mt-0">聯絡我們</h2><form class="grid g-2" onsubmit="return submitForm(event)"><div><label>您的稱呼<input class="input" required></label></div><div><label>Email<input type="email" class="input" required></label></div><div class="gcol-2"><label>訊息<textarea class="input" required></textarea></label></div><div class="inline"><button class="btn" type="submit">送出</button></div></form><p class="muted mt-1">也可來信：<a href="mailto:hello@purrgo.tw">hello@purrgo.tw</a></p></section></section>

</main>

<footer class="container" style="padding:26px 0 60px;color:var(--muted)">
  © PurrGo 喵來速 ｜ 公開 Demo（不含投資人資訊）
</footer>

<!-- 右下 Top（單顆） -->
<div class="fab" id="fab" aria-label="快速導覽">
  <button class="fab-btn" title="回頂端" onclick="window.scrollTo({top:0,behavior:'smooth'})">Top</button>
</div>

<!-- ===== 產品詳情 Modal（保留） ===== -->
<dialog id="modal">
  <article style="padding:16px">
    <header class="inline" style="justify-content:space-between;align-items:center">
      <h3 id="mTitle" class="mt-0">產品詳情</h3>
      <button class="btn secondary" onclick="closeModal()">關閉</button>
    </header>
    <div id="mBody"></div>
    <footer class="inline mt-1">
      <button class="btn" id="mAddBtn">加入購物車</button>
    </footer>
  </article>
</dialog>

<!-- ===== 照片預覽 Dialog ===== -->
<dialog id="photoModal">
  <div class="ph-modal">
    <img id="pmImg" alt="photo">
    <div class="ph-act">
      <div id="pmMeta" class="muted">—</div>
      <div class="dock">
        <button onclick="likeCurrent()">♥ <span id="pmLike">0</span></button>
        <button onclick="addCommentCurrent()">留言</button>
        <button onclick="closePhoto()">關閉</button>
      </div>
    </div>
    <div id="pmComments" class="mt-1"></div>
  </div>
</dialog>

<!-- ===== 主子編輯 Dialog ===== -->
<dialog id="petModal">
  <div class="auth-outer">
    <div class="auth-card">
      <h3 class="mt-0">編輯主子</h3>
      <form id="petForm" class="grid g-2" onsubmit="return savePetEdit(event)">
        <div><label>暱稱<input class="input" name="name" required></label></div>
        <div><label>性別<select class="input" name="sex"><option value="M">公</option><option value="F">母</option></select></label></div>
        <div><label>生日<input class="input" name="birth" type="date" required></label></div>
        <div><label>品種<select class="input" id="editBreed" name="breed"></select></label></div>
        <div class="gcol-2"><label>更換頭像<input class="input" name="avatar" type="file" accept="image/*"></label></div>
        <div class="inline"><button class="btn" type="submit">儲存</button><button class="btn secondary" type="button" onclick="closePet()">取消</button></div>
      </form>
    </div>
  </div>
</dialog>

<!-- ===== 登入 Dialog（首頁入口） ===== -->
<dialog id="loginModal">
  <div class="auth-outer">
    <div class="auth-card">
      <h3 class="mt-0">註冊 / 登入</h3>
      <form onsubmit="return doLogin(event)" class="grid g-2">
        <div class="gcol-2"><label>註冊 ID<input class="input" id="loginId" required></label></div>
        <div class="gcol-2"><label>密碼<input class="input" id="loginPw" type="password" required></label></div>
        <div class="gcol-2"><label>手機號碼驗證<input class="input" id="loginPhone" required></label></div>
        <div class="inline"><button class="btn" type="submit">開始使用</button><button class="btn secondary" type="button" onclick="el('loginModal').close()">取消</button></div>
      </form>
      <div class="inline mt-1">
        <button class="btn secondary">使用 LINE 登入（示意）</button>
        <button class="btn secondary">使用 Facebook 登入（示意）</button>
        <button class="btn secondary">使用 Instagram 登入（示意）</button>
        <button class="btn secondary">使用 Gmail 登入（示意）</button>
      </div>
    </div>
  </div>
</dialog>

<!-- Leaflet JS（地圖） -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

<!-- ===== Main Script（保留你 99% 版邏輯＋增修） ===== -->
<script>
/* ===== 全域狀態（localStorage） ===== */
const LS_KEY = 'purrgoState';
const state = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
state.user ||= null; // { id:'...' }
state.guild ||= { name:'', level:0, contribution:0 };
state.cart  ||= [];
state.pets  ||= [];             // {id,name,sex,birth,breed,avatar}
state.vet   ||= [];             // {petId, city, hospital, fileName, time}
state.photos ||= {};            // petId -> [{src, likes, comments:[{text,time}]}]
state.friends ||= [];
state.blocks  ||= [];
state.chats   ||= {};
state.videos  ||= [];
state.userExtra ||= { phone:'', line:false, vipXp:0, lifetimeSpend:0, energy:0, lastCheckin:'' }; // 繼承舊欄位
save();
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); renderAll(); }

/* ===== SPA 分頁 ===== */
const pages = ["home","products","guild","kiosk","photos","social","chat","video","about","contact"];
function showPage(sec){
  pages.forEach(id=>{
    const el = document.getElementById('page-'+id);
    if(el) el.hidden = (id!==sec);
  });
  closeMenu();
  location.hash = '#'+sec;
  if(sec==='kiosk'){ setTimeout(initMap, 50); }
  if(sec==='photos'){ renderWall(); }
}
function navTo(id){ closeMenu(); showPage(id); return false; }
function restorePage(){ const h=(location.hash||'#home').slice(1); showPage(pages.includes(h)?h:'home'); }

/* ===== 手機選單 ===== */
function openMenu(){ el('menu').classList.add('open'); el('menuBackdrop').classList.add('show'); }
function closeMenu(){ el('menu').classList.remove('open'); el('menuBackdrop').classList.remove('show'); }

/* ===== 身份 / VIP（沿用你原本） ===== */
function bindPhone(v){ state.userExtra.phone=v||''; save(); }
function toggleLine(){ state.userExtra.line=!state.userExtra.line; save(); }
function vipLevelByXp(x){ if(x>=5000) return 5; if(x>=3000) return 4; if(x>=1500) return 3; if(x>=600) return 2; if(x>=200) return 1; return 0; }
function nextVipNeed(x){ const br=[200,600,1500,3000,5000]; for(const b of br){ if(x<b) return b-x; } return 0; }
function dailyCheckin(){
  const today = new Date().toISOString().slice(0,10);
  if(state.userExtra.lastCheckin===today){ el('checkinInfo').textContent='今天已簽到'; return; }
  state.userExtra.lastCheckin=today; state.userExtra.energy+=10; state.userExtra.vipXp+=10;
  el('checkinInfo').textContent='簽到成功：+10 能量、+10 VIP XP'; save();
}
function renderIdentity(){
  const u=state.userExtra;
  const info = u.phone? `已綁定：${u.phone} ｜ LINE：${u.line?'已連結':'未連結'}` : '尚未綁定手機';
  if(el('identityInfo')) el('identityInfo').textContent = info;
  if(el('lineBtn')) el('lineBtn').textContent = u.line? '取消 LINE 連結（示意）':'綁定 LINE（示意）';
  if(el('lifetimeSpend')) el('lifetimeSpend').textContent = `$${(u.lifetimeSpend||0).toLocaleString()}`;
  if(el('vipLevel')) el('vipLevel').textContent = 'V'+vipLevelByXp(u.vipXp|0);
  if(el('vipNext')) el('vipNext').textContent = nextVipNeed(u.vipXp|0)>0? `$${nextVipNeed(u.vipXp|0)}`:'已達頂級';
}

/* ===== 登入（Demo） ===== */
function openLogin(){ el('loginModal').showModal(); }
function doLogin(e){
  e.preventDefault();
  const id = el('loginId').value.trim();
  state.user = { id };
  save();
  el('loginModal').close();
}

/* ===== 主子（多貓） ===== */
function loadBreeds(){
  const breeds = ["美國短毛貓","英國短毛貓","蘇格蘭摺耳貓","布偶貓","米克斯","挪威森林貓","波斯貓","孟加拉豹貓"];
  const selA = el('breedSelect'), selB = el('editBreed');
  [selA, selB].forEach(sel=>{
    if(!sel) return;
    sel.innerHTML='';
    breeds.forEach(b=>{ const o=document.createElement('option'); o.value=o.textContent=b; sel.appendChild(o); });
  });
}
function ageFromBirth(iso){ if(!iso) return ''; const b=new Date(iso); const n=new Date(); let y=n.getFullYear()-b.getFullYear(); let m=n.getMonth()-b.getMonth(); if(m<0){y--;m+=12;} return `${y}歲${m>0?m+'個月':''}`; }

function addPet(e){
  e.preventDefault();
  const f=e.target;
  const p={ id:crypto.randomUUID(), name:f.name.value.trim(), sex:f.sex.value, birth:f.birth.value, breed:f.breed.value, avatar:'' };
  const file=f.avatar.files[0];

  const pushAndSave=()=>{
    state.pets.push(p);
    if(p.avatar){ (state.photos[p.id]=state.photos[p.id]||[]).unshift({src:p.avatar,likes:0,comments:[]}); }
    save(); f.reset();
  };

  if(file){
    const rd=new FileReader();
    rd.onload=()=>{ p.avatar=rd.result; pushAndSave(); };
    rd.readAsDataURL(file);
  }else{
    pushAndSave();
  }
}
function renderPets(){
  const row = el('petRow'); if(row){ row.innerHTML='';
    state.pets.forEach(pt=>{
      const card=document.createElement('button');
      card.type='button'; card.className='p-card'; card.onclick=()=>openPet(pt.id);
      card.innerHTML = `
        <img src="${pt.avatar || './logo/logo-192.png'}" alt="" class="p-avatar">
        <div>
          <div><b>${pt.name}</b>｜${pt.breed||'未知'}｜${pt.sex==='M'?'公':'母'}</div>
          <div class="muted">年齡：${ageFromBirth(pt.birth)}</div>
        </div>
        <span class="p-edit btn secondary">編輯</span>`;
      row.appendChild(card);
    });
  }
  // 同步下拉
  if(el('photoPet')){ const s=el('photoPet'); s.innerHTML=''; state.pets.forEach(pt=>{ const o=document.createElement('option'); o.value=pt.id; o.textContent=pt.name; s.appendChild(o); }); }
  if(el('vetPet')){ const v=el('vetPet'); v.innerHTML=''; state.pets.forEach(pt=>{ const o=document.createElement('option'); o.value=pt.id; o.textContent=pt.name; v.appendChild(o); }); }
}
let _editPid=null;
function openPet(pid){
  _editPid=pid;
  const p=state.pets.find(x=>x.id===pid); if(!p) return;
  const f=el('petForm');
  f.name.value=p.name; f.sex.value=p.sex; f.birth.value=p.birth; f.breed.value=p.breed;
  el('petModal').showModal();
}
function closePet(){ el('petModal').close(); _editPid=null; }
function savePetEdit(e){
  e.preventDefault();
  if(!_editPid) return false;
  const f=e.target; const p=state.pets.find(x=>x.id===_editPid); if(!p) return false;
  const file=f.avatar.files[0];
  const apply=()=>{ p.name=f.name.value.trim(); p.sex=f.sex.value; p.birth=f.birth.value; p.breed=f.breed.value; save(); closePet(); };
  if(file){ const rd=new FileReader(); rd.onload=()=>{ p.avatar=rd.result; apply(); }; rd.readAsDataURL(file); } else { apply(); }
  return false;
}

/* ===== 健檢（需主子 & 公會） ===== */
function renderHospitals(){
  const city = el('vetCity')?.value || '台北';
  fetch('./data/hospitals.json').then(r=>r.json()).then(list=>{
    const s=el('vetHospital'); if(!s) return; s.innerHTML='';
    list.filter(h=>h.city===city).forEach(h=>{ const o=document.createElement('option'); o.textContent=h.name; o.value=h.name; s.appendChild(o); });
  }).catch(()=>{});
}
function uploadVet(){
  if(!state.pets.length) return alert('請先建立主子');
  if(!state.guild.name) return alert('請先加入/創立公會');
  const pid=el('vetPet').value, city=el('vetCity').value, hosp=el('vetHospital').value;
  const f=el('vetFile').files[0]; if(!f) return alert('請選擇檔案');
  state.vet.push({ petId: pid, city, hospital:hosp, fileName:f.name, time:new Date().toLocaleString() });
  state.guild.contribution+=200; save(); alert('已上傳（示範）並獲得 +200 公會貢獻');
}
function renderVet(){
  renderHospitals();
  const box=el('vetList'); if(!box) return;
  if(!state.vet.length){ box.textContent='目前無健檢紀錄'; return; }
  box.innerHTML = state.vet.map(v=>{ const pet=state.pets.find(p=>p.id===v.petId); return `${v.time}｜${v.city}｜${v.hospital}｜${pet?pet.name:'（已刪除）'}｜${v.fileName}`; }).join('<br>');
}

/* ===== 公會基本 ===== */
const GUILD_CREATE_NEED = 1200;
function renderGuild(){
  if(el('guildName')) el('guildName').textContent = state.guild.name||'（尚未創立）';
  if(el('guildLevel')) el('guildLevel').textContent = state.guild.level||'–';
  if(el('guildContrib')) el('guildContrib').textContent = state.guild.contribution|0;
}
function createGuild(){
  if((state.userExtra.lifetimeSpend||0) < GUILD_CREATE_NEED){ return alert('尚未達到創立門檻：累積消費 $1,200'); }
  const name = prompt('輸入公會名稱'); if(!name) return;
  state.guild.name=name; state.guild.level=1; save(); alert('公會已創立！');
}
function contribute(n){ if(!state.guild.name) return alert('請先創立公會'); state.guild.contribution += n; if(state.guild.contribution>= (state.guild.level*500)) { state.guild.level++; alert('公會升級！'); } save(); }
function mockWar(){ if(!state.guild.name) return alert('先創立公會'); const add=Math.floor(Math.random()*500+100); const tr=document.createElement('tr'); tr.innerHTML=`<td>*</td><td>${state.guild.name}</td><td>你的區域</td><td>+${add}</td>`; el('warTable').prepend(tr); }

/* ===== 產品 / 購物車 ===== */
async function loadProducts(){
  try{
    const list = await (await fetch('./data/products.json',{cache:'no-cache'})).json();
    const row = el('productRow'); if(!row) return; row.innerHTML='';
    list.forEach(p=>{
      const elc=document.createElement('div'); elc.className='card product';
      elc.innerHTML = `
        <img src="${p.img||'./logo/logo-512.png'}" alt="" class="prod-img">
        <h3 class="mt-0">${p.name}</h3>
        <div class="muted">規格：${p.spec||'-'}</div>
        <div class="mt-1"><b>NT$ ${p.price.toLocaleString()}</b></div>
        <div class="inline mt-1">
          <button class="btn" onclick='addToCart(${JSON.stringify(p).replace(/'/g,"&#39;")})'>加入購物車</button>
          <button class="btn secondary" onclick='openDetail(${JSON.stringify(p).replace(/'/g,"&#39;")})'>查看詳情</button>
        </div>`;
      row.appendChild(elc);
    });
  }catch(e){ if(el('productRow')) el('productRow').innerHTML='<div class="empty">讀取產品失敗</div>'; }
}
function addToCart(p){ const item = state.cart.find(i=>i.id===p.id) || (state.cart.push({...p,qty:0}), state.cart.find(i=>i.id===p.id)); item.qty++; save(); }
function clearCart(){ state.cart=[]; save(); }
function renderCart(){
  const box = el('cartItems'); if(!box) return;
  if(state.cart.length===0){ box.textContent='尚無商品'; return; }
  let sum=0; box.innerHTML = state.cart.map(i=>{ sum+=i.price*i.qty; return `${i.name} × ${i.qty} = NT$ ${(i.price*i.qty).toLocaleString()}`; }).join('<br>');
  box.innerHTML += `<div class="mt-1"><b>小計：NT$ ${sum.toLocaleString()}</b></div>`;
}
function checkout(){
  if(state.cart.length===0) return alert('購物車是空的');
  const sum = state.cart.reduce((a,b)=>a+b.price*b.qty,0);
  state.userExtra.lifetimeSpend = (state.userExtra.lifetimeSpend||0) + sum;
  state.userExtra.vipXp += Math.round(sum/10);
  state.userExtra.energy += Math.round(sum/20);
  state.cart=[]; alert(`結帳成功！累積消費 +$${sum.toLocaleString()}，VIP XP 與能量已增加`);
  save();
}
function openDetail(p){
  const m=el('modal'); el('mTitle').textContent=p.name;
  el('mBody').innerHTML = `<img src="${p.img||'./logo/logo-512.png'}" class="prod-img" style="max-height:240px"><p class="mt-1">${(p.bullets||[]).map(b=>`• ${b}`).join('<br>')}</p>`;
  const addBtn=el('mAddBtn'); addBtn.onclick=()=>{ addToCart(p); closeModal(); };
  m.showModal();
}
function closeModal(){ el('modal').close(); }

/* ===== 照片牆（IG 風） ===== */
function addPhoto(e){
  const pid=el('photoPet').value; if(!pid) return alert('請先建立主子');
  const files=[...e.target.files]; if(!files.length) return;
  files.forEach(file=>{
    const rd=new FileReader();
    rd.onload=()=>{ (state.photos[pid]=state.photos[pid]||[]).push({src:rd.result,likes:0,comments:[]}); save(); };
    rd.readAsDataURL(file);
  });
  e.target.value='';
}
function clearWall(){ const pid=el('photoPet').value; if(!pid) return; if(confirm('清除本機相簿照片？')){ state.photos[pid]=[]; save(); } }
function renderWall(){
  const s=el('photoPet'); if(!s) return;
  const pid=s.value || (state.pets[0]?.id||'');
  if(s.value!==pid) s.value=pid;
  const wall=el('wall'); wall.innerHTML='';
  (state.photos[pid]||[]).forEach((ph,idx)=>{
    const wrap=document.createElement('div'); wrap.className='ph';
    const img=document.createElement('img'); img.src=ph.src; img.alt='';
    img.onclick=()=>openPhoto(pid,idx);
    const badge=document.createElement('div'); badge.className='badge'; badge.textContent=`♥ ${ph.likes||0}`;
    wrap.appendChild(img); wrap.appendChild(badge); wall.appendChild(wrap);
  });
}

/* 照片預覽 / 愛心 / 留言 */
let _pm = { pid:null, idx:-1 };
function openPhoto(pid, idx){
  _pm = { pid, idx };
  const ph = (state.photos[pid]||[])[idx]; if(!ph) return;
  el('pmImg').src = ph.src;
  el('pmLike').textContent = ph.likes || 0;
  el('pmMeta').textContent = `相片 ${idx+1} ／ 共 ${state.photos[pid].length} 張`;
  renderPhotoComments(ph);
  el('photoModal').showModal();
}
function closePhoto(){ el('photoModal').close(); _pm = { pid:null, idx:-1 }; }
function likeCurrent(){
  if(!_pm.pid) return;
  const ph = state.photos[_pm.pid][_pm.idx];
  ph.likes = (ph.likes||0) + 1;
  el('pmLike').textContent = ph.likes;
  save();
}
function addCommentCurrent(){
  if(!_pm.pid) return;
  const t = prompt('留言內容'); if(!t) return;
  const ph = state.photos[_pm.pid][_pm.idx];
  (ph.comments = ph.comments || []).push({ text:t, time:new Date().toLocaleString() });
  renderPhotoComments(ph);
  save();
}
function renderPhotoComments(ph){
  const box = el('pmComments'); box.innerHTML = '';
  (ph.comments||[]).slice().reverse().forEach(c=>{
    const d = document.createElement('div'); d.className = 'c';
    d.textContent = `${c.text} · ${c.time}`;
    box.appendChild(d);
  });
}

/* ===== 短影片 / 社群 / 聊天（保留你原流程，如需可再接） ===== */

/* ===== 地圖（確保不蓋過選單；選單 z-index 已高於地圖） ===== */
let _map, _mapReady=false;
async function initMap(){
  if(!_map){
    _map=L.map('map'); _mapReady=true;
    _map.setView([25.0330,121.5654],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(_map);
    try{
      const points = await (await fetch('./data/locations.json',{cache:'no-cache'})).json();
      points.forEach(p=>{
        const m=L.marker([p.lat,p.lng]).addTo(_map);
        const gLink = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
        const aLink = `https://maps.apple.com/?q=${p.lat},${p.lng}`;
        m.bindPopup(`<b>${p.name}</b><br>${p.address||''}<br><a href='${gLink}' target='_blank'>Google Maps</a> ｜ <a href='${aLink}' target='_blank'>Apple Maps</a>`);
      });
    }catch(e){}
  }
  if(_mapReady){ setTimeout(()=>{ _map.invalidateSize(); }, 60); }
}

/* ===== 聯絡表單 ===== */
function submitForm(e){ e.preventDefault(); alert('已收到您的訊息（示範）'); e.target.reset(); return false; }

/* ===== 公用 ===== */
function el(id){ return document.getElementById(id); }
function scrollH(id,dir){ const el=document.getElementById(id); if(!el) return; el.scrollBy({left: dir*(el.clientWidth*0.9), behavior:'smooth'}); }

/* ===== 初始 ===== */
function renderAll(){
  if(el('userLabel')) el('userLabel').textContent = state.user ? state.user.id : '訪客';
  renderIdentity();
  renderGuild();
  renderPets();
  renderCart();
  renderVet();
  renderWall();
}
function boot(){
  restorePage();
  loadBreeds();
  loadProducts();
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
}
window.addEventListener('hashchange', restorePage);
window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
