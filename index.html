<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PurrGo å–µä¾†é€Ÿï½œå“ç‰Œï¼‹å…¬æœƒï¼‹ç¤¾ç¾¤ Demo</title>
<link rel="manifest" href="./manifest.webmanifest">
<link rel="icon" href="./logo/favicon.png">
<meta name="theme-color" content="#ff7f50">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
<style>
:root{
  --brand:#ff7f50; --brand-ink:#000;
  --bg:#0b0b0c; --ink:#eee; --muted:#9aa0a6; --line:#222; --card:#151516;
  --radius:14px; --shadow:0 10px 24px rgba(0,0,0,.35); --shadow-strong:0 16px 40px rgba(0,0,0,.5);
  --container:min(1100px,92vw);
  --ease:cubic-bezier(.2,.8,.2,1);
}
@media (prefers-color-scheme: light){
  :root{ --bg:#fff; --ink:#111; --muted:#666; --line:#eee; --card:#fafafa }
}
*{ box-sizing:border-box }
html,body{ margin:0; padding:0 }
body{ color:var(--ink); background:var(--bg); font:16px/1.65 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC",sans-serif }
img,video{ max-width:100%; display:block; border-radius:12px }
.container{ width:var(--container); margin:auto }
.nowrap{ white-space:nowrap }
.mt-0{ margin-top:0 } .mt-1{ margin-top:8px } .mt-2{ margin-top:16px }
.inline{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
.grid{ display:grid; gap:16px } .g-2{ grid-template-columns:repeat(2,1fr) } .g-3{ grid-template-columns:repeat(3,1fr) } .gcol-2{ grid-column:1/-1 }
@media(max-width:900px){ .g-2,.g-3{ grid-template-columns:1fr } }
.pill{ display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px; color:#000; background:color-mix(in oklab,var(--brand),#fff 70%) }
.btn{ display:inline-grid; place-items:center; height:44px; padding:0 18px; border-radius:12px; font-weight:900; border:1.5px solid #000; background:var(--brand); color:var(--brand-ink); cursor:pointer; box-shadow:var(--shadow) }
.btn.secondary{ background:transparent; color:var(--ink); border-color:var(--line) }
.input,textarea,select{ width:100%; height:44px; border:1px solid var(--line); border-radius:10px; padding:10px 12px; background:transparent; color:inherit }
textarea{ height:120px; resize:vertical }
.card{ background:linear-gradient(180deg,color-mix(in oklab,var(--bg),#fff 6%),color-mix(in oklab,var(--bg),#000 3%)); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:22px; margin-bottom:16px }
.section-head{ display:flex; align-items:end; justify-content:space-between; gap:16px }
.band{ background:color-mix(in oklab,var(--bg),#000 4%); border:1px solid var(--line); padding:16px; border-radius:14px; margin-bottom:14px }

/* Header */
header{ position:sticky; top:0; z-index:1105; backdrop-filter:saturate(180%) blur(8px); background:color-mix(in oklab,var(--bg),#000 4%); border-bottom:1px solid var(--line) }
.nav{ display:flex; align-items:center; justify-content:space-between; padding:10px 0; gap:12px }
.brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.3px }
.logo{ width:28px; height:28px; border-radius:8px; background:var(--brand); display:grid; place-items:center; color:#000; font-weight:900 }
.tabs{ display:flex; gap:6px; flex-wrap:wrap }
.tab{ padding:8px 12px; border:1px solid var(--line); border-radius:999px; font-weight:700 }
.tab[aria-current="page"]{ background:var(--brand); border-color:var(--brand); color:#000 }

/* Burger */
.menu-toggle{ position:fixed; top:14px; right:14px; z-index:1201; width:48px; height:40px; border-radius:12px; border:1px solid var(--line); background:color-mix(in oklab,var(--bg),#000 8%); display:grid; place-items:center; cursor:pointer; box-shadow:var(--shadow) }
.menu-ico, .menu-ico::before, .menu-ico::after{ content:""; width:22px; height:2px; border-radius:2px; background:var(--ink); display:block; transition:.2s var(--ease) }
.menu-ico::before{ transform:translateY(-6px) } .menu-ico::after{ transform:translateY(6px) }
.menu-toggle[aria-expanded="true"] .menu-ico{ background:transparent } .menu-toggle[aria-expanded="true"] .menu-ico::before{ transform:rotate(45deg) } .menu-toggle[aria-expanded="true"] .menu-ico::after{ transform:rotate(-45deg) }

.menu-backdrop{ position:fixed; inset:0; z-index:1200; display:none; background:rgba(255,127,80,.30); backdrop-filter:blur(2px) }
.menu-backdrop.show{ display:block }
.menu{ position:fixed; right:0; top:0; height:100dvh; width:min(84vw,380px); padding:18px; display:flex; flex-direction:column; gap:14px; background:color-mix(in oklab,var(--bg),#000 6%); border-left:1px solid var(--line); box-shadow:-24px 0 60px rgba(0,0,0,.25); transform:translateX(100%); transition:transform .28s var(--ease); z-index:1202 }
.menu.open{ transform:translateX(0) }
.menu a{ display:block; padding:18px 16px; border:1px solid var(--line); border-radius:14px; font-weight:800; background:color-mix(in oklab,var(--bg),#fff 2%) }

body.menu-open{ overflow:hidden }
body.menu-open #map{ pointer-events:none }
.leaflet-control-container{ z-index:1 }

/* Hero */
.hero{ display:grid; grid-template-columns:1.15fr .85fr; gap:22px; align-items:center; margin:10px 0 28px }
@media(max-width:900px){ .hero{ grid-template-columns:1fr } }
.hero-visual{ height:280px; border-radius:20px; background:radial-gradient(60% 70% at 70% 30%, rgba(255,127,80,.2), transparent 60%), radial-gradient(40% 60% at 20% 80%, rgba(255,127,80,.12), transparent 60%); border:1px solid var(--line); display:grid; place-items:center }

/* Horizontal cards */
.hwrap{ position:relative }
.hscroll{ display:flex; overflow:auto; scroll-snap-type:x mandatory; padding:4px; gap:16px }
.hscroll>.card{ min-width:min(92vw,520px); scroll-snap-align:start }
.hbtn{ position:absolute; top:50%; transform:translateY(-50%); width:40px; height:40px; border-radius:999px; border:1px solid var(--line); background:var(--bg); color:var(--ink) }
.hbtn.prev{ left:-6px } .hbtn.next{ right:-6px }

/* FAB */
.fab{ position:fixed; right:18px; bottom:18px; z-index:1100; display:grid; gap:12px }
.fab-btn{ width:64px; height:64px; border-radius:999px; border:none; background:var(--brand); color:#000; font-weight:900; display:grid; place-items:center; box-shadow:var(--shadow); opacity:.85; transition:transform .12s ease, opacity .2s ease, box-shadow .2s ease }
.fab-btn:hover{ transform:translateY(-1px); opacity:1; box-shadow:var(--shadow-strong) }

/* Chat */
.chat{ display:grid; grid-template-columns:280px 1fr; gap:16px }
@media(max-width:900px){ .chat{ grid-template-columns:1fr } }
.chat-list{ border:1px solid var(--line); border-radius:14px; padding:12px; max-height:420px; overflow:auto }
.chat-room{ border:1px solid var(--line); border-radius:14px; padding:12px; height:420px; display:flex; flex-direction:column }
.msgs{ flex:1; overflow:auto; display:grid; gap:8px; padding-right:6px }
.msg{ max-width:70%; padding:10px 12px; border-radius:12px; background:color-mix(in oklab,var(--bg),#fff 6%); border:1px solid var(--line) }
.msg.me{ margin-left:auto; background:var(--brand); color:#000; border-color:#000 }

/* Social feed */
.feed{ display:grid; gap:16px }
.feed .post{ border:1px solid var(--line); border-radius:14px; padding:14px; background:color-mix(in oklab,var(--bg),#fff 3%) }
.post-head{ display:flex; align-items:center; justify-content:space-between; gap:10px }
.post-act{ display:flex; gap:8px }
</style>
</head>
<body>
<header>
  <div class="container nav">
    <div class="brand"><span class="logo">G</span> PurrGo å–µä¾†é€Ÿ</div>
    <nav class="tabs" aria-label="Sections">
      <a class="tab" data-sec="home">é¦–é </a>
      <a class="tab" data-sec="products">ç”¢å“</a>
      <a class="tab" data-sec="guild">å…¬æœƒ</a>
      <a class="tab" data-sec="kiosk">æ“šé»</a>
      <a class="tab" data-sec="community">ç…§ç‰‡ç‰†</a>
      <a class="tab" data-sec="social">ç¤¾ç¾¤</a>
      <a class="tab" data-sec="messages">èŠå¤©</a>
      <a class="tab" data-sec="about">ç†å¿µ</a>
      <a class="tab" data-sec="contact">è¯çµ¡</a>
    </nav>
  </div>
</header>
<button class="menu-toggle" aria-label="ä¸»é¸å–®" aria-expanded="false" onclick="openMenu()"><span class="menu-ico" aria-hidden="true"></span></button>
<nav id="menu" class="menu" aria-label="Mobile menu">
  <a href="#home" onclick="closeMenu()">é¦–é </a>
  <a href="#products" onclick="closeMenu()">ç”¢å“</a>
  <a href="#guild" onclick="closeMenu()">å…¬æœƒ</a>
  <a href="#kiosk" onclick="closeMenu()">æ“šé»</a>
  <a href="#community" onclick="closeMenu()">ç…§ç‰‡ç‰†</a>
  <a href="#social" onclick="closeMenu()">ç¤¾ç¾¤</a>
  <a href="#messages" onclick="closeMenu()">èŠå¤©</a>
  <a href="#about" onclick="closeMenu()">ç†å¿µ</a>
  <a href="#contact" onclick="closeMenu()">è¯çµ¡</a>
</nav>
<div id="menuBackdrop" class="menu-backdrop" onclick="closeMenu()" aria-hidden="true"></div>

<main class="container">
  <!-- Hero -->
  <section id="home" class="hero card">
    <div>
      <span class="pill">PurrGo å–µä¾†é€Ÿ</span>
      <h1 class="mt-0">ä¾¿åˆ© Ã— å¯æ„› Ã— æ°¸çºŒ Ã— å…±å‰µ</h1>
      <p class="muted">ç”¨å‰µæ–°é…é€ï¼‹å…¬æœƒåˆ¶åº¦ï¼Œè®“è£œçµ¦æ›´è°æ˜ã€æ›´ä¾¿å®œã€æ›´å¥½ç©ã€‚æŠŠã€Œè²·è²“ç ‚ã€è®Šæˆæœ‰æˆå°±æ„Ÿçš„é‡Œç¨‹ç¢‘éŠæˆ²ã€‚</p>
      <div class="inline mt-1">
        <a class="btn" href="#products">é–‹å§‹æ¢ç´¢ç”¢å“</a>
        <a class="btn secondary" href="#guild">åŠ å…¥è²“å¥´å…¬æœƒ</a>
        <a class="btn secondary" href="#cats">å»ºç«‹ä¸»å­è§’è‰²</a>
      </div>
    </div>
    <div class="hero-visual">
      <img src="./logo/logo-512.png" alt="PurrGo logo" style="width:120px;height:120px;object-fit:contain">
    </div>
  </section>

  <!-- æˆ‘çš„ä¸»å­ -->
  <section id="cats" class="card">
    <span class="pill">Cats</span>
    <h2 class="mt-0">æˆ‘çš„ä¸»å­</h2>
    <form class="grid g-2" onsubmit="return addCat(event)">
      <div><label>å§“å<input class="input" name="name" required></label></div>
      <div><label>æ€§åˆ¥<select class="input" name="sex"><option>æ¯</option><option>å…¬</option></select></label></div>
      <div><label>å¹´é½¡ï¼ˆæ­²ï¼‰<input class="input" type="number" name="age" min="0" value="2"></label></div>
      <div><label>å“ç¨®<select class="input" name="breed" id="breedSelect"></select></label></div>
      <div class="gcol-2 inline">
        <button class="btn" type="submit">æ–°å¢ä¸»å­</button>
        <span class="muted">å¯æ–°å¢å¤šéš»ï¼Œå°‡å½±éŸ¿å¥æª¢/ç…§ç‰‡ç‰†/è²¼æ–‡çš„ç¯©é¸ã€‚</span>
      </div>
    </form>
    <div id="catChips" class="inline mt-1"></div>
  </section>

  <!-- Products -->
  <section id="products" class="page">
    <section class="band">
      <header class="section-head"><div><span class="pill">Products</span><h2 class="nowrap mt-0">ç†±éŠ·èˆ‡æ–¹æ¡ˆ</h2><p class="muted">æ©«å‘æ»‘å‹•å¡ç‰‡ï¼Œæ”¯æ´ç”¢å“ç…§ç‰‡ã€è©³æƒ…å½ˆçª—èˆ‡åŠ å…¥è³¼ç‰©è»Šã€‚</p></div></header>
    </section>
    <div class="hwrap">
      <button class="hbtn prev" onclick="scrollRow('productRow',-1)">â€¹</button>
      <div id="productRow" class="hscroll"></div>
      <button class="hbtn next" onclick="scrollRow('productRow',1)">â€º</button>
    </div>

    <section class="card">
      <h3 class="mt-0">è³¼ç‰©è»Šï¼ˆç¤ºç¯„ï¼‰</h3>
      <div id="cartItems" class="muted">å°šç„¡å•†å“</div>
      <div class="inline mt-1"><button class="btn" onclick="checkout()">çµå¸³ï¼ˆç¤ºç¯„ï¼‰</button><button class="btn secondary" onclick="clearCart()">æ¸…ç©º</button></div>
    </section>
  </section>

  <!-- Guild -->
  <section id="guild" class="page">
    <section class="band"><header class="section-head"><div><span class="pill">Guild</span><h2 class="mt-0">å…¬æœƒåˆ¶åº¦ï¼šä¸€èµ·æˆé•·ï¼Œä¸€èµ·æ›´çœ</h2><p class="muted">å‰µç«‹é–€æª»ã€VIP ç­‰ç´šã€è²¢ç»æ¢ã€æ¯æ—¥ä»»å‹™ï¼ˆç¤ºç¯„ï¼‰ã€‚</p></div></header></section>

    <div class="grid g-2">
      <div class="card">
        <h3 class="mt-0">å‰µç«‹é–€æª»</h3>
        <div class="muted">æœƒé•·è³‡æ ¼ï¼šç´¯ç©æ¶ˆè²» â‰¥ <b>$1,200</b></div>
        <div class="inline mt-1"><input class="input" placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼" oninput="bindPhone(this.value)"><button class="btn" onclick="toggleLine()">ç¶å®š LINEï¼ˆç¤ºæ„ï¼‰</button></div>
        <div id="identityInfo" class="mt-1 muted">å°šæœªç¶å®šæ‰‹æ©Ÿ</div>
        <div class="inline mt-1"><button class="btn" onclick="createGuild()">å‰µç«‹å…¬æœƒ</button><button class="btn secondary" onclick="contribute(50)">è²¢ç» +50</button><button class="btn secondary" onclick="mockWar()">å€åŸŸæˆ°ï¼ˆç¤ºæ„ï¼‰</button></div>
        <div class="mt-1">å…¬æœƒï¼š<b id="guildName">ï¼ˆå°šæœªå‰µç«‹ï¼‰</b> ï½œ ç­‰ç´šï¼š<b id="guildLevel">â€“</b> ï½œ è²¢ç»ï¼š<b id="guildContrib">0</b></div>
      </div>
      <div class="card">
        <h3 class="mt-0">æœƒå“¡ï¼†ç°½åˆ°</h3>
        <div class="muted">çµ‚èº«æ¶ˆè²»ï¼š<span id="lifetimeSpend">$0</span> ï½œ ä½ çš„ VIPï¼š<b id="vipLevel">V0</b> ï½œ ä¸‹ä¸€ç´šé‚„éœ€ï¼š<b id="vipNext">$200</b></div>
        <button class="btn mt-1" onclick="dailyCheckin()">æ¯æ—¥ç°½åˆ°ï¼ˆ+èƒ½é‡/+VIPï¼‰</button>
        <div id="checkinInfo" class="muted mt-1"></div>
      </div>
    </div>
  </section>

  <!-- Vet reports per cat -->
  <section id="vet-cats" class="card">
    <span class="pill">Vet</span>
    <h2 class="mt-0">å¥æª¢å ±å‘Šä¸Šå‚³ï¼ˆéœ€åŠ å…¥å…¬æœƒï¼‰</h2>
    <div class="hscroll" id="vetCards" style="display:flex; overflow:auto;"></div>
    <div class="muted mt-1">ï¼Šæ¯éš»ä¸»å­æ¯å¹´ 1 æ¬¡å…è²»å¥æª¢ï¼ˆç¤ºç¯„ï¼‰ã€‚å®Œæˆä¸Šå‚³å¯ç²å…¬æœƒè²¢ç»ã€‚</div>
  </section>

  <!-- Kiosk map -->
  <section id="kiosk" class="card">
    <span class="pill">Kiosk</span>
    <h2 class="mt-0">è²©è³£æ©Ÿé»ä½</h2>
    <div id="map" style="height:360px;border-radius:12px;overflow:hidden"></div>
    <div class="muted mt-1">é»æ“Šæ¨™è¨˜å¯é–‹å•Ÿ Google/Apple Maps å°èˆªã€‚</div>
  </section>

  <!-- Community / Photo wall -->
  <section id="community" class="card">
    <span class="pill">Community</span>
    <h2 class="mt-0">ç…§ç‰‡ç‰†</h2>
    <div class="inline" id="photoCatTabs"></div>
    <div class="inline mt-1"><input id="photoFile" type="file" accept="image/*"><button class="btn secondary" onclick="uploadPhoto()">ä¸Šå‚³ç…§ç‰‡</button></div>
    <div id="wall" class="grid g-3 mt-2"></div>
  </section>

  <!-- Social (feed + short video) -->
  <section id="social" class="page">
    <section class="band"><header class="section-head"><div><span class="pill">Social</span><h2 class="mt-0">ç¤¾ç¾¤ï¼šè²¼æ–‡ / çŸ­å½±ç‰‡</h2><p class="muted">30 ç§’å…§çŸ­å½±ç‰‡ã€ç…§ç‰‡è²¼æ–‡ã€æŒ‰è®šï¼ç•™è¨€ï¼åˆ†äº«ï¼ˆç¤ºç¯„ï¼Œå„²å­˜åœ¨æœ¬æ©Ÿï¼‰ã€‚</p></div></header></section>

    <div class="card">
      <h3 class="mt-0">ç™¼ä½ˆè²¼æ–‡</h3>
      <div class="grid g-2">
        <div><label>å…§å®¹<input id="postText" class="input" placeholder="æƒ³èªªä»€éº¼â€¦"></label></div>
        <div><label>æŒ‡æ´¾ä¸»å­<select id="postCat" class="input"></select></label></div>
        <div><label>ç…§ç‰‡<input id="postPhoto" type="file" accept="image/*" class="input"></label></div>
        <div><label>çŸ­å½±ç‰‡ï¼ˆâ‰¤30sï¼‰<input id="postVideo" type="file" accept="video/*" class="input"></label></div>
      </div>
      <div class="inline mt-1"><button class="btn" onclick="publishPost()">ç™¼ä½ˆ</button></div>
    </div>

    <div id="feed" class="feed"></div>
  </section>

  <!-- Messages (chat) -->
  <section id="messages" class="page">
    <section class="band"><header class="section-head"><div><span class="pill">Chat</span><h2 class="mt-0">èŠå¤©ï¼ˆå¥½å‹ï¼å°é–ï¼ç§è¨Šï¼‰</h2><p class="muted">ç¤ºç¯„ç‰ˆä½¿ç”¨æœ¬æ©Ÿè³‡æ–™ï¼›ä¸Šç·šæœƒä¸²æ¥é›²ç«¯ï¼ˆå»ºè­° Supabase/Firebaseï¼‰ã€‚</p></div></header></section>

    <div class="chat">
      <div>
        <div class="chat-list">
          <div class="inline"><input id="friendName" class="input" placeholder="è¼¸å…¥å¥½å‹åç¨±"><button class="btn" onclick="addFriend()">æ–°å¢å¥½å‹</button></div>
          <div id="friends" class="mt-1"></div>
        </div>
      </div>
      <div class="chat-room">
        <div class="inline"><h3 id="roomTitle" class="mt-0">æœªé¸æ“‡å°è©±</h3><span id="roomStatus" class="pill" style="display:none"></span></div>
        <div id="msgs" class="msgs"></div>
        <div class="inline mt-1"><input id="msgInput" class="input" placeholder="è¼¸å…¥è¨Šæ¯â€¦" onkeydown="if(event.key==='Enter')sendMsg()"><button class="btn" onclick="sendMsg()">é€å‡º</button></div>
      </div>
    </div>
  </section>

  <!-- About / Contact ç°¡ç‰ˆ -->
  <section id="about" class="card">
    <span class="pill">About</span>
    <h2 class="mt-0">å“ç‰Œç†å¿µ</h2>
    <p class="muted">ä¾¿åˆ©ã€å¯æ„›ã€æ°¸çºŒã€å…±å‰µã€‚ç”¨æ›´è°æ˜çš„è£œçµ¦é«”é©—ï¼ŒæŠŠæ—¥å¸¸æ¶ˆè€—å“è®Šæˆåƒèˆ‡å¼é‡Œç¨‹ç¢‘ã€‚</p>
  </section>
  <section id="contact" class="card">
    <span class="pill">Contact</span>
    <h2 class="mt-0">è¯çµ¡æˆ‘å€‘</h2>
    <form class="grid g-2" onsubmit="alert('å·²æ”¶åˆ°ï¼ˆç¤ºç¯„ï¼‰'); this.reset(); return false;">
      <div><label>æ‚¨çš„ç¨±å‘¼<input class="input" required></label></div>
      <div><label>Email<input type="email" class="input" required></label></div>
      <div class="gcol-2"><label>è¨Šæ¯<textarea class="input" required></textarea></label></div>
      <div class="inline"><button class="btn" type="submit">é€å‡º</button></div>
    </form>
  </section>

  <footer class="container" style="padding:26px 0 80px;color:var(--muted)">Â© PurrGo å–µä¾†é€Ÿ ï½œ å…¬é–‹ Demo</footer>
</main>

<!-- FAB -->
<div class="fab" id="fab" aria-label="å¿«é€Ÿå°è¦½">
  <button class="fab-btn" title="Top" onclick="scrollToHash('home')">Top</button>
  <button class="fab-btn" title="Shop" onclick="scrollToHash('products')">Shop</button>
  <button class="fab-btn" title="Guild" onclick="scrollToHash('guild')">Guild</button>
  <button class="fab-btn" title="Map" onclick="scrollToHash('kiosk')">Map</button>
  <button class="fab-btn" title="Msg" onclick="scrollToHash('messages')">Msg</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
<script>
// ===== State =====
const LS_KEY = 'purrgoStateV2';
const state = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
state.user ||= { phone:'', line:false, vipXp:0, lifetimeSpend:0, energy:0, lastCheckin:'' };
state.guild ||= { name:'', level:0, contribution:0 };
state.cart ||= []; state.vet ||= []; state.cats ||= []; state.breeds ||= [];
state.vetReports ||= {}; state.photos ||= {}; state.social ||= { posts:[] };
state.friends ||= { list:[], block:[], current:null }; state.chats ||= {};
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); renderIdentity(); renderVIP(); renderGuild(); renderCart(); renderCats(); renderFriends(); renderChat(); }

// ===== Nav highlight =====
function highlight(){ const hash=(location.hash||'#home').replace('#',''); document.querySelectorAll('[data-sec]').forEach(a=> a.setAttribute('aria-current', a.dataset.sec===hash? 'page': 'false')); }
window.addEventListener('hashchange', highlight); window.addEventListener('DOMContentLoaded', highlight);
function scrollToHash(id){ const el=document.getElementById(id); if(!el) return; el.scrollIntoView({behavior:'smooth', block:'start'}); setTimeout(highlight,300); }

// ===== Burger =====
function openMenu(){ document.getElementById('menu').classList.add('open'); document.getElementById('menuBackdrop').classList.add('show'); document.body.classList.add('menu-open'); document.querySelector('.menu-toggle')?.setAttribute('aria-expanded','true'); }
function closeMenu(){ document.getElementById('menu').classList.remove('open'); document.getElementById('menuBackdrop').classList.remove('show'); document.body.classList.remove('menu-open'); document.querySelector('.menu-toggle')?.setAttribute('aria-expanded','false'); }

// ===== Identity / VIP =====
function bindPhone(v){ state.user.phone=v||''; save(); }
function toggleLine(){ state.user.line=!state.user.line; save(); }
function renderIdentity(){ const t=document.getElementById('identityInfo'); if(!t) return; t.textContent = state.user.phone? `å·²ç¶å®šï¼š${state.user.phone} ï½œ LINEï¼š${state.user.line?'å·²é€£çµ':'æœªé€£çµ'}` : 'å°šæœªç¶å®šæ‰‹æ©Ÿ'; }
function vipLevelByXp(x){ if(x>=5000) return 5; if(x>=3000) return 4; if(x>=1500) return 3; if(x>=600) return 2; if(x>=200) return 1; return 0 }
function nextVipNeed(x){ const br=[200,600,1500,3000,5000]; for(const b of br){ if(x<b) return b-x } return 0 }
function renderVIP(){ const xp=state.user.vipXp|0; const s=(state.user.lifetimeSpend||0); const lv=vipLevelByXp(xp); const need=nextVipNeed(xp);
  document.getElementById('lifetimeSpend')?.replaceChildren(`$${s.toLocaleString()}`);
  document.getElementById('vipLevel')?.replaceChildren('V'+lv); document.getElementById('vipNext')?.replaceChildren(need?('$'+need):'å·²é”é ‚ç´š'); }
function dailyCheckin(){ const today=new Date().toISOString().slice(0,10); if(state.user.lastCheckin===today){ document.getElementById('checkinInfo').textContent='ä»Šå¤©å·²ç°½åˆ°'; return; } state.user.lastCheckin=today; state.user.energy+=10; state.user.vipXp+=10; document.getElementById('checkinInfo').textContent='ç°½åˆ°æˆåŠŸï¼š+10 èƒ½é‡ã€+10 VIP XP'; save(); }

// ===== Products / Cart =====
const FALLBACK_PRODUCTS=[
  {id:'p1', name:'å¹¼è²“å°ˆç”¨è±†è…ç ‚', spec:'2.5kg / ä½ç²‰å¡µ', price:220, bullets:['ä½ç²‰å¡µ','å¿«é€Ÿçµåœ˜'], img:'./img/tofu-young.jpg'},
  {id:'p2', name:'æˆè²“æ—¥å¸¸è±†è…ç ‚', spec:'2.5kg / å¼·æ•ˆé™¤è‡­', price:200, bullets:['é«˜å‡çµ','é™¤è‡­å‡ç´š'], img:'./img/tofu-adult.jpg'},
  {id:'p3', name:'ç†Ÿé½¡ç…§è­·è±†è…ç ‚', spec:'2.5kg / æº«å’Œ', price:210, bullets:['æ•æ„Ÿå‹å–„','æ˜“æ¸…ç†'], img:'./img/tofu-senior.jpg'}
];
async function loadProducts(){ try{ const r=await fetch('./data/products.json',{cache:'no-cache'}); const list=await r.json(); buildProducts(list); }catch{ buildProducts(FALLBACK_PRODUCTS) } }
function buildProducts(list){ const row=document.getElementById('productRow'); row.innerHTML=''; list.forEach(p=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML = `
  <div class="grid g-2">
    <div><img src="${p.img||'./img/000'}" alt="${p.name}"></div>
    <div>
      <h3 class="mt-0">${p.name}</h3>
      <div class="muted">${p.spec}</div>
      <div class="mt-1"><b>NT$ ${p.price.toLocaleString()}</b></div>
      <ul class="list">${(p.bullets||[]).map(b=>`<li>${b}</li>`).join('')}</ul>
      <div class="inline mt-1"><button class="btn" onclick='addToCart(${JSON.stringify(p).replace(/'/g,"&#39;")})'>åŠ å…¥è³¼ç‰©è»Š</button><button class="btn secondary" onclick='showDetail(${JSON.stringify(p).replace(/'/g,"&#39;")})'>æŸ¥çœ‹è©³æƒ…</button></div>
    </div>
  </div>`; row.appendChild(el); }); }
function addToCart(p){ const item = state.cart.find(i=>i.id===p.id) || (state.cart.push({...p,qty:0}), state.cart.find(i=>i.id===p.id)); item.qty++; save(); }
function clearCart(){ state.cart=[]; save(); }
function renderCart(){ const box=document.getElementById('cartItems'); if(!box) return; if(!state.cart.length){ box.textContent='å°šç„¡å•†å“'; return } let sum=0; box.innerHTML=state.cart.map(i=>{ sum+=i.price*i.qty; return `${i.name} Ã— ${i.qty} = NT$ ${(i.price*i.qty).toLocaleString()}` }).join('<br>'); box.innerHTML += `<div class="mt-1"><b>å°è¨ˆï¼šNT$ ${sum.toLocaleString()}</b></div>`; }
function checkout(){ if(!state.cart.length) return alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„'); const sum=state.cart.reduce((a,b)=>a+b.price*b.qty,0); state.user.lifetimeSpend=(state.user.lifetimeSpend||0)+sum; state.user.vipXp+=Math.round(sum/10); state.user.energy += Math.round(sum/20); state.cart=[]; save(); alert(`çµå¸³æˆåŠŸï¼ç´¯ç©æ¶ˆè²» +$${sum.toLocaleString()}ï¼ŒVIP XP èˆ‡èƒ½é‡å·²å¢åŠ `); }
function showDetail(p){ alert(`ã€${p.name}ã€‘\n${p.spec}\nå”®åƒ¹ NT$ ${p.price}`) }
function scrollRow(id,dir){ const el=document.getElementById(id); el.scrollBy({left: dir* (el.clientWidth*0.9), behavior:'smooth'}) }

// ===== Guild =====
const GUILD_CREATE_NEED=1200;
function renderGuild(){ document.getElementById('guildName')?.replaceChildren(state.guild.name||'ï¼ˆå°šæœªå‰µç«‹ï¼‰'); document.getElementById('guildLevel')?.replaceChildren(state.guild.level||'â€“'); document.getElementById('guildContrib')?.replaceChildren(state.guild.contribution|0); }
function createGuild(){ if((state.user.lifetimeSpend||0) < GUILD_CREATE_NEED){ return alert('å°šæœªé”åˆ°å‰µç«‹é–€æª»ï¼šç´¯ç©æ¶ˆè²» $1,200'); } const name=prompt('è¼¸å…¥å…¬æœƒåç¨±'); if(!name) return; state.guild.name=name; state.guild.level=1; save(); alert('å…¬æœƒå·²å‰µç«‹ï¼'); }
function contribute(n){ if(!state.guild.name) return alert('è«‹å…ˆå‰µç«‹/åŠ å…¥å…¬æœƒ'); state.guild.contribution += n; if(state.guild.contribution >= (state.guild.level*500)){ state.guild.level++; alert('å…¬æœƒå‡ç´šï¼'); } save(); }
function mockWar(){ if(!state.guild.name) return alert('å…ˆå‰µç«‹å…¬æœƒ'); alert('å€åŸŸæˆ°ç©åˆ† + éš¨æ©Ÿç¤ºæ„ï¼ˆUI ç•¥ï¼‰'); }

// ===== Cats =====
async function initBreeds(){ try{ const r=await fetch('./data/breeds.json',{cache:'no-cache'}); state.breeds = await r.json(); }catch{ state.breeds=['å®¶è²“','ç±³å…‹æ–¯','è‹±çŸ­','è³“å£«','å¸ƒå¶'] } const sel=document.getElementById('breedSelect'); if(sel) sel.innerHTML = state.breeds.map(b=>`<option>${b}</option>`).join(''); renderCats(); }
function addCat(e){ e.preventDefault(); const f=e.target; const cat={ id:'cat_'+Date.now(), name:f.name.value.trim(), sex:f.sex.value, age:+f.age.value||0, breed:f.breed.value||'å®¶è²“' }; if(!cat.name) return false; state.cats.push(cat); save(); f.reset(); return false }
function removeCat(id){ state.cats = state.cats.filter(c=>c.id!==id); save(); }
function renderCats(){ const chips=document.getElementById('catChips'); if(chips){ chips.innerHTML = state.cats.map(c=>`<span class="pill" style="display:inline-flex;align-items:center;gap:6px">${c.name}ï¼ˆ${c.sex}/${c.age}ï¼‰<button class="btn secondary" style="height:28px;padding:0 8px" onclick="removeCat('${c.id}')">ç§»é™¤</button></span>`).join('') || '<div class="muted">ç›®å‰å°šæœªæ–°å¢ä¸»å­</div>'; }
  // vet cards
  const wrap=document.getElementById('vetCards'); if(wrap){ wrap.innerHTML = state.cats.map(c=>`<div class="card" style="min-width:280px"><h3 class="mt-0">${c.name}ï¼ˆ${c.sex}/${c.age}ï¼‰</h3><div class="muted">å“ç¨®ï¼š${c.breed}</div><div class="inline mt-1"><input id="file-${c.id}" type="file" accept="application/pdf,image/*"><button class="btn" onclick="uploadReport('${c.id}')">ä¸Šå‚³å ±å‘Š</button></div><div class="mt-1" style="font-size:14px">${(state.vetReports[c.id]||[]).map(r=>`<div>ğŸ“„ ${r.fileName} ï½œ ${r.date}</div>`).join('')||'å°šç„¡ä¸Šå‚³'}</div></div>`).join(''); }
  // photo tabs
  const tabs=document.getElementById('photoCatTabs'); if(tabs){ tabs.innerHTML = state.cats.map((c,i)=>`<button class="btn ${state._photoCat===c.id?'' :'secondary'}" onclick="setPhotoCat('${c.id}')">${c.name}</button>`).join('') || '<div class="muted">è«‹å…ˆæ–°å¢ä¸»å­</div>'; if(state.cats.length && !state._photoCat) state._photoCat=state.cats[0].id; renderWall(); }
  // post cat selector
  const postCat=document.getElementById('postCat'); if(postCat){ postCat.innerHTML = '<option value="">â€” ä¸æŒ‡å®š â€”</option>'+ state.cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join(''); }
}
function uploadReport(catId){ if(!state.guild?.name) return alert('è«‹å…ˆåŠ å…¥/å‰µç«‹å…¬æœƒå†ä¸Šå‚³'); const inp=document.getElementById('file-'+catId); const file=inp?.files?.[0]; if(!file) return alert('è«‹é¸æ“‡æª”æ¡ˆ'); const rd=new FileReader(); rd.onload=()=>{ const rec={ date:new Date().toLocaleString(), fileName:file.name, dataUrl:rd.result }; state.vetReports[catId] ||= []; state.vetReports[catId].push(rec); state.guild.contribution=(state.guild.contribution||0)+50; save(); alert('ä¸Šå‚³æˆåŠŸï¼å·²ç²å¾—å…¬æœƒè²¢ç» +50ï¼ˆç¤ºç¯„ï¼‰'); }; rd.readAsDataURL(file); }

// ===== Photos =====
function setPhotoCat(id){ state._photoCat=id; save(); }
function uploadPhoto(){ const id=state._photoCat; if(!id) return alert('è«‹å…ˆæ–°å¢ä¸»å­'); const file=document.getElementById('photoFile').files[0]; if(!file) return; const rd=new FileReader(); rd.onload=()=>{ state.photos[id] ||= []; state.photos[id].push({ src:rd.result, likes:0, comments:[] }); save(); }; rd.readAsDataURL(file); }
function likePhoto(id,idx){ state.photos[id][idx].likes++; save(); }
function commentPhoto(id,idx){ const msg=prompt('ç•™è¨€å…§å®¹'); if(!msg) return; state.photos[id][idx].comments.push({ at:Date.now(), text:msg }); save(); }
function renderWall(){ const id=state._photoCat; const box=document.getElementById('wall'); if(!box) return; const list=(state.photos[id]||[]); if(!id||!list.length){ box.innerHTML='<div class="empty">å°šç„¡ç…§ç‰‡</div>'; return } box.innerHTML = list.map((p,i)=>`<div class="card" style="display:flex;flex-direction:column;gap:8px"><img src="${p.src}"><div class="inline"><button class="btn" onclick="likePhoto('${id}',${i})">â™¥ ${p.likes}</button><button class="btn secondary" onclick="commentPhoto('${id}',${i})">ç•™è¨€</button></div><div class="muted" style="font-size:14px">${(p.comments||[]).map(c=>`<div>ğŸ’¬ ${new Date(c.at).toLocaleString()}ï¼š${c.text}</div>`).join('')}</div></div>`).join(''); }

// ===== Social: posts (photo/video <= 30s) =====
function publishPost(){ const text=document.getElementById('postText').value.trim(); const cat=document.getElementById('postCat').value||null; const photo=document.getElementById('postPhoto').files[0]; const video=document.getElementById('postVideo').files[0];
  const submit=(media)=>{ state.social.posts.unshift({ id:'post_'+Date.now(), text, cat, media, ts:Date.now(), likes:0, comments:[], shares:0 }); document.getElementById('postText').value=''; document.getElementById('postPhoto').value=''; document.getElementById('postVideo').value=''; save(); renderFeed(); };
  if(video){ const v=document.createElement('video'); v.preload='metadata'; v.onloadedmetadata=()=>{ if(v.duration>30){ alert('å½±ç‰‡è¶…é 30 ç§’'); return } const rd=new FileReader(); rd.onload=()=> submit({ type:'video', src:rd.result }); rd.readAsDataURL(video); }; v.src=URL.createObjectURL(video); return }
  if(photo){ const rd=new FileReader(); rd.onload=()=> submit({ type:'photo', src:rd.result }); rd.readAsDataURL(photo); return }
  if(text){ submit(null); } else { alert('è«‹è‡³å°‘è¼¸å…¥æ–‡å­—æˆ–ä¸Šå‚³ç…§ç‰‡/å½±ç‰‡'); }
}
function likePost(id){ const p=state.social.posts.find(x=>x.id===id); p.likes++; save(); renderFeed(); }
function sharePost(id){ const p=state.social.posts.find(x=>x.id===id); p.shares++; save(); alert('å·²åˆ†äº«ï¼ˆç¤ºç¯„ï¼‰'); renderFeed(); }
function commentPost(id){ const msg=prompt('ç•™è¨€å…§å®¹'); if(!msg) return; const p=state.social.posts.find(x=>x.id===id); p.comments.push({ at:Date.now(), text:msg }); save(); renderFeed(); }
function renderFeed(){ const box=document.getElementById('feed'); if(!box) return; if(!state.social.posts.length){ box.innerHTML='<div class="empty">å°šç„¡è²¼æ–‡</div>'; return } box.innerHTML = state.social.posts.map(p=>`<article class="post"><div class="post-head"><div>ğŸ¾ ${p.cat? (state.cats.find(c=>c.id===p.cat)?.name+'ï¼'):''}${new Date(p.ts).toLocaleString()}</div><div class="post-act"><button class="btn secondary" onclick="likePost('${p.id}')">â™¥ ${p.likes}</button><button class="btn secondary" onclick="commentPost('${p.id}')">ç•™è¨€</button><button class="btn secondary" onclick="sharePost('${p.id}')">åˆ†äº« ${p.shares}</button></div></div><div class="mt-1">${p.text||''}</div>${p.media? (p.media.type==='photo'? `<img class="mt-1" src="${p.media.src}">` : `<video class="mt-1" controls src="${p.media.src}"></video>`):''}<div style="font-size:14px" class="muted mt-1">${(p.comments||[]).map(c=>`<div>ğŸ’¬ ${new Date(c.at).toLocaleString()}ï¼š${c.text}</div>`).join('')}</div></article>`).join(''); }

// ===== Chat (local mock) =====
function addFriend(){ const name=document.getElementById('friendName').value.trim(); if(!name) return; const id='f_'+Date.now(); state.friends.list.push({ id, name, online: Math.random()>.5 }); state.chats[id]=[]; state.friends.current=id; save(); document.getElementById('friendName').value=''; }
function renderFriends(){ const box=document.getElementById('friends'); if(!box) return; if(!state.friends.list.length){ box.innerHTML='<div class="muted">å°šç„¡å¥½å‹</div>'; return } box.innerHTML = state.friends.list.map(f=>`<div class="card" style="margin:8px 0"><div class="inline"><b>${f.name}</b>${f.online?'<span class="pill">online</span>':'<span class="pill" style="background:#bbb">away</span>'}</div><div class="inline mt-1"><button class="btn ${state.friends.current===f.id?'':'secondary'}" onclick="openRoom('${f.id}')">èŠå¤©</button><button class="btn secondary" onclick="blockFriend('${f.id}')">å°é–</button></div></div>`).join(''); }
function blockFriend(id){ if(!confirm('ç¢ºå®šå°é–ï¼Ÿ')) return; state.friends.block.push(id); state.friends.list = state.friends.list.filter(f=>f.id!==id); if(state.friends.current===id) state.friends.current=null; save(); }
function openRoom(id){ state.friends.current=id; save(); }
function renderChat(){ const id=state.friends.current; const title=document.getElementById('roomTitle'); const status=document.getElementById('roomStatus'); const msgs=document.getElementById('msgs'); if(!title||!msgs) return; if(!id){ title.textContent='æœªé¸æ“‡å°è©±'; status.style.display='none'; msgs.innerHTML=''; return } const f = state.friends.list.find(x=>x.id===id) || {name:'ï¼ˆå·²å°é–/ä¸å­˜åœ¨ï¼‰', online:false}; title.textContent=f.name; status.style.display='inline-block'; status.textContent=f.online?'online':'away'; msgs.innerHTML = (state.chats[id]||[]).map(m=>`<div class="msg ${m.me?'me':''}">${m.text}</div>`).join(''); msgs.scrollTop=msgs.scrollHeight; }
function sendMsg(){ const id=state.friends.current; if(!id) return; const inp=document.getElementById('msgInput'); const text=inp.value.trim(); if(!text) return; state.chats[id] ||= []; state.chats[id].push({ me:true, text, ts:Date.now() }); inp.value=''; save(); // auto reply demo
  setTimeout(()=>{ state.chats[id].push({ me:false, text:'å·²æ”¶åˆ°ï¼š'+(text.length>16? text.slice(0,16)+'â€¦':text), ts:Date.now() }); save(); }, 600); }

// ===== Map =====
const FALLBACK_LOCATIONS=[ {name:'å°åŒ—ä¿¡ç¾©æ“šé»', lat:25.033, lng:121.5654, address:'å°åŒ—å¸‚ä¿¡ç¾©å€'},{name:'å°ä¸­è¥¿å±¯æ“šé»', lat:24.164, lng:120.639, address:'å°ä¸­å¸‚è¥¿å±¯å€'},{name:'é«˜é›„å·¦ç‡Ÿæ“šé»', lat:22.658, lng:120.306, address:'é«˜é›„å¸‚å·¦ç‡Ÿå€'} ];
async function initMap(){ const map=L.map('map').setView([25.033,121.5654],11); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(map); let points=FALLBACK_LOCATIONS; try{ const r=await fetch('./data/locations.json',{cache:'no-cache'}); points=await r.json(); }catch{} points.forEach(p=>{ const m=L.marker([p.lat,p.lng]).addTo(map); const g=`https://www.google.com/maps?q=${p.lat},${p.lng}`; const a=`https://maps.apple.com/?q=${p.lat},${p.lng}`; m.bindPopup(`<b>${p.name}</b><br>${p.address||''}<br><a target="_blank" href='${g}'>Google Maps</a> ï½œ <a target="_blank" href='${a}'>Apple Maps</a>`); }); }

// ===== Boot =====
window.addEventListener('DOMContentLoaded',()=>{ loadProducts(); initBreeds(); initMap(); renderFeed(); if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); } });
</script>
</body>
</html>
